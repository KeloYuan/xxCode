/**
 * xxCode ä¸»ç¼–è¾‘å™¨é¡µé¢
 * å®Œæ•´åŠŸèƒ½çš„ä»£ç ç¼–è¾‘å™¨ï¼Œæ”¯æŒå¤šæ ‡ç­¾ã€è¯­æ³•é«˜äº®ã€ä¸»é¢˜åˆ‡æ¢ç­‰
 */
import { router } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { common } from '@kit.AbilityKit';
import { RealFileService } from '../services/RealFileService';
import { ThemeService, Theme } from '../services/ThemeService';
import { MarkdownService } from '../services/MarkdownService';
import { FileItem, EditorTab } from '../models/FileModel';
import { HighlightedText } from '../components/HighlightedText';
import { FileTreeItem } from '../components/FileTreeItem';
import { WelcomeGuide } from '../components/WelcomeGuide';
import { SearchDialog } from '../components/SearchDialog';
import { BreakpointService, Breakpoint } from '../services/BreakpointService';

@Entry
@Component
struct CodeEditor {
  @State tabs: EditorTab[] = [];
  @State activeTab: EditorTab | null = null;
  @State isFileTreeVisible: boolean = true;
  @State fileTree: FileItem[] = [];
  @State expandedFolders: Set<string> = new Set();
  @State isPreviewMode: boolean = false;
  @State showWelcomeGuide: boolean = false;
  @State showSearchDialog: boolean = false;
  @State currentTheme: Theme = ThemeService.getInstance().getCurrentTheme();
  @State currentBreakpoint: Breakpoint = 'sm';
  
  private context: common.UIAbilityContext | null = null;
  private fileService: RealFileService = new RealFileService();
  private themeService: ThemeService = ThemeService.getInstance();
  private markdownService: MarkdownService = MarkdownService.getInstance();
  private breakpointService: BreakpointService = BreakpointService.getInstance();
  
  private searchDialogController: CustomDialogController = new CustomDialogController({
    builder: SearchDialog({
      content: this.activeTab?.content || '',
      onClose: () => {
        this.showSearchDialog = false;
      }
    }),
    autoCancel: true
  });

  aboutToAppear() {
    this.context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    this.fileService.setContext(this.context);
    
    // æ³¨å†Œæ–­ç‚¹ç³»ç»Ÿ
    this.breakpointService.register();
    this.currentBreakpoint = this.breakpointService.getCurrentBreakpoint();
    this.breakpointService.onChange((breakpoint: Breakpoint) => {
      this.currentBreakpoint = breakpoint;
      if (this.breakpointService.isPhone()) {
        this.isFileTreeVisible = false;
      }
    });
    
    // æ‰‹æœºé»˜è®¤éšè—æ–‡ä»¶æ ‘
    if (this.breakpointService.isPhone()) {
      this.isFileTreeVisible = false;
    }
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    this.themeService.onThemeChange((theme: Theme) => {
      this.currentTheme = theme;
    });
    
    // æ£€æŸ¥é¦–æ¬¡å¯åŠ¨
    this.checkFirstLaunch();
    
    // åˆ›å»ºæ¬¢è¿æ ‡ç­¾
    this.createWelcomeTab();
  }

  aboutToDisappear() {
    this.breakpointService.unregister();
  }

  private checkFirstLaunch() {
    const hasLaunched = AppStorage.get<boolean>('hasLaunched');
    if (!hasLaunched) {
      setTimeout(() => {
        this.showWelcomeGuide = true;
      }, 500);
      AppStorage.setOrCreate('hasLaunched', true);
    }
  }

  private createWelcomeTab() {
    const welcomeTab = this.fileService.createNewTab(
      'Welcome.md',
      '',
      `# æ¬¢è¿ä½¿ç”¨ xxCode ç¼–è¾‘å™¨

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ‰“å¼€æ–‡ä»¶
ç‚¹å‡»å³ä¸Šè§’çš„"æ‰“å¼€"æŒ‰é’®ï¼Œé€‰æ‹©æ‚¨æƒ³è¦ç¼–è¾‘çš„ä»£ç æ–‡ä»¶ã€‚

### æ”¯æŒçš„è¯­è¨€
- JavaScript / TypeScript / ArkTS
- Python / Java / C / C++
- HTML / CSS / JSON
- Markdown

### ä¸»é¢˜åˆ‡æ¢
ç‚¹å‡»å³ä¸Šè§’çš„"ğŸ¨"å›¾æ ‡åˆ‡æ¢ä¸»é¢˜ï¼š
- æ·±è‰²ä¸»é¢˜
- æµ…è‰²ä¸»é¢˜
- Monokai
- Dracula

### å¿«æ·åŠŸèƒ½
- **Ctrl+S**: ä¿å­˜æ–‡ä»¶
- **Ctrl+F**: æœç´¢
- **Ctrl+H**: æ›¿æ¢

## ğŸ“ å¼€å§‹ç¼–ç å§ï¼

ä¿®æ”¹æ­¤æ–‡æœ¬æˆ–æ‰“å¼€æ–°æ–‡ä»¶å³å¯å¼€å§‹ã€‚`
    );
    this.fileService.addTab(welcomeTab);
    this.updateTabs();
  }

  private updateTabs() {
    this.tabs = this.fileService.getTabs();
    this.activeTab = this.fileService.getActiveTab();
    this.isPreviewMode = this.activeTab ? 
      this.markdownService.isMarkdownFile(this.activeTab.fileName) : false;
  }

  private async openFile() {
    try {
      const content = await this.fileService.openFile();
      // è¿™é‡Œåº”è¯¥è·å–æ–‡ä»¶åå’Œè·¯å¾„ï¼Œç®€åŒ–å¤„ç†
      const fileName = 'æ–°æ–‡ä»¶.txt';
      const tab = this.fileService.createNewTab(fileName, '', content);
      this.fileService.addTab(tab);
      this.updateTabs();
    } catch (error) {
      console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error);
    }
  }

  private async saveFile() {
    if (!this.activeTab || !this.activeTab.filePath) {
      return;
    }
    
    try {
      await this.fileService.saveFile(this.activeTab.filePath, this.activeTab.content);
      this.fileService.markTabAsModified(this.activeTab.id, false);
      this.updateTabs();
    } catch (error) {
      console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
    }
  }

  private switchTab(tabId: string) {
    this.fileService.setActiveTab(tabId);
    this.updateTabs();
  }

  private closeTab(tabId: string) {
    this.fileService.removeTab(tabId);
    this.updateTabs();
  }

  private onContentChange(content: string) {
    if (this.activeTab) {
      this.fileService.updateTabContent(this.activeTab.id, content);
      this.updateTabs();
    }
  }

  private cycleTheme() {
    const nextTheme = this.themeService.getNextTheme();
    this.themeService.switchTheme(nextTheme.id);
    this.themeService.saveThemePreference(nextTheme.id);
  }

  build() {
    Column() {
      // é¡¶éƒ¨å·¥å…·æ 
      this.buildToolbar()

      Row() {
        // æ–‡ä»¶æ ‘ï¼ˆä¾§è¾¹æ ï¼‰
        if (this.isFileTreeVisible) {
          this.buildSidebar()
        }

        // ä¸»ç¼–è¾‘åŒº
        Column() {
          // æ ‡ç­¾æ 
          if (this.tabs.length > 0) {
            this.buildTabBar()
          }

          // ç¼–è¾‘å™¨å†…å®¹
          if (this.activeTab) {
            HighlightedText({
              code: this.activeTab.content,
              language: this.activeTab.language,
              isEditable: true,
              fontSize: 14
            })
          } else {
            this.buildEmptyState()
          }
        }
        .layoutWeight(1)
        .height('100%')
        .backgroundColor(this.currentTheme.editor.background)
      }
      .layoutWeight(1)
      .width('100%')

      // æ¬¢è¿å¼•å¯¼
      if (this.showWelcomeGuide) {
        WelcomeGuide({
          visible: this.showWelcomeGuide,
          onClose: () => {
            this.showWelcomeGuide = false;
          }
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.currentTheme.colors.background)
  }

  @Builder
  buildToolbar(): void {
    Row() {
      // å·¦ä¾§ï¼šè¿”å›å’Œæ–‡ä»¶æ ‘åˆ‡æ¢
      Row({ space: 8 }) {
        Button({ type: ButtonType.Circle }) {
          Text('â†')
            .fontSize(18)
            .fontColor(this.currentTheme.colors.text)
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back();
        })

        Button({ type: ButtonType.Circle }) {
          Text('â˜°')
            .fontSize(16)
            .fontColor(this.currentTheme.colors.text)
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.isFileTreeVisible = !this.isFileTreeVisible;
        })
      }

      // ä¸­é—´ï¼šæ ‡é¢˜
      Text('xxCode')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.currentTheme.colors.text)
        .layoutWeight(1)
        .margin({ left: 12 })

      // å³ä¾§ï¼šæ“ä½œæŒ‰é’®
      Row({ space: 8 }) {
        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”')
            .fontSize(16)
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.showSearchDialog = true;
          this.searchDialogController.open();
        })

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ¨')
            .fontSize(16)
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.cycleTheme();
        })

        Button({ type: ButtonType.Normal }) {
          Text('æ‰“å¼€')
            .fontSize(13)
            .fontColor(this.currentTheme.colors.text)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.currentTheme.colors.surface)
        .borderRadius(6)
        .onClick(() => {
          this.openFile();
        })

        Button({ type: ButtonType.Normal }) {
          Text('ä¿å­˜')
            .fontSize(13)
            .fontColor(Color.White)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.currentTheme.colors.primary)
        .borderRadius(6)
        .onClick(() => {
          this.saveFile();
        })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 12, right: 12 })
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildSidebar(): void {
    Column() {
      Row() {
        Text('æ–‡ä»¶')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.currentTheme.colors.text)
          .layoutWeight(1)

        if (this.breakpointService.isPhone()) {
          Button({ type: ButtonType.Circle }) {
            Text('Ã—')
              .fontSize(18)
              .fontColor(this.currentTheme.colors.textSecondary)
          }
          .width(28)
          .height(28)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.isFileTreeVisible = false;
          })
        }
      }
      .width('100%')
      .padding(12)

      Divider().color(this.currentTheme.colors.border)

      Scroll() {
        Column() {
          if (this.fileTree.length > 0) {
            ForEach(this.fileTree, (item: FileItem) => {
              FileTreeItem({
                fileItem: item,
                level: 0,
                isExpanded: this.expandedFolders.has(item.path),
                isSelected: false,
                onFileClick: (file: FileItem) => {},
                onFolderToggle: (folder: FileItem) => {
                  if (this.expandedFolders.has(folder.path)) {
                    this.expandedFolders.delete(folder.path);
                  } else {
                    this.expandedFolders.add(folder.path);
                  }
                  this.expandedFolders = new Set(this.expandedFolders);
                }
              })
            }, (item: FileItem) => item.path)
          } else {
            this.buildEmptySidebar()
          }
        }
        .padding(8)
      }
      .layoutWeight(1)
    }
    .width(this.breakpointService.isPhone() ? '85%' : 
           this.breakpointService.isTablet() ? 320 : 360)
    .height('100%')
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { right: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildEmptySidebar(): void {
    Column() {
      Text('ğŸ“‚')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æš‚æ— æ–‡ä»¶')
        .fontSize(14)
        .fontColor(this.currentTheme.colors.textSecondary)
    }
    .width('100%')
    .height(200)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildTabBar(): void {
    Scroll() {
      Row({ space: 4 }) {
        ForEach(this.tabs, (tab: EditorTab) => {
          Row({ space: 6 }) {
            Text(tab.fileName)
              .fontSize(13)
              .fontColor(tab.isActive ? this.currentTheme.colors.primary : this.currentTheme.colors.text)
              .fontWeight(tab.isActive ? FontWeight.Medium : FontWeight.Normal)

            if (tab.isModified) {
              Circle()
                .width(6)
                .height(6)
                .fill(this.currentTheme.colors.warning)
            }

            Button({ type: ButtonType.Circle }) {
              Text('Ã—')
                .fontSize(14)
                .fontColor(this.currentTheme.colors.textSecondary)
            }
            .width(16)
            .height(16)
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.closeTab(tab.id);
            })
          }
          .height(36)
          .padding({ left: 12, right: 8 })
          .backgroundColor(tab.isActive ? this.currentTheme.colors.surface : Color.Transparent)
          .borderRadius(6)
          .onClick(() => {
            this.switchTab(tab.id);
          })
        }, (tab: EditorTab) => tab.id)
      }
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .width('100%')
    .height(44)
    .padding({ left: 8, right: 8 })
    .backgroundColor(this.currentTheme.editor.background)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildEmptyState(): void {
    Column() {
      Text('ğŸ“')
        .fontSize(64)
        .margin({ bottom: 20 })
      
      Text('æ²¡æœ‰æ‰“å¼€çš„æ–‡ä»¶')
        .fontSize(18)
        .fontColor(this.currentTheme.colors.text)
        .margin({ bottom: 8 })
      
      Text('ç‚¹å‡»"æ‰“å¼€"æŒ‰é’®é€‰æ‹©æ–‡ä»¶')
        .fontSize(14)
        .fontColor(this.currentTheme.colors.textSecondary)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .backgroundColor(this.currentTheme.editor.background)
  }
}
