/**
 * xxCode ä¸»ç¼–è¾‘å™¨é¡µé¢
 * ç®€åŒ–ç‰ˆä»£ç ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ–°å»ºã€æ‰“å¼€ã€ä¿å­˜æ–‡ä»¶
 */
import { router, window } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { fileIo } from '@kit.CoreFileKit';
import { common } from '@kit.AbilityKit';
import { util } from '@kit.ArkTS';
import { preferences } from '@kit.ArkData';
import { ThemeService, Theme } from '../services/ThemeService';
import { BreakpointService, Breakpoint } from '../services/BreakpointService';
import { SyntaxHighlightService, Token } from '../services/SyntaxHighlightService';
import { promptAction } from '@kit.ArkUI';

// æ–‡ä»¶ç±»å‹é…ç½®
interface FileTypeOption {
  name: string;
  suffix: string;
  language: string;
}

@Entry
@Component
struct CodeEditor {
  // ç¼–è¾‘å™¨çŠ¶æ€
  @State content: string = '';
  @State fileName: string = 'æœªå‘½å';
  @State filePath: string = '';
  @State isModified: boolean = false;
  @State language: string = 'text';
  @State lineCount: number = 1;
  
  // UI çŠ¶æ€
  @State currentTheme: Theme = ThemeService.getInstance().getCurrentTheme();
  @State currentBreakpoint: Breakpoint = 'sm';
  @State showFileTypeMenu: boolean = false;
  @State isPreviewMode: boolean = false; // é¢„è§ˆæ¨¡å¼ï¼ˆæ˜¾ç¤ºé«˜äº®ï¼‰
  @State fontSize: number = 14; // å­—ä½“å¤§å°
  
  // é¿è®©åŒºé«˜åº¦
  @StorageProp('topRectHeight') topRectHeight: number = 0;
  @StorageProp('bottomRectHeight') bottomRectHeight: number = 0;
  
  // æ»šåŠ¨æ§åˆ¶å™¨
  private editorScroller: Scroller = new Scroller();
  
  private context: common.UIAbilityContext | null = null;
  private themeService: ThemeService = ThemeService.getInstance();
  private breakpointService: BreakpointService = BreakpointService.getInstance();
  private syntaxService: SyntaxHighlightService = SyntaxHighlightService.getInstance();
  
  // æ”¯æŒçš„æ–‡ä»¶ç±»å‹
  private fileTypes: FileTypeOption[] = [
    { name: 'æ–‡æœ¬æ–‡ä»¶', suffix: '.txt', language: 'text' },
    { name: 'ArkTS æ–‡ä»¶', suffix: '.ets', language: 'typescript' },
    { name: 'TypeScript', suffix: '.ts', language: 'typescript' },
    { name: 'JavaScript', suffix: '.js', language: 'javascript' },
    { name: 'Python', suffix: '.py', language: 'python' },
    { name: 'Java', suffix: '.java', language: 'java' },
    { name: 'C++', suffix: '.cpp', language: 'cpp' },
    { name: 'C', suffix: '.c', language: 'c' },
    { name: 'HTML', suffix: '.html', language: 'html' },
    { name: 'CSS', suffix: '.css', language: 'css' },
    { name: 'JSON', suffix: '.json', language: 'json' },
    { name: 'Markdown', suffix: '.md', language: 'markdown' }
  ];

  aboutToAppear() {
    this.context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    
    // æ³¨å†Œæ–­ç‚¹ç³»ç»Ÿ
    this.breakpointService.register();
    this.currentBreakpoint = this.breakpointService.getCurrentBreakpoint();
    this.breakpointService.onChange((breakpoint: Breakpoint) => {
      this.currentBreakpoint = breakpoint;
    });
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    this.themeService.onThemeChange((theme: Theme) => {
      this.currentTheme = theme;
      this.updateSystemBarColor(theme);
    });

    // åˆå§‹åŒ–æ—¶è®¾ç½®çŠ¶æ€æ é¢œè‰²
    this.updateSystemBarColor(this.currentTheme);
    
    // åŠ è½½å­—ä½“å¤§å°è®¾ç½®
    this.loadFontSize();
  }
  
  /**
   * åŠ è½½å­—ä½“å¤§å°è®¾ç½®
   */
  private loadFontSize() {
    try {
      if (!this.context) return;
      const store = preferences.getPreferencesSync(this.context, { name: 'settings' });
      this.fontSize = store.getSync('fontSize', 14) as number;
    } catch (e) {
      console.error('åŠ è½½å­—ä½“å¤§å°å¤±è´¥:', JSON.stringify(e));
    }
  }
  
  /**
   * æ‰“å¼€è®¾ç½®é¡µé¢
   */
  private openSettings() {
    router.pushUrl({ url: 'pages/Settings' });
  }

  aboutToDisappear() {
    this.breakpointService.unregister();
  }
  
  onPageShow() {
    // ä»è®¾ç½®é¡µé¢è¿”å›æ—¶é‡æ–°åŠ è½½å­—ä½“å¤§å°
    this.loadFontSize();
  }

  /**
   * æ ¹æ®å½“å‰ä¸»é¢˜æ›´æ–°ç³»ç»ŸçŠ¶æ€æ é¢œè‰²
   */
  private updateSystemBarColor(theme: Theme) {
    try {
      if (!this.context) {
        return;
      }
      
      const isDarkTheme = theme.id !== 'light';
      
      window.getLastWindow(this.context).then((windowClass) => {
        const systemBarProperties: window.SystemBarProperties = {
          statusBarContentColor: isDarkTheme ? '#FFFFFF' : '#000000',
          navigationBarContentColor: isDarkTheme ? '#FFFFFF' : '#000000',
          statusBarColor: '#00000000',
          navigationBarColor: '#00000000'
        };
        
        windowClass.setWindowSystemBarProperties(systemBarProperties);
      }).catch((err: Error) => {
        console.error('Failed to get window:', err.message);
      });
    } catch (error) {
      console.error('Failed to update system bar color:', JSON.stringify(error));
    }
  }

  /**
   * æ–°å»ºæ–‡ä»¶
   */
  private newFile() {
    if (this.isModified) {
      // æç¤ºä¿å­˜
      this.showConfirmDialog('æç¤º', 'å½“å‰æ–‡ä»¶æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ', (index: number) => {
        if (index === 0) {
          // ä¸ä¿å­˜ï¼Œç›´æ¥æ–°å»º
          this.resetEditor();
        } else if (index === 1) {
          // å…ˆä¿å­˜å†æ–°å»º
          this.saveFileAs().then(() => {
            this.resetEditor();
          });
        }
        // index === 2 å–æ¶ˆï¼Œä¸åšä»»ä½•æ“ä½œ
      });
    } else {
      this.resetEditor();
    }
  }

  /**
   * é‡ç½®ç¼–è¾‘å™¨ä¸ºç©ºç™½çŠ¶æ€
   */
  private resetEditor() {
    this.content = '';
    this.fileName = 'æœªå‘½å';
    this.filePath = '';
    this.isModified = false;
    this.language = 'text';
  }

  /**
   * æ‰“å¼€æ–‡ä»¶
   */
  private async openFile() {
    try {
      if (!this.context) {
        this.showToast('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        return;
      }

      const documentPicker = new picker.DocumentViewPicker(this.context);
      const result = await documentPicker.select({
        maxSelectNumber: 1
      });
      
      if (!result || result.length === 0) {
        return;
      }
      
      const fileUri = result[0];
      
      // è¯»å–æ–‡ä»¶å†…å®¹
      const file = fileIo.openSync(fileUri, fileIo.OpenMode.READ_ONLY);
      const stat = fileIo.statSync(file.fd);
      const arrayBuffer = new ArrayBuffer(stat.size);
      const readLen = fileIo.readSync(file.fd, arrayBuffer);
      fileIo.closeSync(file);

      // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
      const textDecoder = util.TextDecoder.create('utf-8', { ignoreBOM: true });
      const fileContent = textDecoder.decodeToString(new Uint8Array(arrayBuffer.slice(0, readLen)));

      // ä» URI æå–æ–‡ä»¶å
      const extractedFileName = this.extractFileName(fileUri);
      
      // æ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€
      this.content = fileContent;
      this.fileName = extractedFileName;
      this.filePath = fileUri;
      this.isModified = false;
      this.language = this.getLanguageFromFileName(extractedFileName);

      this.showToast('æ–‡ä»¶å·²æ‰“å¼€');
    } catch (err) {
      const error = err as Error;
      console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error.message);
      this.showToast(`æ‰“å¼€å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä¿å­˜æ–‡ä»¶ï¼ˆå¦‚æœå·²æœ‰è·¯å¾„åˆ™ç›´æ¥ä¿å­˜ï¼Œå¦åˆ™å¦å­˜ä¸ºï¼‰
   */
  private async saveFile() {
    if (this.filePath) {
      await this.saveToPath(this.filePath);
    } else {
      await this.saveFileAs();
    }
  }

  /**
   * å¦å­˜ä¸ºï¼ˆè°ƒç”¨ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹©ä¿å­˜ä½ç½®ï¼‰
   */
  private async saveFileAs() {
    try {
      if (!this.context) {
        this.showToast('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        return;
      }

      const documentPicker = new picker.DocumentViewPicker(this.context);
      
      // è·å–å½“å‰æ–‡ä»¶åç¼€å¯¹åº”çš„æ–‡ä»¶ç±»å‹
      const currentSuffix = this.getCurrentFileSuffix();
      
      const result = await documentPicker.save({
        newFileNames: [this.fileName === 'æœªå‘½å' ? `æ–°æ–‡ä»¶${currentSuffix}` : this.fileName],
      });
      
      if (!result || result.length === 0) {
        return;
      }
      
      const saveUri = result[0];
      await this.saveToPath(saveUri);
      
      // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
      this.filePath = saveUri;
      this.fileName = this.extractFileName(saveUri);
      this.language = this.getLanguageFromFileName(this.fileName);
      
    } catch (err) {
      const error = err as Error;
      console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error.message);
      this.showToast(`ä¿å­˜å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„
   */
  private async saveToPath(uri: string) {
    try {
      // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º Uint8Array
      const textEncoder = util.TextEncoder.create();
      const buffer = textEncoder.encodeInto(this.content);

      // å†™å…¥æ–‡ä»¶
      const file = fileIo.openSync(uri, fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.CREATE | fileIo.OpenMode.TRUNC);
      fileIo.writeSync(file.fd, buffer.buffer);
      fileIo.closeSync(file);

      this.isModified = false;
      this.showToast('ä¿å­˜æˆåŠŸ');
    } catch (err) {
      const error = err as Error;
      throw new Error(`å†™å…¥æ–‡ä»¶å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä» URI æå–æ–‡ä»¶åï¼ˆè§£ç  URL ç¼–ç çš„ä¸­æ–‡ï¼‰
   */
  private extractFileName(uri: string): string {
    const parts = uri.split('/');
    const encodedName = parts[parts.length - 1] || 'æœªå‘½å';
    try {
      // è§£ç  URL ç¼–ç çš„æ–‡ä»¶åï¼ˆå¦‚ %E4%B8%AD%E6%96%87 -> ä¸­æ–‡ï¼‰
      return decodeURIComponent(encodedName);
    } catch (e) {
      return encodedName;
    }
  }

  /**
   * è·å–å½“å‰æ–‡ä»¶åç¼€
   */
  private getCurrentFileSuffix(): string {
    if (this.fileName.includes('.')) {
      return '.' + this.fileName.split('.').pop();
    }
    return '.txt';
  }

  /**
   * ä»æ–‡ä»¶åè·å–è¯­è¨€ç±»å‹
   */
  private getLanguageFromFileName(fileName: string): string {
    const ext = fileName.split('.').pop()?.toLowerCase() || '';
    const languageMap: Record<string, string> = {
      'js': 'javascript',
      'ts': 'typescript',
      'ets': 'typescript',
      'py': 'python',
      'java': 'java',
      'cpp': 'cpp',
      'c': 'c',
      'go': 'go',
      'rs': 'rust',
      'md': 'markdown',
      'html': 'html',
      'css': 'css',
      'scss': 'scss',
      'json': 'json',
      'xml': 'xml',
      'yaml': 'yaml',
      'yml': 'yaml',
      'txt': 'text'
    };
    return languageMap[ext] || 'text';
  }

  /**
   * åˆ‡æ¢ä¸»é¢˜
   */
  private cycleTheme() {
    const nextTheme = this.themeService.getNextTheme();
    this.themeService.switchTheme(nextTheme.id);
    this.themeService.saveThemePreference(nextTheme.id);
  }

  /**
   * å†…å®¹å˜åŒ–æ—¶çš„å¤„ç†
   */
  private onContentChange(newContent: string) {
    this.content = newContent;
    this.isModified = true;
    // æ›´æ–°è¡Œæ•°
    this.lineCount = newContent.split('\n').length;
  }

  /**
   * è·å–ä»£ç è¡Œæ•°ç»„
   */
  private getCodeLines(): string[] {
    return this.content.split('\n');
  }

  /**
   * è·å– token å¯¹åº”çš„é¢œè‰²
   */
  private getTokenColor(type: string): string {
    const colorMap: Record<string, string> = {
      'keyword': this.currentTheme.syntax.keyword,
      'string': this.currentTheme.syntax.string,
      'comment': this.currentTheme.syntax.comment,
      'number': this.currentTheme.syntax.number,
      'function': this.currentTheme.syntax.function,
      'variable': this.currentTheme.syntax.variable,
      'operator': this.currentTheme.syntax.operator,
      'bracket': this.currentTheme.editor.text,
      'type': this.currentTheme.syntax.type,
      'text': this.currentTheme.editor.text
    };
    return colorMap[type] || this.currentTheme.editor.text;
  }

  /**
   * ç”Ÿæˆè¡Œå·æ•°ç»„
   */
  private getLineNumbers(): number[] {
    const lines: number[] = [];
    for (let i = 1; i <= this.lineCount; i++) {
      lines.push(i);
    }
    return lines;
  }

  /**
   * è·å–æ¯è¡Œçš„ç¼©è¿›çº§åˆ«ï¼ˆä»¥2ä¸ªç©ºæ ¼ä¸ºä¸€çº§ï¼‰
   */
  private getLineIndentLevels(): number[] {
    const lines = this.content.split('\n');
    const indentLevels: number[] = [];
    
    for (const line of lines) {
      let spaces = 0;
      for (const char of line) {
        if (char === ' ') {
          spaces++;
        } else if (char === '\t') {
          spaces += 2; // tab ç®— 2 ä¸ªç©ºæ ¼
        } else {
          break;
        }
      }
      // æ¯ 2 ä¸ªç©ºæ ¼ç®—ä¸€çº§ç¼©è¿›
      indentLevels.push(Math.floor(spaces / 2));
    }
    
    return indentLevels;
  }

  /**
   * è·å–æœ€å¤§ç¼©è¿›çº§åˆ«
   */
  private getMaxIndentLevel(): number {
    const levels = this.getLineIndentLevels();
    return Math.max(...levels, 0);
  }

  build() {
    Column() {
      // çŠ¶æ€æ å ä½åŒºåŸŸ
      Row()
        .width('100%')
        .height(px2vp(this.topRectHeight))
        .backgroundColor(this.currentTheme.colors.surface)

      // é¡¶éƒ¨å·¥å…·æ 
      this.buildToolbar()

      // ç¼–è¾‘åŒºåŸŸ
      Column() {
        // æ–‡ä»¶ä¿¡æ¯æ 
        this.buildFileInfoBar()
        
        // ç¼–è¾‘å™¨ä¸»ä½“
        this.buildEditor()
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor(this.currentTheme.editor.background)

      // åº•éƒ¨å¯¼èˆªæ å ä½åŒºåŸŸ
      Row()
        .width('100%')
        .height(px2vp(this.bottomRectHeight))
        .backgroundColor(this.currentTheme.editor.background)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.currentTheme.colors.background)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  buildToolbar(): void {
    Row() {
      // å·¦ä¾§ï¼šæ ‡é¢˜
      Column() {
        Text(this.fileName + (this.isModified ? ' â€¢' : ''))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTheme.colors.text)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // å³ä¾§ï¼šæ“ä½œæŒ‰é’®
      Row({ space: 8 }) {
        // è®¾ç½®æŒ‰é’®
        Button({ type: ButtonType.Circle }) {
          Text('âš™ï¸')
            .fontSize(16)
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.openSettings();
        })
        
        // ç¼–è¾‘/é¢„è§ˆåˆ‡æ¢
        Button({ type: ButtonType.Normal }) {
          Text(this.isPreviewMode ? 'âœï¸ ç¼–è¾‘' : 'ğŸ‘ï¸ é¢„è§ˆ')
            .fontSize(13)
            .fontColor(this.isPreviewMode ? Color.White : this.currentTheme.colors.text)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.isPreviewMode ? this.currentTheme.colors.primary : this.currentTheme.colors.surface)
        .borderRadius(6)
        .onClick(() => {
          this.isPreviewMode = !this.isPreviewMode;
        })

        // ä¸»é¢˜åˆ‡æ¢
        Button({ type: ButtonType.Circle }) {
          Text('ğŸ¨')
            .fontSize(16)
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.cycleTheme();
        })

        // æ–°å»ºæ–‡ä»¶
        Button({ type: ButtonType.Normal }) {
          Text('æ–°å»º')
            .fontSize(13)
            .fontColor(this.currentTheme.colors.text)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.currentTheme.colors.surface)
        .borderRadius(6)
        .onClick(() => {
          this.newFile();
        })

        // æ‰“å¼€æ–‡ä»¶
        Button({ type: ButtonType.Normal }) {
          Text('æ‰“å¼€')
            .fontSize(13)
            .fontColor(this.currentTheme.colors.text)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.currentTheme.colors.surface)
        .borderRadius(6)
        .onClick(() => {
          this.openFile();
        })

        // ä¿å­˜æ–‡ä»¶
        Button({ type: ButtonType.Normal }) {
          Text('ä¿å­˜')
            .fontSize(13)
            .fontColor(Color.White)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.isModified ? this.currentTheme.colors.primary : this.currentTheme.colors.surface)
        .borderRadius(6)
        .onClick(() => {
          this.saveFile();
        })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 12, right: 12 })
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildFileInfoBar(): void {
    Row() {
      // æ–‡ä»¶ç±»å‹æ ‡è¯†
      Text(this.language.toUpperCase())
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
        .padding({ left: 8, right: 8, top: 2, bottom: 2 })
        .backgroundColor(this.currentTheme.colors.background)
        .borderRadius(4)

      Blank()

      // å­—ç¬¦æ•°ç»Ÿè®¡
      Text(`${this.content.length} å­—ç¬¦`)
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
      
      Text(' | ')
        .fontSize(11)
        .fontColor(this.currentTheme.colors.border)
      
      // è¡Œæ•°ç»Ÿè®¡
      Text(`${this.lineCount} è¡Œ`)
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
    }
    .width('100%')
    .height(28)
    .padding({ left: 12, right: 12 })
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildEditor(): void {
    if (this.isPreviewMode) {
      // é¢„è§ˆæ¨¡å¼ï¼šè¡Œå·å’Œä»£ç ä¸€èµ·æ»šåŠ¨
      Scroll(this.editorScroller) {
        Row() {
          // è¡Œå·åˆ—
          Column() {
            ForEach(this.getDisplayLineNumbers(), (lineNum: number) => {
              Text(`${lineNum}`)
                .fontSize(this.fontSize)
                .fontColor(this.currentTheme.editor.lineNumber)
                .fontFamily('monospace')
                .width(40)
                .height(this.fontSize + 8)
                .textAlign(TextAlign.End)
                .padding({ right: 8 })
                .opacity(lineNum <= this.lineCount ? 1.0 : 0.3)
            }, (lineNum: number) => `ln_${lineNum}`)
          }
          .alignItems(HorizontalAlign.End)
          .backgroundColor(this.currentTheme.colors.surface)
          
          // åˆ†éš”çº¿
          Column()
            .width(1)
            .height('100%')
            .backgroundColor(this.currentTheme.colors.border)
          
          // ä»£ç åŒºåŸŸï¼ˆé«˜äº®ï¼‰
          Column() {
            ForEach(this.getCodeLines(), (line: string, lineIndex: number) => {
              Row() {
                Text() {
                  ForEach(this.syntaxService.tokenize(line, this.language), (token: Token, tokenIndex: number) => {
                    // å°†ç©ºæ ¼æ›¿æ¢ä¸ºä¸é—´æ–­ç©ºæ ¼ï¼Œé˜²æ­¢è¢«æŠ˜å 
                    Span(token.value.replace(/ /g, '\u00A0'))
                      .fontSize(this.fontSize)
                      .fontColor(this.getTokenColor(token.type))
                      .fontFamily('monospace')
                  }, (token: Token, tokenIndex: number) => `${lineIndex}_${tokenIndex}_${token.start}`)
                }
                .width('100%')
                .lineHeight(this.fontSize + 8)
              }
              .width('100%')
              .height(this.fontSize + 8)
              .alignItems(VerticalAlign.Top)
            }, (line: string, lineIndex: number) => `hl_${lineIndex}_${line.substring(0, 20)}`)
          }
          .layoutWeight(1)
          .padding({ left: 8, right: 16 })
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
        .padding({ top: 12, bottom: 12 })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.On)
      .scrollBarWidth(10)
      .scrollBarColor(this.currentTheme.colors.textSecondary)
      .backgroundColor(this.currentTheme.editor.background)
    } else {
      // ç¼–è¾‘æ¨¡å¼ï¼šä½¿ç”¨ Scroll åŒ…è£¹è¡Œå·å’Œ TextAreaï¼Œå®ç°åŒæ­¥æ»šåŠ¨
      Scroll(this.editorScroller) {
        Row() {
          // å·¦ä¾§è¡Œå·åŒºåŸŸ
          Column() {
            ForEach(this.getDisplayLineNumbers(), (lineNum: number) => {
              Text(`${lineNum}`)
                .fontSize(this.fontSize)
                .fontColor(this.currentTheme.editor.lineNumber)
                .fontFamily('monospace')
                .width(40)
                .height(this.fontSize + 8)
                .textAlign(TextAlign.End)
                .padding({ right: 8 })
                .opacity(lineNum <= this.lineCount ? 1.0 : 0.3)
            }, (lineNum: number) => `edit_ln_${lineNum}`)
          }
          .alignItems(HorizontalAlign.End)
          .backgroundColor(this.currentTheme.colors.surface)
          
          // åˆ†éš”çº¿
          Column()
            .width(1)
            .backgroundColor(this.currentTheme.colors.border)
          
          // å³ä¾§ä»£ç ç¼–è¾‘åŒº - ä½¿ç”¨å›ºå®šé«˜åº¦çš„ TextArea
          Column() {
            TextArea({ text: this.content, placeholder: 'åœ¨æ­¤è¾“å…¥ä»£ç ...' })
              .width('100%')
              .constraintSize({ minHeight: this.getEditorMinHeight() })
              .fontSize(this.fontSize)
              .fontColor(this.currentTheme.editor.text)
              .caretColor(this.currentTheme.colors.primary)
              .placeholderColor(this.currentTheme.colors.textSecondary)
              .backgroundColor(Color.Transparent)
              .padding(0)
              .fontFamily('monospace')
              .lineHeight(this.fontSize + 8)
              .onChange((value: string) => {
                this.onContentChange(value);
              })
          }
          .layoutWeight(1)
          .padding({ left: 8, right: 16 })
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
        .padding({ top: 12, bottom: 12 })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.On)
      .scrollBarWidth(10)
      .scrollBarColor(this.currentTheme.colors.textSecondary)
      .backgroundColor(this.currentTheme.editor.background)
    }
  }
  
  /**
   * è®¡ç®—ç¼–è¾‘å™¨æœ€å°é«˜åº¦ï¼Œç¡®ä¿è¡Œå·å’Œå†…å®¹å¯¹é½
   */
  private getEditorMinHeight(): number {
    const lineHeight = this.fontSize + 8;
    const minLines = Math.max(this.lineCount, 100);
    return minLines * lineHeight;
  }

  /**
   * è·å–æ˜¾ç¤ºçš„è¡Œå·ï¼ˆè‡³å°‘æ˜¾ç¤º 100 è¡Œï¼Œä¿è¯ä¸€å±éƒ½æœ‰è¡Œå·ï¼‰
   */
  private getDisplayLineNumbers(): number[] {
    const minLines = 100; // è‡³å°‘æ˜¾ç¤º 100 è¡Œ
    const totalLines = Math.max(this.lineCount, minLines);
    const lines: number[] = [];
    for (let i = 1; i <= totalLines; i++) {
      lines.push(i);
    }
    return lines;
  }

  /**
   * æ˜¾ç¤º Toast æç¤ºï¼ˆå°è£…æ–° APIï¼‰
   */
  private showToast(message: string) {
    try {
      promptAction.showToast({ message: message });
    } catch (e) {
      console.error('showToast error:', JSON.stringify(e));
    }
  }

  /**
   * æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ˆå°è£…æ–° APIï¼‰
   */
  private showConfirmDialog(title: string, message: string, callback: (index: number) => void) {
    try {
      promptAction.showDialog({
        title: title,
        message: message,
        buttons: [
          { text: 'ä¸ä¿å­˜', color: this.currentTheme.colors.textSecondary },
          { text: 'ä¿å­˜', color: this.currentTheme.colors.primary },
          { text: 'å–æ¶ˆ', color: this.currentTheme.colors.textSecondary }
        ]
      }).then((result) => {
        callback(result.index);
      }).catch((err: Error) => {
        console.error('showDialog error:', err.message);
      });
    } catch (e) {
      console.error('showConfirmDialog error:', JSON.stringify(e));
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µï¼ˆå°è£…æ–° APIï¼‰
   */
  private goBack() {
    try {
      router.back();
    } catch (e) {
      console.error('router.back error:', JSON.stringify(e));
    }
  }
}
