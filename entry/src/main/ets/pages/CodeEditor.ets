/**
 * xxCode ä¸»ç¼–è¾‘å™¨é¡µé¢
 * ç®€åŒ–ç‰ˆä»£ç ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ–°å»ºã€æ‰“å¼€ã€ä¿å­˜æ–‡ä»¶
 */
import { router, window } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { fileIo } from '@kit.CoreFileKit';
import { common } from '@kit.AbilityKit';
import { util } from '@kit.ArkTS';
import { ThemeService, Theme } from '../services/ThemeService';
import { BreakpointService, Breakpoint } from '../services/BreakpointService';
import { promptAction } from '@kit.ArkUI';

// æ–‡ä»¶ç±»å‹é…ç½®
interface FileTypeOption {
  name: string;
  suffix: string;
  language: string;
}

@Entry
@Component
struct CodeEditor {
  // ç¼–è¾‘å™¨çŠ¶æ€
  @State content: string = '';
  @State fileName: string = 'æœªå‘½å';
  @State filePath: string = '';
  @State isModified: boolean = false;
  @State language: string = 'text';
  @State lineCount: number = 1;
  
  // UI çŠ¶æ€
  @State currentTheme: Theme = ThemeService.getInstance().getCurrentTheme();
  @State currentBreakpoint: Breakpoint = 'sm';
  @State showFileTypeMenu: boolean = false;
  
  // é¿è®©åŒºé«˜åº¦
  @StorageProp('topRectHeight') topRectHeight: number = 0;
  @StorageProp('bottomRectHeight') bottomRectHeight: number = 0;
  
  // æ»šåŠ¨æ§åˆ¶å™¨
  private editorScroller: Scroller = new Scroller();
  
  private context: common.UIAbilityContext | null = null;
  private themeService: ThemeService = ThemeService.getInstance();
  private breakpointService: BreakpointService = BreakpointService.getInstance();
  
  // æ”¯æŒçš„æ–‡ä»¶ç±»å‹
  private fileTypes: FileTypeOption[] = [
    { name: 'æ–‡æœ¬æ–‡ä»¶', suffix: '.txt', language: 'text' },
    { name: 'ArkTS æ–‡ä»¶', suffix: '.ets', language: 'typescript' },
    { name: 'TypeScript', suffix: '.ts', language: 'typescript' },
    { name: 'JavaScript', suffix: '.js', language: 'javascript' },
    { name: 'Python', suffix: '.py', language: 'python' },
    { name: 'Java', suffix: '.java', language: 'java' },
    { name: 'C++', suffix: '.cpp', language: 'cpp' },
    { name: 'C', suffix: '.c', language: 'c' },
    { name: 'HTML', suffix: '.html', language: 'html' },
    { name: 'CSS', suffix: '.css', language: 'css' },
    { name: 'JSON', suffix: '.json', language: 'json' },
    { name: 'Markdown', suffix: '.md', language: 'markdown' }
  ];

  aboutToAppear() {
    this.context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    
    // æ³¨å†Œæ–­ç‚¹ç³»ç»Ÿ
    this.breakpointService.register();
    this.currentBreakpoint = this.breakpointService.getCurrentBreakpoint();
    this.breakpointService.onChange((breakpoint: Breakpoint) => {
      this.currentBreakpoint = breakpoint;
    });
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    this.themeService.onThemeChange((theme: Theme) => {
      this.currentTheme = theme;
      this.updateSystemBarColor(theme);
    });

    // åˆå§‹åŒ–æ—¶è®¾ç½®çŠ¶æ€æ é¢œè‰²
    this.updateSystemBarColor(this.currentTheme);
  }

  aboutToDisappear() {
    this.breakpointService.unregister();
  }

  /**
   * æ ¹æ®å½“å‰ä¸»é¢˜æ›´æ–°ç³»ç»ŸçŠ¶æ€æ é¢œè‰²
   */
  private updateSystemBarColor(theme: Theme) {
    try {
      if (!this.context) {
        return;
      }
      
      const isDarkTheme = theme.id !== 'light';
      
      window.getLastWindow(this.context).then((windowClass) => {
        const systemBarProperties: window.SystemBarProperties = {
          statusBarContentColor: isDarkTheme ? '#FFFFFF' : '#000000',
          navigationBarContentColor: isDarkTheme ? '#FFFFFF' : '#000000',
          statusBarColor: '#00000000',
          navigationBarColor: '#00000000'
        };
        
        windowClass.setWindowSystemBarProperties(systemBarProperties);
      }).catch((err: Error) => {
        console.error('Failed to get window:', err.message);
      });
    } catch (error) {
      console.error('Failed to update system bar color:', JSON.stringify(error));
    }
  }

  /**
   * æ–°å»ºæ–‡ä»¶
   */
  private newFile() {
    if (this.isModified) {
      // æç¤ºä¿å­˜
      this.showConfirmDialog('æç¤º', 'å½“å‰æ–‡ä»¶æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ', (index: number) => {
        if (index === 0) {
          // ä¸ä¿å­˜ï¼Œç›´æ¥æ–°å»º
          this.resetEditor();
        } else if (index === 1) {
          // å…ˆä¿å­˜å†æ–°å»º
          this.saveFileAs().then(() => {
            this.resetEditor();
          });
        }
        // index === 2 å–æ¶ˆï¼Œä¸åšä»»ä½•æ“ä½œ
      });
    } else {
      this.resetEditor();
    }
  }

  /**
   * é‡ç½®ç¼–è¾‘å™¨ä¸ºç©ºç™½çŠ¶æ€
   */
  private resetEditor() {
    this.content = '';
    this.fileName = 'æœªå‘½å';
    this.filePath = '';
    this.isModified = false;
    this.language = 'text';
  }

  /**
   * æ‰“å¼€æ–‡ä»¶
   */
  private async openFile() {
    try {
      if (!this.context) {
        this.showToast('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        return;
      }

      const documentPicker = new picker.DocumentViewPicker(this.context);
      const result = await documentPicker.select({
        maxSelectNumber: 1
      });
      
      if (!result || result.length === 0) {
        return;
      }
      
      const fileUri = result[0];
      
      // è¯»å–æ–‡ä»¶å†…å®¹
      const file = fileIo.openSync(fileUri, fileIo.OpenMode.READ_ONLY);
      const stat = fileIo.statSync(file.fd);
      const arrayBuffer = new ArrayBuffer(stat.size);
      const readLen = fileIo.readSync(file.fd, arrayBuffer);
      fileIo.closeSync(file);

      // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
      const textDecoder = util.TextDecoder.create('utf-8', { ignoreBOM: true });
      const fileContent = textDecoder.decodeToString(new Uint8Array(arrayBuffer.slice(0, readLen)));

      // ä» URI æå–æ–‡ä»¶å
      const extractedFileName = this.extractFileName(fileUri);
      
      // æ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€
      this.content = fileContent;
      this.fileName = extractedFileName;
      this.filePath = fileUri;
      this.isModified = false;
      this.language = this.getLanguageFromFileName(extractedFileName);

      this.showToast('æ–‡ä»¶å·²æ‰“å¼€');
    } catch (err) {
      const error = err as Error;
      console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error.message);
      this.showToast(`æ‰“å¼€å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä¿å­˜æ–‡ä»¶ï¼ˆå¦‚æœå·²æœ‰è·¯å¾„åˆ™ç›´æ¥ä¿å­˜ï¼Œå¦åˆ™å¦å­˜ä¸ºï¼‰
   */
  private async saveFile() {
    if (this.filePath) {
      await this.saveToPath(this.filePath);
    } else {
      await this.saveFileAs();
    }
  }

  /**
   * å¦å­˜ä¸ºï¼ˆè°ƒç”¨ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹©ä¿å­˜ä½ç½®ï¼‰
   */
  private async saveFileAs() {
    try {
      if (!this.context) {
        this.showToast('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        return;
      }

      const documentPicker = new picker.DocumentViewPicker(this.context);
      
      // è·å–å½“å‰æ–‡ä»¶åç¼€å¯¹åº”çš„æ–‡ä»¶ç±»å‹
      const currentSuffix = this.getCurrentFileSuffix();
      
      const result = await documentPicker.save({
        newFileNames: [this.fileName === 'æœªå‘½å' ? `æ–°æ–‡ä»¶${currentSuffix}` : this.fileName],
      });
      
      if (!result || result.length === 0) {
        return;
      }
      
      const saveUri = result[0];
      await this.saveToPath(saveUri);
      
      // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
      this.filePath = saveUri;
      this.fileName = this.extractFileName(saveUri);
      this.language = this.getLanguageFromFileName(this.fileName);
      
    } catch (err) {
      const error = err as Error;
      console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error.message);
      this.showToast(`ä¿å­˜å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„
   */
  private async saveToPath(uri: string) {
    try {
      // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º Uint8Array
      const textEncoder = util.TextEncoder.create();
      const buffer = textEncoder.encodeInto(this.content);

      // å†™å…¥æ–‡ä»¶
      const file = fileIo.openSync(uri, fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.CREATE | fileIo.OpenMode.TRUNC);
      fileIo.writeSync(file.fd, buffer.buffer);
      fileIo.closeSync(file);

      this.isModified = false;
      this.showToast('ä¿å­˜æˆåŠŸ');
    } catch (err) {
      const error = err as Error;
      throw new Error(`å†™å…¥æ–‡ä»¶å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä» URI æå–æ–‡ä»¶å
   */
  private extractFileName(uri: string): string {
    const parts = uri.split('/');
    return parts[parts.length - 1] || 'æœªå‘½å';
  }

  /**
   * è·å–å½“å‰æ–‡ä»¶åç¼€
   */
  private getCurrentFileSuffix(): string {
    if (this.fileName.includes('.')) {
      return '.' + this.fileName.split('.').pop();
    }
    return '.txt';
  }

  /**
   * ä»æ–‡ä»¶åè·å–è¯­è¨€ç±»å‹
   */
  private getLanguageFromFileName(fileName: string): string {
    const ext = fileName.split('.').pop()?.toLowerCase() || '';
    const languageMap: Record<string, string> = {
      'js': 'javascript',
      'ts': 'typescript',
      'ets': 'typescript',
      'py': 'python',
      'java': 'java',
      'cpp': 'cpp',
      'c': 'c',
      'go': 'go',
      'rs': 'rust',
      'md': 'markdown',
      'html': 'html',
      'css': 'css',
      'scss': 'scss',
      'json': 'json',
      'xml': 'xml',
      'yaml': 'yaml',
      'yml': 'yaml',
      'txt': 'text'
    };
    return languageMap[ext] || 'text';
  }

  /**
   * åˆ‡æ¢ä¸»é¢˜
   */
  private cycleTheme() {
    const nextTheme = this.themeService.getNextTheme();
    this.themeService.switchTheme(nextTheme.id);
    this.themeService.saveThemePreference(nextTheme.id);
  }

  /**
   * å†…å®¹å˜åŒ–æ—¶çš„å¤„ç†
   */
  private onContentChange(newContent: string) {
    this.content = newContent;
    this.isModified = true;
    // æ›´æ–°è¡Œæ•°
    this.lineCount = newContent.split('\n').length;
  }

  /**
   * ç”Ÿæˆè¡Œå·æ•°ç»„
   */
  private getLineNumbers(): number[] {
    const lines: number[] = [];
    for (let i = 1; i <= this.lineCount; i++) {
      lines.push(i);
    }
    return lines;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å·¥å…·æ 
      this.buildToolbar()

      // ç¼–è¾‘åŒºåŸŸ
      Column() {
        // æ–‡ä»¶ä¿¡æ¯æ 
        this.buildFileInfoBar()
        
        // ç¼–è¾‘å™¨ä¸»ä½“
        this.buildEditor()
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor(this.currentTheme.editor.background)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.currentTheme.colors.background)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    .padding({ top: this.topRectHeight / 3, bottom: this.bottomRectHeight / 3 })
  }

  @Builder
  buildToolbar(): void {
    Row() {
      // å·¦ä¾§ï¼šè¿”å›æŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Text('â†')
          .fontSize(18)
          .fontColor(this.currentTheme.colors.text)
      }
      .width(36)
      .height(36)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        if (this.isModified) {
          this.showConfirmDialog('æç¤º', 'å½“å‰æ–‡ä»¶æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜åé€€å‡ºï¼Ÿ', (index: number) => {
            if (index === 0) {
              this.goBack();
            } else if (index === 1) {
              this.saveFile().then(() => {
                this.goBack();
              });
            }
          });
        } else {
          this.goBack();
        }
      })

      // ä¸­é—´ï¼šæ ‡é¢˜
      Column() {
        Text(this.fileName + (this.isModified ? ' â€¢' : ''))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTheme.colors.text)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
      .margin({ left: 12 })
      .alignItems(HorizontalAlign.Start)

      // å³ä¾§ï¼šæ“ä½œæŒ‰é’®
      Row({ space: 8 }) {
        // ä¸»é¢˜åˆ‡æ¢
        Button({ type: ButtonType.Circle }) {
          Text('ğŸ¨')
            .fontSize(16)
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.cycleTheme();
        })

        // æ–°å»ºæ–‡ä»¶
        Button({ type: ButtonType.Normal }) {
          Text('æ–°å»º')
            .fontSize(13)
            .fontColor(this.currentTheme.colors.text)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.currentTheme.colors.surface)
        .borderRadius(6)
        .onClick(() => {
          this.newFile();
        })

        // æ‰“å¼€æ–‡ä»¶
        Button({ type: ButtonType.Normal }) {
          Text('æ‰“å¼€')
            .fontSize(13)
            .fontColor(this.currentTheme.colors.text)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.currentTheme.colors.surface)
        .borderRadius(6)
        .onClick(() => {
          this.openFile();
        })

        // ä¿å­˜æ–‡ä»¶
        Button({ type: ButtonType.Normal }) {
          Text('ä¿å­˜')
            .fontSize(13)
            .fontColor(Color.White)
        }
        .height(32)
        .padding({ left: 12, right: 12 })
        .backgroundColor(this.isModified ? this.currentTheme.colors.primary : this.currentTheme.colors.surface)
        .borderRadius(6)
        .onClick(() => {
          this.saveFile();
        })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 12, right: 12 })
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildFileInfoBar(): void {
    Row() {
      // æ–‡ä»¶ç±»å‹æ ‡è¯†
      Text(this.language.toUpperCase())
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
        .padding({ left: 8, right: 8, top: 2, bottom: 2 })
        .backgroundColor(this.currentTheme.colors.background)
        .borderRadius(4)

      Blank()

      // å­—ç¬¦æ•°ç»Ÿè®¡
      Text(`${this.content.length} å­—ç¬¦`)
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
      
      Text(' | ')
        .fontSize(11)
        .fontColor(this.currentTheme.colors.border)
      
      // è¡Œæ•°ç»Ÿè®¡
      Text(`${this.lineCount} è¡Œ`)
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
    }
    .width('100%')
    .height(28)
    .padding({ left: 12, right: 12 })
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildEditor(): void {
    Scroll(this.editorScroller) {
      Row() {
        // è¡Œå·åŒºåŸŸ
        Column() {
          ForEach(this.getLineNumbers(), (lineNum: number) => {
            Text(`${lineNum}`)
              .fontSize(14)
              .fontColor(this.currentTheme.editor.lineNumber)
              .fontFamily('monospace')
              .width(40)
              .height(22)
              .textAlign(TextAlign.End)
              .padding({ right: 12 })
          }, (lineNum: number) => lineNum.toString())
        }
        .alignItems(HorizontalAlign.End)
        .backgroundColor(this.currentTheme.colors.surface)
        .padding({ top: 12 })

        // ç¼–è¾‘å™¨åŒºåŸŸ
        TextArea({ text: this.content, placeholder: 'åœ¨æ­¤è¾“å…¥ä»£ç ...' })
          .layoutWeight(1)
          .constraintSize({ minHeight: 500 })
          .fontSize(14)
          .fontColor(this.currentTheme.editor.text)
          .caretColor(this.currentTheme.colors.primary)
          .placeholderColor(this.currentTheme.colors.textSecondary)
          .backgroundColor(Color.Transparent)
          .padding({ left: 8, right: 12, top: 12, bottom: 12 })
          .fontFamily('monospace')
          .lineHeight(22)
          .onChange((value: string) => {
            this.onContentChange(value);
          })
      }
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .layoutWeight(1)
    .scrollBar(BarState.Auto)
    .backgroundColor(this.currentTheme.editor.background)
  }

  /**
   * æ˜¾ç¤º Toast æç¤ºï¼ˆå°è£…æ–° APIï¼‰
   */
  private showToast(message: string) {
    try {
      promptAction.showToast({ message: message });
    } catch (e) {
      console.error('showToast error:', JSON.stringify(e));
    }
  }

  /**
   * æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ˆå°è£…æ–° APIï¼‰
   */
  private showConfirmDialog(title: string, message: string, callback: (index: number) => void) {
    try {
      promptAction.showDialog({
        title: title,
        message: message,
        buttons: [
          { text: 'ä¸ä¿å­˜', color: this.currentTheme.colors.textSecondary },
          { text: 'ä¿å­˜', color: this.currentTheme.colors.primary },
          { text: 'å–æ¶ˆ', color: this.currentTheme.colors.textSecondary }
        ]
      }).then((result) => {
        callback(result.index);
      }).catch((err: Error) => {
        console.error('showDialog error:', err.message);
      });
    } catch (e) {
      console.error('showConfirmDialog error:', JSON.stringify(e));
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µï¼ˆå°è£…æ–° APIï¼‰
   */
  private goBack() {
    try {
      router.back();
    } catch (e) {
      console.error('router.back error:', JSON.stringify(e));
    }
  }
}
