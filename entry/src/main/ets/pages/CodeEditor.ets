/**
 * xxCode ä¸»ç¼–è¾‘å™¨é¡µé¢
 * ç®€åŒ–ç‰ˆä»£ç ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ–°å»ºã€æ‰“å¼€ã€ä¿å­˜æ–‡ä»¶
 */
import { router, window, curves } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { fileIo } from '@kit.CoreFileKit';
import { common } from '@kit.AbilityKit';
import { util } from '@kit.ArkTS';
import { preferences } from '@kit.ArkData';
import { ThemeService, Theme } from '../services/ThemeService';
import { BreakpointService, Breakpoint } from '../services/BreakpointService';
import { SyntaxHighlightService, Token } from '../services/SyntaxHighlightService';
import { CodeFormatterService } from '../services/CodeFormatterService';
import { FileManagerService, FileItem } from '../services/FileManagerService';
import { FileTab } from '../models/FileTabModel';
import { IconButton } from '../components/IconButton';
import { TabBar } from '../components/TabBar';
import { FileBrowser } from '../components/FileBrowser';
import { NewFileDialog } from '../components/NewFileDialog';
import { promptAction } from '@kit.ArkUI';

// æ–‡ä»¶ç±»å‹é…ç½®
interface FileTypeOption {
  name: string;
  suffix: string;
  language: string;
}

@Entry
@Component
struct CodeEditor {
  // é¡µé¢è½¬åœºåŠ¨ç”»é…ç½®
  pageTransition() {
    // è¿›å…¥åŠ¨ç”»ï¼šä»å³ä¾§æ»‘å…¥
    PageTransitionEnter({ duration: 350, curve: Curve.EaseOut })
      .slide(SlideEffect.Right)
    // é€€å‡ºåŠ¨ç”»ï¼šå‘å·¦ä¾§æ»‘å‡º
    PageTransitionExit({ duration: 350, curve: Curve.EaseIn })
      .slide(SlideEffect.Left)
  }
  
  // å¤šæ ‡ç­¾çŠ¶æ€
  @State tabs: FileTab[] = [];
  @State currentTabId: string = '';
  @State showFileBrowser: boolean = true;
  @State sidebarWidth: number = 200; // ä¾§è¾¹æ å®½åº¦
  @State internalFiles: FileItem[] = [];
  
  // ç¼–è¾‘å™¨çŠ¶æ€ï¼ˆå½“å‰æ ‡ç­¾ï¼‰
  @State content: string = '';
  @State fileName: string = 'æœªå‘½å';
  @State filePath: string = '';
  @State isModified: boolean = false;
  @State language: string = 'text';
  @State lineCount: number = 1;
  
  // UI çŠ¶æ€
  @State currentTheme: Theme = ThemeService.getInstance().getCurrentTheme();
  @State currentBreakpoint: Breakpoint = 'sm';
  @State showFileTypeMenu: boolean = false;
  @State isPreviewMode: boolean = false; // é¢„è§ˆæ¨¡å¼ï¼ˆæ˜¾ç¤ºé«˜äº®ï¼‰
  @State fontSize: number = 14; // å­—ä½“å¤§å°
  @State editorScale: number = 1; // ç¼–è¾‘å™¨ç¼©æ”¾
  
  // æœç´¢æ›¿æ¢çŠ¶æ€
  @State showSearchBar: boolean = false;
  @State searchText: string = '';
  @State replaceText: string = '';
  @State searchResults: number[] = []; // åŒ¹é…çš„ä½ç½®
  @State currentSearchIndex: number = -1;
  
  // åŠ¨ç”»æ›²çº¿
  private springCurve: ICurve = curves.springMotion(0.6, 0.8);
  
  // å¯¹è¯æ¡†æ§åˆ¶å™¨
  private newFileDialogController: CustomDialogController = new CustomDialogController({
    builder: NewFileDialog({
      bgColor: this.currentTheme.colors.surface,
      textColor: this.currentTheme.colors.text,
      primaryColor: this.currentTheme.colors.primary,
      onConfirm: (fileName: string) => {
        this.handleCreateFile(fileName);
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: true
  });
  
  // é¿è®©åŒºé«˜åº¦
  @StorageProp('topRectHeight') topRectHeight: number = 0;
  @StorageProp('bottomRectHeight') bottomRectHeight: number = 0;
  
  // æ»šåŠ¨æ§åˆ¶å™¨
  private editorScroller: Scroller = new Scroller();
  
  private context: common.UIAbilityContext | null = null;
  private themeService: ThemeService = ThemeService.getInstance();
  private breakpointService: BreakpointService = BreakpointService.getInstance();
  private formatterService: CodeFormatterService = CodeFormatterService.getInstance();
  private syntaxService: SyntaxHighlightService = SyntaxHighlightService.getInstance();
  private fileManager: FileManagerService = FileManagerService.getInstance();
  
  // æ”¯æŒçš„æ–‡ä»¶ç±»å‹
  private fileTypes: FileTypeOption[] = [
    { name: 'æ–‡æœ¬æ–‡ä»¶', suffix: '.txt', language: 'text' },
    { name: 'ArkTS æ–‡ä»¶', suffix: '.ets', language: 'typescript' },
    { name: 'TypeScript', suffix: '.ts', language: 'typescript' },
    { name: 'JavaScript', suffix: '.js', language: 'javascript' },
    { name: 'Python', suffix: '.py', language: 'python' },
    { name: 'Java', suffix: '.java', language: 'java' },
    { name: 'C++', suffix: '.cpp', language: 'cpp' },
    { name: 'C', suffix: '.c', language: 'c' },
    { name: 'HTML', suffix: '.html', language: 'html' },
    { name: 'CSS', suffix: '.css', language: 'css' },
    { name: 'JSON', suffix: '.json', language: 'json' },
    { name: 'Markdown', suffix: '.md', language: 'markdown' }
  ];

  aboutToAppear() {
    this.context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    
    // åˆå§‹åŒ–æ–‡ä»¶ç®¡ç†å™¨
    if (this.context) {
      this.fileManager.init(this.context);
      this.loadInternalFiles();
    }
    
    // åˆ›å»ºé»˜è®¤æ ‡ç­¾
    this.createNewTab();
    
    // æ³¨å†Œæ–­ç‚¹ç³»ç»Ÿ
    this.breakpointService.register();
    this.currentBreakpoint = this.breakpointService.getCurrentBreakpoint();
    this.breakpointService.onChange((breakpoint: Breakpoint) => {
      this.currentBreakpoint = breakpoint;
    });
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    this.themeService.onThemeChange((theme: Theme) => {
      this.currentTheme = theme;
      this.updateSystemBarColor(theme);
    });

    // åˆå§‹åŒ–æ—¶è®¾ç½®çŠ¶æ€æ é¢œè‰²
    this.updateSystemBarColor(this.currentTheme);
    
    // åŠ è½½å­—ä½“å¤§å°è®¾ç½®
    this.loadFontSize();
  }
  
  /**
   * åŠ è½½å­—ä½“å¤§å°è®¾ç½®
   */
  private loadFontSize() {
    try {
      if (!this.context) return;
      const store = preferences.getPreferencesSync(this.context, { name: 'settings' });
      this.fontSize = store.getSync('fontSize', 14) as number;
    } catch (e) {
      console.error('åŠ è½½å­—ä½“å¤§å°å¤±è´¥:', JSON.stringify(e));
    }
  }
  
  /**
   * æ‰“å¼€è®¾ç½®é¡µé¢
   */
  private openSettings() {
    router.pushUrl({ url: 'pages/Settings' });
  }

  aboutToDisappear() {
    this.breakpointService.unregister();
  }
  
  onPageShow() {
    // ä»è®¾ç½®é¡µé¢è¿”å›æ—¶é‡æ–°åŠ è½½å­—ä½“å¤§å°
    this.loadFontSize();
  }

  /**
   * æ ¹æ®å½“å‰ä¸»é¢˜æ›´æ–°ç³»ç»ŸçŠ¶æ€æ é¢œè‰²
   */
  private updateSystemBarColor(theme: Theme) {
    try {
      if (!this.context) {
        return;
      }
      
      const isDarkTheme = theme.id !== 'light';
      
      window.getLastWindow(this.context).then((windowClass) => {
        const systemBarProperties: window.SystemBarProperties = {
          statusBarContentColor: isDarkTheme ? '#FFFFFF' : '#000000',
          navigationBarContentColor: isDarkTheme ? '#FFFFFF' : '#000000',
          statusBarColor: '#00000000',
          navigationBarColor: '#00000000'
        };
        
        windowClass.setWindowSystemBarProperties(systemBarProperties);
      }).catch((err: Error) => {
        console.error('Failed to get window:', err.message);
      });
    } catch (error) {
      console.error('Failed to update system bar color:', JSON.stringify(error));
    }
  }

  /**
   * æ–°å»ºæ–‡ä»¶
   */
  private newFile() {
    if (this.isModified) {
      // æç¤ºä¿å­˜
      this.showConfirmDialog('æç¤º', 'å½“å‰æ–‡ä»¶æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ', (index: number) => {
        if (index === 0) {
          // ä¸ä¿å­˜ï¼Œç›´æ¥æ–°å»º
          this.resetEditor();
        } else if (index === 1) {
          // å…ˆä¿å­˜å†æ–°å»º
          this.saveFileAs().then(() => {
            this.resetEditor();
          });
        }
        // index === 2 å–æ¶ˆï¼Œä¸åšä»»ä½•æ“ä½œ
      });
    } else {
      this.resetEditor();
    }
  }

  /**
   * é‡ç½®ç¼–è¾‘å™¨ä¸ºç©ºç™½çŠ¶æ€
   */
  private resetEditor() {
    this.content = '';
    this.fileName = 'æœªå‘½å';
    this.filePath = '';
    this.isModified = false;
    this.language = 'text';
  }

  /**
   * æ‰“å¼€æ–‡ä»¶
   */
  private async openFile() {
    try {
      if (!this.context) {
        this.showToast('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        return;
      }

      const documentPicker = new picker.DocumentViewPicker(this.context);
      const result = await documentPicker.select({
        maxSelectNumber: 1
      });
      
      if (!result || result.length === 0) {
        return;
      }
      
      const fileUri = result[0];
      
      // è¯»å–æ–‡ä»¶å†…å®¹
      const file = fileIo.openSync(fileUri, fileIo.OpenMode.READ_ONLY);
      const stat = fileIo.statSync(file.fd);
      const arrayBuffer = new ArrayBuffer(stat.size);
      const readLen = fileIo.readSync(file.fd, arrayBuffer);
      fileIo.closeSync(file);

      // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
      const textDecoder = util.TextDecoder.create('utf-8', { ignoreBOM: true });
      const fileContent = textDecoder.decodeToString(new Uint8Array(arrayBuffer.slice(0, readLen)));

      // ä» URI æå–æ–‡ä»¶å
      const extractedFileName = this.extractFileName(fileUri);
      
      // æ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€
      this.content = fileContent;
      this.fileName = extractedFileName;
      this.filePath = fileUri;
      this.isModified = false;
      this.language = this.getLanguageFromFileName(extractedFileName);
      this.lineCount = fileContent.split('\n').length;

      this.showToast('æ–‡ä»¶å·²æ‰“å¼€');
    } catch (err) {
      const error = err as Error;
      console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error.message);
      this.showToast(`æ‰“å¼€å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä¿å­˜æ–‡ä»¶ï¼ˆå¦‚æœå·²æœ‰è·¯å¾„åˆ™ç›´æ¥ä¿å­˜ï¼Œå¦åˆ™å¦å­˜ä¸ºï¼‰
   */
  private async saveFile() {
    if (this.filePath) {
      // åˆ¤æ–­æ˜¯å†…éƒ¨æ–‡ä»¶è¿˜æ˜¯å¤–éƒ¨æ–‡ä»¶
      if (this.filePath.startsWith(this.fileManager.getCodesDir())) {
        // å†…éƒ¨æ–‡ä»¶ï¼Œç›´æ¥ä¿å­˜
        try {
          this.fileManager.writeFile(this.filePath, this.content);
          this.isModified = false;
          this.saveCurrentTabState();
          this.showToast('ä¿å­˜æˆåŠŸ');
          this.loadInternalFiles();
        } catch (e) {
          this.showToast('ä¿å­˜å¤±è´¥');
        }
      } else {
        // å¤–éƒ¨æ–‡ä»¶ï¼Œä½¿ç”¨åŸæœ‰æ–¹æ³•
        await this.saveToPath(this.filePath);
      }
    } else {
      await this.saveFileAs();
    }
  }

  /**
   * å¦å­˜ä¸ºï¼ˆè°ƒç”¨ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹©ä¿å­˜ä½ç½®ï¼‰
   */
  private async saveFileAs() {
    try {
      if (!this.context) {
        this.showToast('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        return;
      }

      const documentPicker = new picker.DocumentViewPicker(this.context);
      
      // è·å–å½“å‰æ–‡ä»¶åç¼€å¯¹åº”çš„æ–‡ä»¶ç±»å‹
      const currentSuffix = this.getCurrentFileSuffix();
      
      const result = await documentPicker.save({
        newFileNames: [this.fileName === 'æœªå‘½å' ? `æ–°æ–‡ä»¶${currentSuffix}` : this.fileName],
      });
      
      if (!result || result.length === 0) {
        return;
      }
      
      const saveUri = result[0];
      await this.saveToPath(saveUri);
      
      // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
      this.filePath = saveUri;
      this.fileName = this.extractFileName(saveUri);
      this.language = this.getLanguageFromFileName(this.fileName);
      
    } catch (err) {
      const error = err as Error;
      console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error.message);
      this.showToast(`ä¿å­˜å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„
   */
  private async saveToPath(uri: string) {
    try {
      // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º Uint8Array
      const textEncoder = util.TextEncoder.create();
      const buffer = textEncoder.encodeInto(this.content);

      // å†™å…¥æ–‡ä»¶
      const file = fileIo.openSync(uri, fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.CREATE | fileIo.OpenMode.TRUNC);
      fileIo.writeSync(file.fd, buffer.buffer);
      fileIo.closeSync(file);

      this.isModified = false;
      this.showToast('ä¿å­˜æˆåŠŸ');
    } catch (err) {
      const error = err as Error;
      throw new Error(`å†™å…¥æ–‡ä»¶å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * ä» URI æå–æ–‡ä»¶åï¼ˆè§£ç  URL ç¼–ç çš„ä¸­æ–‡ï¼‰
   */
  private extractFileName(uri: string): string {
    const parts = uri.split('/');
    const encodedName = parts[parts.length - 1] || 'æœªå‘½å';
    try {
      // è§£ç  URL ç¼–ç çš„æ–‡ä»¶åï¼ˆå¦‚ %E4%B8%AD%E6%96%87 -> ä¸­æ–‡ï¼‰
      return decodeURIComponent(encodedName);
    } catch (e) {
      return encodedName;
    }
  }

  /**
   * è·å–å½“å‰æ–‡ä»¶åç¼€
   */
  private getCurrentFileSuffix(): string {
    if (this.fileName.includes('.')) {
      return '.' + this.fileName.split('.').pop();
    }
    return '.txt';
  }

  /**
   * ä»æ–‡ä»¶åè·å–è¯­è¨€ç±»å‹
   */
  private getLanguageFromFileName(fileName: string): string {
    const ext = fileName.split('.').pop()?.toLowerCase() || '';
    const languageMap: Record<string, string> = {
      'js': 'javascript',
      'ts': 'typescript',
      'ets': 'typescript',
      'py': 'python',
      'java': 'java',
      'cpp': 'cpp',
      'c': 'c',
      'go': 'go',
      'rs': 'rust',
      'md': 'markdown',
      'html': 'html',
      'css': 'css',
      'scss': 'scss',
      'json': 'json',
      'xml': 'xml',
      'yaml': 'yaml',
      'yml': 'yaml',
      'txt': 'text'
    };
    return languageMap[ext] || 'text';
  }

  /**
   * åˆ‡æ¢ä¸»é¢˜ï¼ˆå¸¦åŠ¨ç”»ï¼‰
   */
  private cycleTheme() {
    animateTo({ 
      duration: 300, 
      curve: Curve.EaseInOut 
    }, () => {
      const nextTheme = this.themeService.getNextTheme();
      this.themeService.switchTheme(nextTheme.id);
      this.themeService.saveThemePreference(nextTheme.id);
    });
  }

  /**
   * å†…å®¹å˜åŒ–æ—¶çš„å¤„ç†
   */
  private onContentChange(newContent: string) {
    this.content = newContent;
    this.isModified = true;
    // æ›´æ–°è¡Œæ•°
    this.lineCount = newContent.split('\n').length;
  }

  /**
   * è·å–ä»£ç è¡Œæ•°ç»„
   */
  private getCodeLines(): string[] {
    return this.content.split('\n');
  }

  /**
   * è·å– token å¯¹åº”çš„é¢œè‰²
   */
  private getTokenColor(type: string): string {
    const colorMap: Record<string, string> = {
      'keyword': this.currentTheme.syntax.keyword,
      'string': this.currentTheme.syntax.string,
      'comment': this.currentTheme.syntax.comment,
      'number': this.currentTheme.syntax.number,
      'function': this.currentTheme.syntax.function,
      'variable': this.currentTheme.syntax.variable,
      'operator': this.currentTheme.syntax.operator,
      'bracket': this.currentTheme.editor.text,
      'type': this.currentTheme.syntax.type,
      'text': this.currentTheme.editor.text
    };
    return colorMap[type] || this.currentTheme.editor.text;
  }

  /**
   * ç”Ÿæˆè¡Œå·æ•°ç»„
   */
  private getLineNumbers(): number[] {
    const lines: number[] = [];
    for (let i = 1; i <= this.lineCount; i++) {
      lines.push(i);
    }
    return lines;
  }

  /**
   * è·å–æ¯è¡Œçš„ç¼©è¿›çº§åˆ«ï¼ˆä»¥2ä¸ªç©ºæ ¼ä¸ºä¸€çº§ï¼‰
   */
  private getLineIndentLevels(): number[] {
    const lines = this.content.split('\n');
    const indentLevels: number[] = [];
    
    for (const line of lines) {
      let spaces = 0;
      for (const char of line) {
        if (char === ' ') {
          spaces++;
        } else if (char === '\t') {
          spaces += 2; // tab ç®— 2 ä¸ªç©ºæ ¼
        } else {
          break;
        }
      }
      // æ¯ 2 ä¸ªç©ºæ ¼ç®—ä¸€çº§ç¼©è¿›
      indentLevels.push(Math.floor(spaces / 2));
    }
    
    return indentLevels;
  }

  /**
   * è·å–æœ€å¤§ç¼©è¿›çº§åˆ«
   */
  private getMaxIndentLevel(): number {
    const levels = this.getLineIndentLevels();
    return Math.max(...levels, 0);
  }

  build() {
    Column() {
      // çŠ¶æ€æ å ä½åŒºåŸŸ
      Row()
        .width('100%')
        .height(this.topRectHeight > 0 ? this.topRectHeight / 3 : 0)
        .backgroundColor(this.currentTheme.colors.surface)

      // é¡¶éƒ¨å·¥å…·æ 
      this.buildToolbar()

      // ä¸»å†…å®¹åŒºåŸŸ
      Row() {
        // æ–‡ä»¶æµè§ˆå™¨ä¾§è¾¹æ ï¼ˆå¸¦ä¼¸ç¼©åŠ¨ç”»ï¼‰
        FileBrowser({
          files: this.internalFiles,
          currentFilePath: this.filePath,
          workspacePath: this.fileManager.getWorkspacePath(),
          bgColor: this.currentTheme.colors.surface,
          textColor: this.currentTheme.colors.text,
          fileBorderColor: this.currentTheme.colors.border,
          activeFileBgColor: this.currentTheme.editor.background,
          onFileClick: (file: FileItem) => {
            this.openInternalFile(file);
          },
          onNewFile: () => {
            this.createInternalFile();
          },
          onDeleteFile: (file: FileItem) => {
            this.deleteInternalFile(file);
          }
        })
          .width(this.sidebarWidth)
          .opacity(this.sidebarWidth > 0 ? 1 : 0)
          .clip(true)
          .animation({ 
            duration: 350, 
            curve: this.springCurve 
          })

        // ç¼–è¾‘åŒºåŸŸ
        Column() {
          // æ ‡ç­¾æ ï¼ˆå·¦å¯¹é½ï¼Œå¸¦åŠ¨ç”»ï¼‰
          Row() {
            TabBar({
              tabs: this.tabs,
              currentTabId: this.currentTabId,
              bgColor: this.currentTheme.colors.surface,
              textColor: this.currentTheme.colors.text,
              tabBorderColor: this.currentTheme.colors.border,
              activeTabBgColor: this.currentTheme.editor.background,
              onTabClick: (tabId: string) => {
                this.switchToTab(tabId);
              },
              onTabClose: (tabId: string) => {
                this.closeTab(tabId);
              }
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.Start)
          .animation({ 
            duration: 350, 
            curve: this.springCurve 
          })
          
          // æ–‡ä»¶ä¿¡æ¯æ 
          this.buildFileInfoBar()
          
          // æœç´¢æ›¿æ¢æ 
          if (this.showSearchBar) {
            this.buildSearchBar()
          }
          
          // ç¼–è¾‘å™¨ä¸»ä½“
          this.buildEditor()
        }
        .layoutWeight(1)
        .backgroundColor(this.currentTheme.editor.background)
        .scale({ x: this.editorScale, y: this.editorScale })
        .animation({ 
          duration: 300, 
          curve: this.springCurve 
        })
      }
      .layoutWeight(1)
      .width('100%')

      // åº•éƒ¨å¯¼èˆªæ å ä½åŒºåŸŸ
      Row()
        .width('100%')
        .height(this.bottomRectHeight > 0 ? this.bottomRectHeight / 3 : 0)
        .backgroundColor(this.currentTheme.editor.background)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.currentTheme.colors.background)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  buildToolbar(): void {
    Row() {
      // å·¦ä¾§ï¼šæ ‡é¢˜
      Column() {
        Text(this.fileName + (this.isModified ? ' â€¢' : ''))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTheme.colors.text)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // å³ä¾§ï¼šæ“ä½œæŒ‰é’®
      Row({ space: 8 }) {
        // æ–‡ä»¶æµè§ˆå™¨åˆ‡æ¢
        IconButton({
          icon: 'ğŸ“‚',
          text: 'æ–‡ä»¶',
          isActive: this.showFileBrowser,
          bgColor: this.currentTheme.colors.surface,
          activeColor: this.currentTheme.colors.primary,
          textColor: this.currentTheme.colors.text,
          btnSize: 32,
          fontSize: 13,
          onButtonClick: () => {
            this.toggleFileBrowser();
          }
        })
        
        // æ–°å»ºæ ‡ç­¾
        IconButton({
          icon: 'â•',
          text: 'æ–°æ ‡ç­¾',
          bgColor: this.currentTheme.colors.surface,
          textColor: this.currentTheme.colors.text,
          btnSize: 32,
          fontSize: 13,
          onButtonClick: () => {
            this.createNewTab();
          }
        })
        
        // æ ¼å¼åŒ–æŒ‰é’®
        IconButton({
          icon: 'âœ¨',
          text: 'æ ¼å¼åŒ–',
          bgColor: this.currentTheme.colors.surface,
          textColor: this.currentTheme.colors.text,
          btnSize: 32,
          fontSize: 13,
          onButtonClick: () => {
            this.formatCode();
          }
        })
        
        // æœç´¢æŒ‰é’®
        IconButton({
          icon: 'ğŸ”',
          text: 'æœç´¢',
          isActive: this.showSearchBar,
          bgColor: this.currentTheme.colors.surface,
          activeColor: this.currentTheme.colors.primary,
          textColor: this.currentTheme.colors.text,
          btnSize: 32,
          fontSize: 13,
          onButtonClick: () => {
            animateTo({ 
              duration: 250, 
              curve: Curve.EaseInOut 
            }, () => {
              this.showSearchBar = !this.showSearchBar;
            });
          }
        })
        
        // ç¼–è¾‘/é¢„è§ˆåˆ‡æ¢
        IconButton({
          icon: this.isPreviewMode ? 'âœï¸' : 'ğŸ‘ï¸',
          text: this.isPreviewMode ? 'ç¼–è¾‘' : 'é¢„è§ˆ',
          isActive: this.isPreviewMode,
          bgColor: this.currentTheme.colors.surface,
          activeColor: this.currentTheme.colors.primary,
          textColor: this.currentTheme.colors.text,
          btnSize: 32,
          fontSize: 13,
          onButtonClick: () => {
            animateTo({ 
              duration: 300, 
              curve: this.springCurve 
            }, () => {
              this.isPreviewMode = !this.isPreviewMode;
              this.editorScale = this.isPreviewMode ? 0.98 : 1;
            });
            setTimeout(() => {
              animateTo({ duration: 200 }, () => {
                this.editorScale = 1;
              });
            }, 100);
          }
        })

        // ä¸»é¢˜åˆ‡æ¢
        IconButton({
          icon: 'ğŸ¨',
          text: 'ä¸»é¢˜',
          bgColor: this.currentTheme.colors.surface,
          textColor: this.currentTheme.colors.text,
          btnSize: 32,
          fontSize: 13,
          onButtonClick: () => {
            this.cycleTheme();
          }
        })

        // æ‰“å¼€å¤–éƒ¨æ–‡ä»¶
        IconButton({
          icon: 'ğŸ“',
          text: 'æ‰“å¼€',
          bgColor: this.currentTheme.colors.surface,
          textColor: this.currentTheme.colors.text,
          btnSize: 32,
          fontSize: 13,
          onButtonClick: () => {
            this.openFile();
          }
        })

        // ä¿å­˜æ–‡ä»¶
        IconButton({
          icon: 'ğŸ’¾',
          text: 'ä¿å­˜',
          isActive: this.isModified,
          bgColor: this.currentTheme.colors.surface,
          activeColor: this.currentTheme.colors.primary,
          textColor: this.currentTheme.colors.text,
          btnSize: 32,
          fontSize: 13,
          onButtonClick: () => {
            this.saveFile();
          }
        })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 12, right: 12 })
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildFileInfoBar(): void {
    Row() {
      // æ–‡ä»¶ç±»å‹æ ‡è¯†
      Text(this.language.toUpperCase())
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
        .padding({ left: 8, right: 8, top: 2, bottom: 2 })
        .backgroundColor(this.currentTheme.colors.background)
        .borderRadius(4)

      Blank()

      // å­—ç¬¦æ•°ç»Ÿè®¡
      Text(`${this.content.length} å­—ç¬¦`)
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
      
      Text(' | ')
        .fontSize(11)
        .fontColor(this.currentTheme.colors.border)
      
      // è¡Œæ•°ç»Ÿè®¡
      Text(`${this.lineCount} è¡Œ`)
        .fontSize(11)
        .fontColor(this.currentTheme.colors.textSecondary)
    }
    .width('100%')
    .height(28)
    .padding({ left: 12, right: 12 })
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
  }

  @Builder
  buildSearchBar(): void {
    Column() {
      // æœç´¢è¡Œ
      Row({ space: 8 }) {
        TextInput({ placeholder: 'æœç´¢', text: this.searchText })
          .layoutWeight(1)
          .height(36)
          .fontSize(14)
          .backgroundColor(this.currentTheme.editor.background)
          .fontColor(this.currentTheme.colors.text)
          .placeholderColor(this.currentTheme.colors.textSecondary)
          .onChange((value: string) => {
            this.searchText = value;
          })
          .onSubmit(() => {
            this.performSearch();
          })
        
        Button('æœç´¢')
          .height(36)
          .fontSize(13)
          .backgroundColor(this.currentTheme.colors.primary)
          .fontColor(Color.White)
          .stateEffect(true)
          .onClick(() => {
            this.performSearch();
          })
        
        Button('ä¸Šä¸€ä¸ª')
          .height(36)
          .fontSize(13)
          .backgroundColor(this.currentTheme.editor.background)
          .fontColor(this.currentTheme.colors.text)
          .stateEffect(true)
          .onClick(() => {
            this.prevSearchResult();
          })
        
        Button('ä¸‹ä¸€ä¸ª')
          .height(36)
          .fontSize(13)
          .backgroundColor(this.currentTheme.editor.background)
          .fontColor(this.currentTheme.colors.text)
          .stateEffect(true)
          .onClick(() => {
            this.nextSearchResult();
          })
        
        Button('å…³é—­')
          .height(36)
          .fontSize(13)
          .backgroundColor(Color.Transparent)
          .fontColor(this.currentTheme.colors.text)
          .stateEffect(true)
          .onClick(() => {
            this.showSearchBar = false;
            this.searchResults = [];
          })
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 8 })
      
      // æ›¿æ¢è¡Œ
      Row({ space: 8 }) {
        TextInput({ placeholder: 'æ›¿æ¢ä¸º', text: this.replaceText })
          .layoutWeight(1)
          .height(36)
          .fontSize(14)
          .backgroundColor(this.currentTheme.editor.background)
          .fontColor(this.currentTheme.colors.text)
          .placeholderColor(this.currentTheme.colors.textSecondary)
          .onChange((value: string) => {
            this.replaceText = value;
          })
        
        Button('æ›¿æ¢')
          .height(36)
          .fontSize(13)
          .backgroundColor(this.currentTheme.editor.background)
          .fontColor(this.currentTheme.colors.text)
          .stateEffect(true)
          .onClick(() => {
            this.replaceCurrent();
          })
        
        Button('å…¨éƒ¨æ›¿æ¢')
          .height(36)
          .fontSize(13)
          .backgroundColor(this.currentTheme.editor.background)
          .fontColor(this.currentTheme.colors.text)
          .stateEffect(true)
          .onClick(() => {
            this.replaceAll();
          })
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 4, bottom: 8 })
      
      // æœç´¢ç»“æœæç¤º
      if (this.searchResults.length > 0) {
        Text(`${this.currentSearchIndex + 1} / ${this.searchResults.length}`)
          .fontSize(12)
          .fontColor(this.currentTheme.colors.text)
          .width('100%')
          .textAlign(TextAlign.Center)
          .padding({ bottom: 4 })
      }
    }
    .width('100%')
    .backgroundColor(this.currentTheme.colors.surface)
    .border({ width: { bottom: 1 }, color: this.currentTheme.colors.border })
    .opacity(this.showSearchBar ? 1 : 0)
    .height(this.showSearchBar ? undefined : 0)
    .clip(true)
    .animation({ 
      duration: 250, 
      curve: Curve.EaseInOut 
    })
  }

  @Builder
  buildEditor(): void {
    if (this.isPreviewMode) {
      // é¢„è§ˆæ¨¡å¼ï¼šè¡Œå·å’Œä»£ç ä¸€èµ·æ»šåŠ¨
      Scroll(this.editorScroller) {
        Row() {
          // è¡Œå·åˆ—
          Column() {
            ForEach(this.getDisplayLineNumbers(), (lineNum: number) => {
              Text(`${lineNum}`)
                .fontSize(this.fontSize)
                .fontColor(this.currentTheme.editor.lineNumber)
                .fontFamily('monospace')
                .width(40)
                .height(this.fontSize + 8)
                .textAlign(TextAlign.End)
                .padding({ right: 8 })
                .opacity(lineNum <= this.lineCount ? 1.0 : 0.3)
            }, (lineNum: number) => `ln_${lineNum}`)
          }
          .alignItems(HorizontalAlign.End)
          .backgroundColor(this.currentTheme.editor.background)
          
          // åˆ†éš”çº¿
          Column()
            .width(1)
            .height('100%')
            .backgroundColor(this.currentTheme.colors.border)
          
          // ä»£ç åŒºåŸŸï¼ˆé«˜äº®ï¼‰
          Column() {
            ForEach(this.getCodeLines(), (line: string, lineIndex: number) => {
              Row() {
                Text() {
                  ForEach(this.syntaxService.tokenize(line, this.language), (token: Token, tokenIndex: number) => {
                    // å°†ç©ºæ ¼æ›¿æ¢ä¸ºä¸é—´æ–­ç©ºæ ¼ï¼Œé˜²æ­¢è¢«æŠ˜å 
                    Span(token.value.replace(/ /g, '\u00A0'))
                      .fontSize(this.fontSize)
                      .fontColor(this.getTokenColor(token.type))
                      .fontFamily('monospace')
                  }, (token: Token, tokenIndex: number) => `t_${lineIndex}_${tokenIndex}`)
                }
                .fontSize(this.fontSize)
                .fontFamily('monospace')
                .lineHeight(this.fontSize + 8)
                .textOverflow({ overflow: TextOverflow.Clip })
                .maxLines(1)
              }
              .width('100%')
              .height(this.fontSize + 8)
              .alignItems(VerticalAlign.Top)
            }, (line: string, lineIndex: number) => `line_${lineIndex}`)
          }
          .layoutWeight(1)
          .padding({ left: 8, right: 16 })
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ top: 12, bottom: 12 })
      .scrollBar(BarState.On)
      .scrollBarWidth(10)
      .scrollBarColor(this.currentTheme.colors.textSecondary)
      .backgroundColor(this.currentTheme.editor.background)
    } else {
      // ç¼–è¾‘æ¨¡å¼ï¼šä½¿ç”¨ Scroll åŒ…è£¹è¡Œå·å’Œ TextAreaï¼Œå®ç°åŒæ­¥æ»šåŠ¨
      Scroll(this.editorScroller) {
        Row() {
          // å·¦ä¾§è¡Œå·åŒºåŸŸ
          Column() {
            ForEach(this.getDisplayLineNumbers(), (lineNum: number) => {
              Text(`${lineNum}`)
                .fontSize(this.fontSize)
                .fontColor(this.currentTheme.editor.lineNumber)
                .fontFamily('monospace')
                .width(40)
                .height(this.fontSize + 8)
                .textAlign(TextAlign.End)
                .padding({ right: 8 })
                .opacity(lineNum <= this.lineCount ? 1.0 : 0.3)
            }, (lineNum: number) => `edit_ln_${lineNum}`)
          }
          .alignItems(HorizontalAlign.End)
          .backgroundColor(this.currentTheme.editor.background)
          
          // åˆ†éš”çº¿
          Column()
            .width(1)
            .height('100%')
            .backgroundColor(this.currentTheme.colors.border)
          
          // å³ä¾§ä»£ç ç¼–è¾‘åŒº
          Column() {
            TextArea({ text: this.content, placeholder: 'åœ¨æ­¤è¾“å…¥ä»£ç ...' })
              .width('100%')
              .constraintSize({ minHeight: this.getEditorMinHeight() })
              .fontSize(this.fontSize)
              .fontColor(this.currentTheme.editor.text)
              .caretColor(this.currentTheme.colors.primary)
              .placeholderColor(this.currentTheme.colors.textSecondary)
              .backgroundColor(Color.Transparent)
              .padding(0)
              .fontFamily('monospace')
              .lineHeight(this.fontSize + 8)
              .wordBreak(WordBreak.BREAK_ALL)
              .onChange((value: string) => {
                this.onContentChange(value);
              })
          }
          .layoutWeight(1)
          .padding({ left: 8, right: 16 })
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ top: 12, bottom: 12 })
      .scrollBar(BarState.On)
      .scrollBarWidth(10)
      .scrollBarColor(this.currentTheme.colors.textSecondary)
      .backgroundColor(this.currentTheme.editor.background)
    }
  }
  
  /**
   * è®¡ç®—ç¼–è¾‘å™¨æœ€å°é«˜åº¦ï¼Œç¡®ä¿è¡Œå·å’Œå†…å®¹å¯¹é½
   */
  private getEditorMinHeight(): number {
    const lineHeight = this.fontSize + 8;
    const minLines = Math.max(this.lineCount, 100);
    return minLines * lineHeight;
  }

  /**
   * è·å–æ˜¾ç¤ºçš„è¡Œå·
   * é¢„è§ˆæ¨¡å¼ï¼šåªæ˜¾ç¤ºå®é™…ä»£ç è¡Œæ•°
   * ç¼–è¾‘æ¨¡å¼ï¼šè‡³å°‘æ˜¾ç¤º100è¡Œï¼Œæ–¹ä¾¿ç¼–è¾‘
   */
  private getDisplayLineNumbers(): number[] {
    // ç›´æ¥æ ¹æ®å†…å®¹è®¡ç®—è¡Œæ•°ï¼Œä¸ä¾èµ– lineCount çŠ¶æ€
    const actualLines = this.content.split('\n').length;
    // é¢„è§ˆæ¨¡å¼åªæ˜¾ç¤ºå®é™…è¡Œæ•°ï¼Œç¼–è¾‘æ¨¡å¼è‡³å°‘æ˜¾ç¤º100è¡Œ
    const minLines = this.isPreviewMode ? actualLines : 100;
    const totalLines = Math.max(actualLines, minLines);
    const lines: number[] = [];
    for (let i = 1; i <= totalLines; i++) {
      lines.push(i);
    }
    return lines;
  }

  /**
   * æ˜¾ç¤º Toast æç¤ºï¼ˆå°è£…æ–° APIï¼‰
   */
  private showToast(message: string) {
    try {
      promptAction.showToast({ message: message });
    } catch (e) {
      console.error('showToast error:', JSON.stringify(e));
    }
  }

  /**
   * æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ˆå°è£…æ–° APIï¼‰
   */
  private showConfirmDialog(title: string, message: string, callback: (index: number) => void) {
    try {
      promptAction.showDialog({
        title: title,
        message: message,
        buttons: [
          { text: 'ä¸ä¿å­˜', color: this.currentTheme.colors.textSecondary },
          { text: 'ä¿å­˜', color: this.currentTheme.colors.primary },
          { text: 'å–æ¶ˆ', color: this.currentTheme.colors.textSecondary }
        ]
      }).then((result) => {
        callback(result.index);
      }).catch((err: Error) => {
        console.error('showDialog error:', err.message);
      });
    } catch (e) {
      console.error('showConfirmDialog error:', JSON.stringify(e));
    }
  }

  /**
   * æœç´¢æ–‡æœ¬
   */
  private performSearch() {
    if (!this.searchText) {
      this.searchResults = [];
      this.currentSearchIndex = -1;
      return;
    }
    
    const results: number[] = [];
    const searchLower = this.searchText.toLowerCase();
    const contentLower = this.content.toLowerCase();
    
    let index = contentLower.indexOf(searchLower);
    while (index !== -1) {
      results.push(index);
      index = contentLower.indexOf(searchLower, index + 1);
    }
    
    this.searchResults = results;
    this.currentSearchIndex = results.length > 0 ? 0 : -1;
    
    if (results.length > 0) {
      this.showToast(`æ‰¾åˆ° ${results.length} ä¸ªåŒ¹é…é¡¹`);
    } else {
      this.showToast('æœªæ‰¾åˆ°åŒ¹é…é¡¹');
    }
  }
  
  /**
   * è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæœç´¢ç»“æœ
   */
  private nextSearchResult() {
    if (this.searchResults.length === 0) return;
    this.currentSearchIndex = (this.currentSearchIndex + 1) % this.searchResults.length;
  }
  
  /**
   * è·³è½¬åˆ°ä¸Šä¸€ä¸ªæœç´¢ç»“æœ
   */
  private prevSearchResult() {
    if (this.searchResults.length === 0) return;
    this.currentSearchIndex = (this.currentSearchIndex - 1 + this.searchResults.length) % this.searchResults.length;
  }
  
  /**
   * æ›¿æ¢å½“å‰åŒ¹é…é¡¹
   */
  private replaceCurrent() {
    if (this.currentSearchIndex === -1 || this.searchResults.length === 0) return;
    
    const pos = this.searchResults[this.currentSearchIndex];
    const before = this.content.substring(0, pos);
    const after = this.content.substring(pos + this.searchText.length);
    
    this.content = before + this.replaceText + after;
    this.isModified = true;
    this.lineCount = this.content.split('\n').length;
    
    // é‡æ–°æœç´¢
    this.performSearch();
  }
  
  /**
   * æ›¿æ¢æ‰€æœ‰åŒ¹é…é¡¹
   */
  private replaceAll() {
    if (this.searchResults.length === 0) return;
    
    const regex = new RegExp(this.searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    this.content = this.content.replace(regex, this.replaceText);
    this.isModified = true;
    this.lineCount = this.content.split('\n').length;
    
    this.showToast(`å·²æ›¿æ¢ ${this.searchResults.length} å¤„`);
    this.searchResults = [];
    this.currentSearchIndex = -1;
  }
  
  /**
   * æ ¼å¼åŒ–ä»£ç 
   */
  private formatCode() {
    try {
      const formatted = this.formatterService.format(this.content, this.language);
      this.content = formatted;
      this.isModified = true;
      this.lineCount = this.content.split('\n').length;
      this.showToast('ä»£ç å·²æ ¼å¼åŒ–');
    } catch (e) {
      this.showToast('æ ¼å¼åŒ–å¤±è´¥');
      console.error('æ ¼å¼åŒ–é”™è¯¯:', JSON.stringify(e));
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µï¼ˆå°è£…æ–° APIï¼‰
   */
  private goBack() {
    try {
      router.back();
    } catch (e) {
      console.error('router.back error:', JSON.stringify(e));
    }
  }

  /**
   * åŠ è½½åº”ç”¨å†…éƒ¨æ–‡ä»¶åˆ—è¡¨
   */
  private loadInternalFiles() {
    try {
      this.internalFiles = this.fileManager.listFiles();
    } catch (e) {
      console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', JSON.stringify(e));
    }
  }

  /**
   * åˆ›å»ºæ–°æ ‡ç­¾
   */
  private createNewTab() {
    const newTab = new FileTab(
      FileTab.generateId(),
      'æœªå‘½å.txt',
      '',
      '',
      'text'
    );
    this.tabs.push(newTab);
    this.switchToTab(newTab.id);
  }

  /**
   * åˆ‡æ¢åˆ°æŒ‡å®šæ ‡ç­¾
   */
  private switchToTab(tabId: string) {
    // ä¿å­˜å½“å‰æ ‡ç­¾å†…å®¹
    this.saveCurrentTabState();
    
    // åˆ‡æ¢æ ‡ç­¾
    this.currentTabId = tabId;
    const tab = this.tabs.find(t => t.id === tabId);
    if (tab) {
      this.content = tab.content;
      this.fileName = tab.fileName;
      this.filePath = tab.filePath;
      this.isModified = tab.isModified;
      this.language = tab.language;
      this.lineCount = tab.content.split('\n').length;
    }
  }

  /**
   * ä¿å­˜å½“å‰æ ‡ç­¾çŠ¶æ€
   */
  private saveCurrentTabState() {
    const currentTab = this.tabs.find(t => t.id === this.currentTabId);
    if (currentTab) {
      currentTab.content = this.content;
      currentTab.fileName = this.fileName;
      currentTab.filePath = this.filePath;
      currentTab.isModified = this.isModified;
      currentTab.language = this.language;
    }
  }

  /**
   * å…³é—­æ ‡ç­¾
   */
  private closeTab(tabId: string) {
    const tabIndex = this.tabs.findIndex(t => t.id === tabId);
    if (tabIndex === -1) return;
    
    const tab = this.tabs[tabIndex];
    
    if (tab.isModified) {
      this.showConfirmDialog('æç¤º', 'æ–‡ä»¶æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ', (index: number) => {
        if (index === 0) {
          // ä¸ä¿å­˜ï¼Œç›´æ¥å…³é—­
          this.removeTab(tabId, tabIndex);
        } else if (index === 1) {
          // ä¿å­˜åå…³é—­
          this.saveTabFile(tab).then(() => {
            this.removeTab(tabId, tabIndex);
          });
        }
      });
    } else {
      this.removeTab(tabId, tabIndex);
    }
  }

  /**
   * ç§»é™¤æ ‡ç­¾
   */
  private removeTab(tabId: string, tabIndex: number) {
    this.tabs.splice(tabIndex, 1);
    
    // å¦‚æœå…³é—­çš„æ˜¯å½“å‰æ ‡ç­¾ï¼Œåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾
    if (tabId === this.currentTabId) {
      if (this.tabs.length > 0) {
        const newIndex = Math.min(tabIndex, this.tabs.length - 1);
        this.switchToTab(this.tabs[newIndex].id);
      } else {
        // æ²¡æœ‰æ ‡ç­¾äº†ï¼Œåˆ›å»ºæ–°æ ‡ç­¾
        this.createNewTab();
      }
    }
  }

  /**
   * ä¿å­˜æ ‡ç­¾æ–‡ä»¶
   */
  private async saveTabFile(tab: FileTab): Promise<void> {
    if (tab.filePath && tab.filePath.startsWith(this.fileManager.getCodesDir())) {
      // å†…éƒ¨æ–‡ä»¶ï¼Œç›´æ¥ä¿å­˜
      try {
        this.fileManager.writeFile(tab.filePath, tab.content);
        tab.isModified = false;
        this.showToast('ä¿å­˜æˆåŠŸ');
      } catch (e) {
        this.showToast('ä¿å­˜å¤±è´¥');
      }
    } else {
      // å¤–éƒ¨æ–‡ä»¶æˆ–æ–°æ–‡ä»¶ï¼Œä½¿ç”¨ç³»ç»Ÿé€‰æ‹©å™¨
      await this.saveFileAs();
    }
  }

  /**
   * ä»æ–‡ä»¶æµè§ˆå™¨æ‰“å¼€æ–‡ä»¶
   */
  private openInternalFile(file: FileItem) {
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“å¼€
      const existingTab = this.tabs.find(t => t.filePath === file.path);
      if (existingTab) {
        this.switchToTab(existingTab.id);
        return;
      }
      
      // è¯»å–æ–‡ä»¶å†…å®¹
      const content = this.fileManager.readFile(file.path);
      const language = FileTab.getLanguageFromPath(file.path);
      
      // åˆ›å»ºæ–°æ ‡ç­¾
      const newTab = new FileTab(
        FileTab.generateId(),
        file.name,
        file.path,
        content,
        language
      );
      
      this.tabs.push(newTab);
      this.switchToTab(newTab.id);
      
    } catch (e) {
      this.showToast('æ‰“å¼€æ–‡ä»¶å¤±è´¥');
      console.error('æ‰“å¼€å†…éƒ¨æ–‡ä»¶å¤±è´¥:', JSON.stringify(e));
    }
  }

  /**
   * åˆ›å»ºæ–°çš„å†…éƒ¨æ–‡ä»¶
   */
  private createInternalFile() {
    // é‡æ–°åˆ›å»ºå¯¹è¯æ¡†æ§åˆ¶å™¨ä»¥ä½¿ç”¨æœ€æ–°çš„ä¸»é¢˜
    this.newFileDialogController = new CustomDialogController({
      builder: NewFileDialog({
        bgColor: this.currentTheme.colors.surface,
        textColor: this.currentTheme.colors.text,
        primaryColor: this.currentTheme.colors.primary,
        onConfirm: (fileName: string) => {
          this.handleCreateFile(fileName);
        }
      }),
      autoCancel: true,
      alignment: DialogAlignment.Center,
      customStyle: true
    });
    
    this.newFileDialogController.open();
  }

  /**
   * å¤„ç†åˆ›å»ºæ–‡ä»¶
   */
  private handleCreateFile(fileName: string) {
    try {
      const filePath = this.fileManager.createFile(fileName, '');
      this.loadInternalFiles();
      
      // æ‰“å¼€æ–°åˆ›å»ºçš„æ–‡ä»¶
      const file: FileItem = {
        name: fileName,
        path: filePath,
        isDirectory: false,
        size: 0,
        modifiedTime: Date.now()
      };
      this.openInternalFile(file);
      
      this.showToast('æ–‡ä»¶å·²åˆ›å»º');
    } catch (e) {
      this.showToast('åˆ›å»ºæ–‡ä»¶å¤±è´¥');
      console.error('åˆ›å»ºæ–‡ä»¶å¤±è´¥:', JSON.stringify(e));
    }
  }

  /**
   * åˆ é™¤å†…éƒ¨æ–‡ä»¶
   */
  private deleteInternalFile(file: FileItem) {
    promptAction.showDialog({
      title: 'ç¡®è®¤åˆ é™¤',
      message: `ç¡®å®šè¦åˆ é™¤ ${file.name} å—ï¼Ÿ`,
      buttons: [
        { text: 'å–æ¶ˆ', color: this.currentTheme.colors.textSecondary },
        { text: 'åˆ é™¤', color: '#FF4444' }
      ]
    }).then((result) => {
      if (result.index === 1) {
        try {
          this.fileManager.deleteFile(file.path);
          this.loadInternalFiles();
          
          // å¦‚æœæ–‡ä»¶åœ¨æ ‡ç­¾ä¸­æ‰“å¼€ï¼Œå…³é—­æ ‡ç­¾
          const tab = this.tabs.find(t => t.filePath === file.path);
          if (tab) {
            this.closeTab(tab.id);
          }
          
          this.showToast('æ–‡ä»¶å·²åˆ é™¤');
        } catch (e) {
          this.showToast('åˆ é™¤æ–‡ä»¶å¤±è´¥');
        }
      }
    });
  }

  /**
   * åˆ‡æ¢æ–‡ä»¶æµè§ˆå™¨æ˜¾ç¤º
   */
  private toggleFileBrowser() {
    animateTo({ 
      duration: 350, 
      curve: this.springCurve 
    }, () => {
      if (this.showFileBrowser) {
        // æ”¶èµ·ï¼šå®½åº¦å˜ä¸º0
        this.sidebarWidth = 0;
      } else {
        // å±•å¼€ï¼šå®½åº¦å˜ä¸º200
        this.sidebarWidth = 200;
      }
      this.showFileBrowser = !this.showFileBrowser;
    });
  }
}
