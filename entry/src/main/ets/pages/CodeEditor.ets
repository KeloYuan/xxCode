import { RealFileService } from '../services/RealFileService';
import { FileItem, EditorTab } from '../models/FileModel';
import { HighlightedText } from '../components/HighlightedText';
import { MarkdownPreview } from '../components/MarkdownPreview';
import { MarkdownService } from '../services/MarkdownService';
import { ThemeService, Theme } from '../services/ThemeService';
import { SearchDialog } from '../components/SearchDialog';
import { SearchResult } from '../services/SearchService';
import { common } from '@kit.AbilityKit';
import { window } from '@kit.ArkUI';

@Entry
@Component
struct CodeEditor {
  private fileService: RealFileService = new RealFileService();
  private context: common.UIAbilityContext | null = null;

  @State currentFile: string = '';
  @State isFileTreeVisible: boolean = true;
  @State files: FileItem[] = [];
  @State tabs: EditorTab[] = [];
  @State activeTab: EditorTab | null = null;
  @State editorContent: string = '';
  @State isLoading: boolean = false;
  @State expandedFolders: Set<string> = new Set();
  @State isPreviewMode: boolean = false;
  @State isMarkdownFile: boolean = false;
  @State showSearchDialog: boolean = false;

  private highlightedTextRef: HighlightedText | null = null;
  private markdownService: MarkdownService = new MarkdownService();
  private themeService: ThemeService = new ThemeService();

  @State currentTheme: Theme = this.themeService.getCurrentTheme();

  aboutToAppear() {
    // è·å–UIAbilityçš„context
    this.context = getContext(this) as common.UIAbilityContext;
    this.fileService.setContext(this.context);

    this.setupThemeListener();
    this.loadSavedTheme();
    this.initializeWelcomePage();
  }

  aboutToDisappear() {
    this.cleanupThemeListener();
  }

  private setupThemeListener() {
    this.themeService.onThemeChange((theme: Theme) => {
      this.currentTheme = theme;
    });
  }

  private cleanupThemeListener() {
    // ç§»é™¤ä¸»é¢˜å˜åŒ–ç›‘å¬å™¨ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
  }

  private async loadSavedTheme() {
    try {
      const savedThemeId = await this.themeService.loadThemePreference();
      if (savedThemeId) {
        this.themeService.switchTheme(savedThemeId);
      }
    } catch (error) {
      console.error('åŠ è½½ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
    }
  }

  private getHighlightedTextRef() {
    // åœ¨ArkTSä¸­ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡IDè·å–ç»„ä»¶å¼•ç”¨
    // è¿™é‡Œæš‚æ—¶æ³¨é‡Šæ‰ï¼Œåç»­å¯ä»¥æ ¹æ®éœ€è¦å®ç°
    // this.highlightedTextRef = this.findComponentById('highlightedText') as HighlightedText;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å·¥å…·æ 
        this.buildToolbar()

        // æ ‡ç­¾é¡µåŒºåŸŸ
        if (this.tabs.length > 0) {
          this.buildTabBar()
        }

        // ä¸»å†…å®¹åŒºåŸŸ
        Row() {
          // å·¦ä¾§æ–‡ä»¶æ ‘
          if (this.isFileTreeVisible) {
            this.buildFileTree()
          }

          // ç¼–è¾‘å™¨åŒºåŸŸ
          this.buildEditorArea()
        }
        .layoutWeight(1)
      }
      .height('100%')
      .width('100%')
      .backgroundColor(Color.White)

      // æœç´¢å¯¹è¯æ¡†
      if (this.showSearchDialog) {
        SearchDialog({
          visible: this.showSearchDialog,
          onClose: () => {
            this.showSearchDialog = false;
          },
          onResultSelect: (result: SearchResult) => {
            this.handleSearchResult(result);
          }
        })
      }
    }
    .height('100%')
    .width('100%')
  }

  private initializeWelcomePage(): void {
    // åˆå§‹åŒ–æ¬¢è¿é¡µé¢ï¼Œä¸åŠ è½½ä»»ä½•æ–‡ä»¶
    this.files = [];
    this.tabs = [];
    this.isLoading = false;
  }

  @Builder
  buildToolbar() {
    Row() {
      // æ‰“å¼€æ–‡ä»¶æŒ‰é’® - ä½¿ç”¨é¸¿è’™é£æ ¼
      Button({ type: ButtonType.Normal, stateEffect: true }) {
        Row() {
          Text('ğŸ“').fontSize(16).margin({ right: 4 })
          Text('æ‰“å¼€æ–‡ä»¶').fontSize(14)
        }
      }
      .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
      .borderRadius(8)
      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
      .onClick(() => {
        this.openFileDialog();
      })

      Blank().width(8)

      // ä¿å­˜æ–‡ä»¶æŒ‰é’®
      Button({ type: ButtonType.Normal, stateEffect: true }) {
        Row() {
          Text('ğŸ’¾').fontSize(16).margin({ right: 4 })
          Text('ä¿å­˜').fontSize(14)
        }
      }
      .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
      .borderRadius(8)
      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
      .enabled(!!this.activeTab)
      .onClick(() => {
        this.saveCurrentFile();
      })

      Blank().width(8)

      // æ–°å»ºæ–‡ä»¶æŒ‰é’®
      Button({ type: ButtonType.Normal, stateEffect: true }) {
        Row() {
          Text('ğŸ“„').fontSize(16).margin({ right: 4 })
          Text('æ–°å»º').fontSize(14)
        }
      }
      .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
      .borderRadius(8)
      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
      .onClick(() => {
        this.createNewFileDialog();
      })

      // é¢„è§ˆæ¨¡å¼åˆ‡æ¢ï¼ˆä»…å¯¹Markdownæ–‡ä»¶æ˜¾ç¤ºï¼‰
      if (this.isMarkdownFile) {
        Blank().width(8)
        Button({ type: ButtonType.Normal, stateEffect: true }) {
          Text(this.isPreviewMode ? 'ç¼–è¾‘' : 'é¢„è§ˆ').fontSize(14)
        }
        .backgroundColor(this.isPreviewMode ? $r('sys.color.ohos_id_color_emphasize') : $r('sys.color.ohos_id_color_button_normal'))
        .fontColor(this.isPreviewMode ? Color.White : $r('sys.color.ohos_id_color_text_primary'))
        .borderRadius(8)
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .onClick(() => {
          this.togglePreviewMode();
        })
      }

      // å ä½ç¬¦ï¼Œæ¨é€å³ä¾§å†…å®¹
      Blank().layoutWeight(1)

      // å³ä¾§åŠŸèƒ½æŒ‰é’®åŒºåŸŸ
      Row() {
        // æœç´¢æŒ‰é’®
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('ğŸ”').fontSize(16)
        }
        .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
        .width(36)
        .height(36)
        .onClick(() => {
          this.showSearchDialog = true;
        })

        Blank().width(8)

        // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('ğŸ¨').fontSize(16)
        }
        .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
        .width(36)
        .height(36)
        .onClick(() => {
          this.showThemeMenu();
        })

        Blank().width(8)

        // æ–‡ä»¶æ ‘åˆ‡æ¢æŒ‰é’®
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text(this.isFileTreeVisible ? 'ğŸ“‹' : 'ğŸ“‚').fontSize(16)
        }
        .backgroundColor(this.isFileTreeVisible ? $r('sys.color.ohos_id_color_emphasize') : $r('sys.color.ohos_id_color_button_normal'))
        .fontColor(this.isFileTreeVisible ? Color.White : $r('sys.color.ohos_id_color_text_primary'))
        .width(36)
        .height(36)
        .onClick(() => {
          this.isFileTreeVisible = !this.isFileTreeVisible;
        })
      }
    }
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor($r('sys.color.ohos_id_color_background'))
    .border({ width: { bottom: 0.5 }, color: $r('sys.color.ohos_id_color_list_separator') })
  }

  // æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†
  async openFileDialog() {
    try {
      const filePaths = await this.fileService.openFilePicker();
      if (filePaths.length > 0) {
        for (const filePath of filePaths) {
          await this.openRealFile(filePath);
        }
      }
    } catch (error) {
      console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error);
    }
  }

  // æ–°å»ºæ–‡ä»¶å¯¹è¯æ¡†
  async createNewFileDialog() {
    try {
      const filePath = await this.fileService.saveFilePicker('untitled.txt');
      if (filePath) {
        const success = await this.fileService.createFile(filePath, '');
        if (success) {
          await this.openRealFile(filePath);
        }
      }
    } catch (error) {
      console.error('åˆ›å»ºæ–‡ä»¶å¤±è´¥:', error);
    }
  }

  // æ‰“å¼€çœŸå®æ–‡ä»¶
  async openRealFile(filePath: string) {
    try {
      const tab = this.fileService.openFileInTab(filePath);
      const content = await this.fileService.readFileContent(filePath);

      tab.content = content;
      this.fileService.updateTabContent(tab.id, content);

      this.tabs = this.fileService.getTabs();
      this.activeTab = this.fileService.getActiveTab();
      this.editorContent = content;

      // æ£€æŸ¥æ˜¯å¦ä¸ºMarkdownæ–‡ä»¶
      this.isMarkdownFile = this.checkIsMarkdownFile(tab.fileName);
      this.isPreviewMode = this.isMarkdownFile;

    } catch (error) {
      console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error);
    }
  }

  async saveCurrentFile() {
    if (!this.activeTab) return;

    try {
      const success = await this.fileService.writeFileContent(
        this.activeTab.filePath,
        this.editorContent
      );
      if (success) {
        this.fileService.markTabSaved(this.activeTab.id);
        this.activeTab.isModified = false;
        console.log('æ–‡ä»¶ä¿å­˜æˆåŠŸ');
      }
    } catch (error) {
      console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
    }
  }

  getStatusText(): string {
    if (!this.activeTab) return 'æœªé€‰æ‹©æ–‡ä»¶';
    return `ç¬¬ 1 è¡Œï¼Œ${this.editorContent.length} å­—ç¬¦`;
  }

  @Builder
  buildTabBar() {
    Scroll() {
      Row() {
        ForEach(this.tabs, (tab: EditorTab) => {
          Row() {
            // æ–‡ä»¶åå’Œä¿®æ”¹çŠ¶æ€
            Row() {
              Text(tab.fileName)
                .fontSize(12)
                .fontColor(tab.isActive ? Color.White : Color.Black)
                .layoutWeight(1)

              // ä¿®æ”¹çŠ¶æ€æŒ‡ç¤ºå™¨
              if (tab.isModified) {
                Text('â€¢')
                  .fontSize(14)
                  .fontColor(tab.isActive ? Color.White : Color.Orange)
                  .margin({ left: 4 })
              }
            }
            .padding(8)
            .backgroundColor(tab.isActive ? Color.Blue : Color.White)
            .borderRadius(4)
            .onClick(() => {
              this.switchToTab(tab.id);
            })

            // å…³é—­æŒ‰é’®
            Button('Ã—')
              .fontSize(12)
              .width(24)
              .height(24)
              .backgroundColor(Color.Transparent)
              .fontColor(tab.isActive ? Color.White : Color.Gray)
              .margin({ left: 2 })
              .onClick(() => {
                this.closeTab(tab.id);
              })
          }
          .margin({ right: 4 })
          .borderRadius(4)
          .backgroundColor(tab.isActive ? Color.Blue : Color.White)
        })
      }
      // scrollBar property not available in this ArkTS version
    }
    .height(40)
    .backgroundColor(Color.White)
    .border({ width: { bottom: 1 }, color: Color.Gray })
  }

  @Builder
  buildFileTree() {
    Column() {
      // æ–‡ä»¶æ ‘å¤´éƒ¨
      Row() {
        Text('å·²æ‰“å¼€æ–‡ä»¶')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('sys.color.ohos_id_color_text_primary'))
          .layoutWeight(1)

        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('ğŸ“').fontSize(14)
        }
        .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
        .width(32)
        .height(32)
        .onClick(() => {
          this.openFileDialog();
        })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor($r('sys.color.ohos_id_color_background'))

      Divider()
        .color($r('sys.color.ohos_id_color_list_separator'))
        .strokeWidth(0.5)

      // æ‰“å¼€çš„æ–‡ä»¶æ ‡ç­¾é¡µåˆ—è¡¨
      if (this.tabs.length === 0) {
        Column() {
          Text('ğŸ“‚')
            .fontSize(48)
            .fontColor($r('sys.color.ohos_id_color_text_secondary'))
            .margin({ bottom: 16 })

          Text('æœªæ‰“å¼€ä»»ä½•æ–‡ä»¶')
            .fontSize(16)
            .fontColor($r('sys.color.ohos_id_color_text_secondary'))
            .margin({ bottom: 8 })

          Text('ç‚¹å‡»"æ‰“å¼€æ–‡ä»¶"å¼€å§‹ç¼–è¾‘')
            .fontSize(12)
            .fontColor($r('sys.color.ohos_id_color_text_tertiary'))

          Blank().height(24)

          Button({ type: ButtonType.Normal, stateEffect: true }) {
            Row() {
              Text('ğŸ“').fontSize(16).margin({ right: 6 })
              Text('æ‰“å¼€æ–‡ä»¶').fontSize(14)
            }
          }
          .backgroundColor($r('sys.color.ohos_id_color_emphasize'))
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 10, bottom: 10 })
          .onClick(() => {
            this.openFileDialog();
          })
        }
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .padding(24)
      } else {
        // æ˜¾ç¤ºå·²æ‰“å¼€çš„æ–‡ä»¶åˆ—è¡¨
        Scroll() {
          Column() {
            ForEach(this.tabs, (tab: EditorTab) => {
              this.buildFileTabItem(tab)
            })
          }
          .padding({ top: 8, bottom: 8 })
        }
        .layoutWeight(1)
      }
    }
    .width(280)
    .height('100%')
    .backgroundColor($r('sys.color.ohos_id_color_background'))
    .border({ width: { right: 0.5 }, color: $r('sys.color.ohos_id_color_list_separator') })
  }

  @Builder
  buildFileTabItem(tab: EditorTab) {
    Row() {
      // æ–‡ä»¶ç±»å‹å›¾æ ‡
      Text(this.getFileTypeIcon(tab.fileName))
        .fontSize(16)
        .margin({ right: 8 })

      // æ–‡ä»¶å
      Column() {
        Text(tab.fileName)
          .fontSize(14)
          .fontColor(tab.isActive ? $r('sys.color.ohos_id_color_emphasize') : $r('sys.color.ohos_id_color_text_primary'))
          .fontWeight(tab.isActive ? FontWeight.Medium : FontWeight.Normal)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(this.getShortPath(tab.filePath))
          .fontSize(11)
          .fontColor($r('sys.color.ohos_id_color_text_tertiary'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ä¿®æ”¹çŠ¶æ€æŒ‡ç¤ºå™¨
      if (tab.isModified) {
        Text('â—')
          .fontSize(12)
          .fontColor($r('sys.color.ohos_id_color_warning'))
          .margin({ right: 8 })
      }

      // å…³é—­æŒ‰é’®
      Button({ type: ButtonType.Circle, stateEffect: true }) {
        Text('Ã—')
          .fontSize(16)
          .fontColor($r('sys.color.ohos_id_color_text_secondary'))
      }
      .backgroundColor(Color.Transparent)
      .width(24)
      .height(24)
      .onClick(() => {
        this.closeTab(tab.id);
      })
    }
    .padding({ left: 16, right: 12, top: 12, bottom: 12 })
    .backgroundColor(tab.isActive ? $r('sys.color.ohos_id_color_background_transparent') : Color.Transparent)
    .borderRadius(8)
    .margin({ left: 8, right: 8, bottom: 4 })
    .onClick(() => {
      this.switchToTab(tab.id);
    })
  }

  @Builder
  buildFileItem(item: FileItem, level: number) {
    Column() {
      // æ–‡ä»¶é¡¹
      Row() {
        // ç¼©è¿›
        if (level > 0) {
          Text('  '.repeat(level * 2))
            .fontSize(12)
            .fontColor(Color.Transparent)
        }

        // å±•å¼€/æŠ˜å å›¾æ ‡ï¼ˆä»…æ–‡ä»¶å¤¹ï¼‰
        if (item.isDirectory) {
          Button(this.expandedFolders.has(item.path) ? 'â–¼' : 'â–¶')
            .fontSize(10)
            .width(16)
            .height(16)
            .backgroundColor(Color.Transparent)
            .fontColor(Color.Gray)
            .margin({ right: 4 })
            .onClick(() => {
              this.toggleFolder(item.path);
            })
        } else {
          // æ–‡ä»¶æ²¡æœ‰å±•å¼€å›¾æ ‡ï¼Œå ä½
          Text('  ')
            .fontSize(10)
            .width(16)
            .height(16)
            .margin({ right: 4 })
        }

        // æ–‡ä»¶å›¾æ ‡
        if (item.isDirectory) {
          Text('ğŸ“')
            .width(20)
            .height(20)
            .margin({ right: 8 })
        } else {
          Text('ğŸ“„')
            .width(20)
            .height(20)
            .margin({ right: 8 })
        }

        Text(item.name)
          .layoutWeight(1)
          .fontSize(13)
          .onClick(() => {
            if (item.isDirectory) {
              this.toggleFolder(item.path);
            } else {
              this.openFile(item.path);
            }
          })

        // æ–‡ä»¶å¤§å°ï¼ˆä»…æ–‡ä»¶ï¼‰
        if (!item.isDirectory) {
          Text(this.formatFileSize(item.size))
            .fontSize(10)
            .fontColor(Color.Gray)
            .margin({ left: 8 })
        }
      }
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .width('100%')
      .height(40)
      .onClick(() => {
        if (item.isDirectory) {
          this.toggleFolder(item.path);
        } else {
          this.openFile(item.path);
        }
      })

      // å­é¡¹ï¼ˆå¦‚æœæ–‡ä»¶å¤¹å·²å±•å¼€ï¼‰
      if (item.isDirectory && this.expandedFolders.has(item.path) && item.children) {
        this.buildFileList(item.children, level + 1)
      }
    }
  }

  toggleFolder(folderPath: string) {
    if (this.expandedFolders.has(folderPath)) {
      this.expandedFolders.delete(folderPath);
    } else {
      this.expandedFolders.add(folderPath);
    }
  }

  formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  @Builder
  buildEditorArea() {
    Column() {
      // ç¼–è¾‘å™¨å·¥å…·æ 
      Row() {
        Text(this.activeTab?.fileName || 'æœªé€‰æ‹©æ–‡ä»¶')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .textAlign(TextAlign.Start)
          .layoutWeight(1)

        // æ˜¾ç¤ºå½“å‰æ¨¡å¼
        if (this.isMarkdownFile) {
          Text(this.isPreviewMode ? 'é¢„è§ˆæ¨¡å¼' : 'ç¼–è¾‘æ¨¡å¼')
            .fontSize(12)
            .fontColor(Color.Gray)
            .margin({ right: 8 })
        }

        // è¡Œå·ã€å­—ç¬¦æ•°ç­‰ä¿¡æ¯
        Text(this.getStatusText())
          .fontSize(12)
          .fontColor(Color.Gray)
      }
      .padding(12)
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: Color.Gray })

      // ç¼–è¾‘å™¨å†…å®¹åŒºåŸŸ
      if (this.isMarkdownFile && this.isPreviewMode) {
        // Markdowné¢„è§ˆæ¨¡å¼
        this.buildMarkdownPreview()
      } else {
        // æ™®é€šç¼–è¾‘æ¨¡å¼
        this.buildTextEditor()
      }
    }
    .layoutWeight(1)
    .height('100%')
  }

  @Builder
  buildTextEditor() {
    HighlightedText({
      code: this.editorContent,
      language: this.activeTab?.language || 'javascript',
      fontSize: 14,
      editable: true,
      onChange: (value: string) => {
        this.handleContentChange(value);
      }
    })
    .height('100%')
    .width('100%')
    .borderRadius(8)
    .margin(16)
    .id('highlightedText')
  }

  @Builder
  buildMarkdownPreview() {
    MarkdownPreview({
      markdown: this.editorContent,
      fontSize: 14
    })
    .height('100%')
    .width('100%')
    .margin(16)
  }

  // è·å–æ–‡ä»¶ç±»å‹å›¾æ ‡
  private getFileTypeIcon(fileName: string): string {
    const extension = fileName.split('.').pop()?.toLowerCase() || '';
    const iconMap: Record<string, string> = {
      'js': 'ğŸŸ¨',
      'ts': 'ğŸ”·',
      'ets': 'ğŸ”·',
      'py': 'ğŸ',
      'java': 'â˜•',
      'html': 'ğŸŒ',
      'css': 'ğŸ¨',
      'json': 'ğŸ“‹',
      'md': 'ğŸ“',
      'txt': 'ğŸ“„',
      'xml': 'ğŸ“œ',
      'yaml': 'âš™ï¸',
      'yml': 'âš™ï¸'
    };
    return iconMap[extension] || 'ğŸ“„';
  }

  // è·å–çŸ­è·¯å¾„
  private getShortPath(fullPath: string): string {
    const maxLength = 35;
    if (fullPath.length <= maxLength) {
      return fullPath;
    }
    return '...' + fullPath.substring(fullPath.length - maxLength + 3);
  }

  switchToTab(tabId: string) {
    this.fileService.setActiveTab(tabId);
    this.tabs = this.fileService.getFileModel().getTabs();
    this.activeTab = this.fileService.getFileModel().getActiveTab();

    if (this.activeTab) {
      // åŠ è½½æ ‡ç­¾é¡µå†…å®¹
      this.loadTabContent(this.activeTab);

      // æ£€æŸ¥æ˜¯å¦ä¸ºMarkdownæ–‡ä»¶
      this.isMarkdownFile = this.checkIsMarkdownFile(this.activeTab.fileName);

      // å¦‚æœä¸æ˜¯Markdownæ–‡ä»¶ï¼Œé€€å‡ºé¢„è§ˆæ¨¡å¼
      if (!this.isMarkdownFile) {
        this.isPreviewMode = false;
      }
    }
  }

  async loadTabContent(tab: EditorTab) {
    try {
      this.editorContent = await this.fileService.readFileContent(tab.filePath);
    } catch (error) {
      console.error('åŠ è½½æ ‡ç­¾é¡µå†…å®¹å¤±è´¥:', error);
    }
  }

  closeTab(tabId: string) {
    this.fileService.closeTab(tabId);
    this.tabs = this.fileService.getFileModel().getTabs();
    this.activeTab = this.fileService.getFileModel().getActiveTab();

    if (this.activeTab) {
      this.loadTabContent(this.activeTab);
    } else {
      this.editorContent = '';
      this.isMarkdownFile = false;
      this.isPreviewMode = false;
    }
  }

  togglePreviewMode() {
    if (!this.isMarkdownFile) return;

    this.isPreviewMode = !this.isPreviewMode;

    // å¦‚æœåˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼ï¼Œç¡®ä¿å†…å®¹æ˜¯æœ€æ–°çš„
    if (this.isPreviewMode) {
      // é¢„è§ˆæ¨¡å¼ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼ŒMarkdownPreviewä¼šè‡ªåŠ¨æ›´æ–°
    } else {
      // åˆ‡æ¢å›ç¼–è¾‘æ¨¡å¼ï¼Œç¡®ä¿ç¼–è¾‘å™¨å†…å®¹åŒæ­¥
      // è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥ç¡®ä¿ç¼–è¾‘å™¨å†…å®¹ä¸é¢„è§ˆå†…å®¹åŒæ­¥
    }
  }

  // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºMarkdownæ–‡ä»¶
  private checkIsMarkdownFile(fileName: string): boolean {
    return this.markdownService.isMarkdownFile(fileName);
  }

  // ä¸»é¢˜ç›¸å…³æ–¹æ³•
  private showThemeMenu() {
    const themes = this.themeService.getAvailableThemes();
    // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªä¸»é¢˜é€‰æ‹©å¯¹è¯æ¡†
    // æš‚æ—¶é€šè¿‡å¾ªç¯åˆ‡æ¢ä¸»é¢˜æ¥æ¼”ç¤ºåŠŸèƒ½
    this.cycleTheme();
  }

  private cycleTheme() {
    const themes = this.themeService.getAvailableThemes();
    const currentIndex = themes.findIndex(t => t.id === this.currentTheme.id);
    const nextIndex = (currentIndex + 1) % themes.length;
    const nextTheme = themes[nextIndex];

    if (this.themeService.switchTheme(nextTheme.id)) {
      this.saveCurrentTheme(nextTheme.id);
      console.log('åˆ‡æ¢åˆ°ä¸»é¢˜:', nextTheme.name);
    }
  }

  private async saveCurrentTheme(themeId: string) {
    try {
      await this.themeService.saveThemePreference(themeId);
    } catch (error) {
      console.error('ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
    }
  }

  // æœç´¢ç›¸å…³æ–¹æ³•
  private handleSearchResult(result: SearchResult) {
    // æ‰“å¼€æœç´¢ç»“æœå¯¹åº”çš„æ–‡ä»¶
    this.openFile(result.filePath);

    // TODO: è·³è½¬åˆ°ç‰¹å®šçš„è¡Œå’Œåˆ—
    console.log('æœç´¢ç»“æœ:', result.filePath, 'è¡Œ:', result.lineNumber, 'åˆ—:', result.columnNumber);
  }

  // å†…å®¹å˜åŒ–å¤„ç†æ–¹æ³•
  private handleContentChange(value: string) {
    this.editorContent = value;
    if (this.activeTab) {
      this.activeTab.isModified = true;
    }
  }
}
