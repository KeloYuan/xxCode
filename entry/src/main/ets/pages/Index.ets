/**
 * ÂÖÉ‰ª£Á†Å ÂêØÂä®Ê¨¢ËøéÈ°µ
 * Á¨¶Âêà HarmonyOS Design ËßÑËåÉÁöÑÁé∞‰ª£ÂåñÊ¨¢ËøéÁïåÈù¢
 * Âè™Âú®È¶ñÊ¨°ÂêØÂä®Êó∂ÊòæÁ§∫
 */
import { router, curves } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';
import { common } from '@kit.AbilityKit';
import { BreakpointService, Breakpoint, ResponsiveUtils } from '../services/BreakpointService';

@Entry
@Component
struct Index {
  // È°µÈù¢ËΩ¨Âú∫Âä®Áîª - Áªü‰∏ÄÁöÑÊªëÂä®ÊïàÊûú
  pageTransition() {
    PageTransitionEnter({ duration: 240, curve: Curve.EaseOut })
      .slide(SlideEffect.Right)
    PageTransitionExit({ duration: 240, curve: Curve.EaseIn })
      .slide(SlideEffect.Right)
  }
  @State private currentStep: number = 0;
  @State private currentBreakpoint: Breakpoint = 'sm';
  @State private isLoading: boolean = true;
  // Ëé∑ÂèñÈÅøËÆ©Âå∫È´òÂ∫¶
  @StorageProp('topRectHeight') topRectHeight: number = 0;
  @StorageProp('bottomRectHeight') bottomRectHeight: number = 0;
  
  private breakpointService: BreakpointService = BreakpointService.getInstance();
  private context: common.UIAbilityContext | null = null;

  async aboutToAppear() {
    this.context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁúãËøáÊ¨¢ËøéÈ°µ
    try {
      const dataPreferences = await preferences.getPreferences(this.context, 'user_settings');
      const welcomed = await dataPreferences.get('welcome_shown', false);
      
      if (welcomed) {
        // Â∑≤ÁúãËøáÊ¨¢ËøéÈ°µÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÁºñËæëÂô®
        router.pushUrl({ url: 'pages/CodeEditor' }, router.RouterMode.Single);
        return;
      }
    } catch (err) {
      console.error('ËØªÂèñÈ¶ñÈÄâÈ°πÂ§±Ë¥•:', JSON.stringify(err));
    }
    
    this.isLoading = false;
    
    // Ê≥®ÂÜåÊñ≠ÁÇπÁ≥ªÁªü
    this.breakpointService.register();
    this.currentBreakpoint = this.breakpointService.getCurrentBreakpoint();
    
    this.breakpointService.onChange((breakpoint: Breakpoint) => {
      this.currentBreakpoint = breakpoint;
    });
    
    // ÂêØÂä®Âä®Áîª
    setTimeout(() => {
      this.animateSteps();
    }, 100);
  }

  aboutToDisappear() {
    this.breakpointService.unregister();
  }
  
  private async markWelcomeShown() {
    try {
      if (this.context) {
        const dataPreferences = await preferences.getPreferences(this.context, 'user_settings');
        await dataPreferences.put('welcome_shown', true);
        await dataPreferences.flush();
      }
    } catch (err) {
      console.error('‰øùÂ≠òÈ¶ñÈÄâÈ°πÂ§±Ë¥•:', JSON.stringify(err));
    }
  }

  private animateSteps() {
    const delays = [0, 200, 500, 800];
    for (let i = 0; i <= 3; i++) {
      setTimeout(() => {
        this.currentStep = i;
      }, delays[i]);
    }
  }

  build() {
    Stack() {
      // === ÁÆÄÊ¥ÅÊ∏êÂèòËÉåÊôØ ===
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 145,
          colors: [
            ['#1a1a2e', 0.0],
            ['#16213e', 0.5],
            ['#0f3460', 1.0]
          ]
        })

      // === ÂæÆÂ¶ôÁöÑÂÖâÊôïÊïàÊûú ===
      Circle()
        .width(400)
        .height(400)
        .fill('rgba(99, 102, 241, 0.08)')
        .position({ x: '70%', y: '15%' })
        .blur(100)

      if (this.isLoading) {
        // Âä†ËΩΩ‰∏≠ÊòæÁ§∫
        LoadingProgress()
          .width(64)
          .height(64)
          .color(Color.White)
      } else {
        // ‰∏ªÂÜÖÂÆπÂå∫
        this.buildMainContent()
      }
    }
    .width('100%')
    .height('100%')
    // Â∞ÜËÉåÊôØÂª∂‰º∏Âà∞Áä∂ÊÄÅÊ†èÂíåÂØºËà™Ê†èÂå∫ÂüüÔºåÂÆûÁé∞Ê≤âÊµ∏ÂºèÊïàÊûú
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  buildMainContent(): void {
    Scroll() {
      Column() {
        // Logo ÂíåÊ†áÈ¢òÂå∫
        this.buildHeroSection()
        
        // ÁâπÊÄßÂç°ÁâáÁΩëÊ†º
        this.buildFeatureGrid()
        
        // Ë°åÂä®Âè¨Âî§ÊåâÈíÆ
        this.buildCTASection()
      }
      .width('100%')
      .padding({ 
        left: ResponsiveUtils.getMargin(), 
        right: ResponsiveUtils.getMargin(), 
        // È°∂ÈÉ®paddingËÄÉËôëÁä∂ÊÄÅÊ†èÈ´òÂ∫¶ÔºàpxËΩ¨vpËøë‰ººÂÄºÔºâ
        top: this.topRectHeight / 3 + (this.breakpointService.isLargeScreen() ? 40 : 30), 
        // Â∫ïÈÉ®paddingËÄÉËôëÂØºËà™Ê†èÈ´òÂ∫¶
        bottom: this.bottomRectHeight / 3 + 30 
      })
      .constraintSize({ 
        maxWidth: this.breakpointService.isDesktop() ? 1400 : 1200 
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
  }

  @Builder
  buildHeroSection(): void {
    Column({ space: 20 }) {
      // Logo ÂõæÁâá
      Image($r('app.media.app_logo'))
        .width(this.breakpointService.isPhone() ? 100 : 120)
        .height(this.breakpointService.isPhone() ? 100 : 120)
        .objectFit(ImageFit.Cover)
        .borderRadius(28)
        .clip(true)
        .shadow({
          radius: 40,
          color: 'rgba(99, 102, 241, 0.3)',
          offsetY: 0
        })
        .scale({ x: this.currentStep >= 0 ? 1 : 0.85, y: this.currentStep >= 0 ? 1 : 0.85 })
        .opacity(this.currentStep >= 0 ? 1 : 0)
        .animation({
          duration: 800,
          curve: curves.springMotion(0.7, 0.95),
          delay: 200
        })
        .margin({ bottom: 28 })

      // ‰∏ªÊ†áÈ¢ò
      Text('ÂÖÉ‰ª£Á†Å')
        .fontSize(this.breakpointService.isPhone() ? 36 : 44)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .letterSpacing(4)
        .scale({ x: this.currentStep >= 1 ? 1 : 0.95, y: this.currentStep >= 1 ? 1 : 0.95 })
        .opacity(this.currentStep >= 1 ? 1 : 0)
        .animation({
          duration: 700,
          curve: curves.springMotion(0.7, 0.95),
          delay: 350
        })

      // ÂâØÊ†áÈ¢ò
      Text($r('app.string.app_slogan'))
        .fontSize(this.breakpointService.isPhone() ? 14 : 16)
        .fontColor('rgba(255, 255, 255, 0.65)')
        .fontWeight(FontWeight.Regular)
        .textAlign(TextAlign.Center)
        .letterSpacing(1)
        .scale({ x: this.currentStep >= 1 ? 1 : 0.95, y: this.currentStep >= 1 ? 1 : 0.95 })
        .opacity(this.currentStep >= 1 ? 1 : 0)
        .animation({
          duration: 700,
          curve: curves.springMotion(0.7, 0.95),
          delay: 420
        })
    }
    .width('100%')
    .margin({ bottom: 60 })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildFeatureGrid(): void {
    GridRow({
      columns: { xs: 4, sm: 4, md: 8, lg: 12, xl: 12 },
      gutter: { x: ResponsiveUtils.getGutter(), y: ResponsiveUtils.getGutter() }
    }) {
      GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
        this.buildFeatureCard('‚ö°', $r('app.string.feature_fast_title'), $r('app.string.feature_fast_desc'), 0)
      }
      GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
        this.buildFeatureCard('üé®', $r('app.string.feature_highlight_title'), $r('app.string.feature_highlight_desc'), 1)
      }
      GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
        this.buildFeatureCard('üìÅ', $r('app.string.feature_files_title'), $r('app.string.feature_files_desc'), 2)
      }
      GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
        this.buildFeatureCard('üåô', $r('app.string.feature_themes_title'), $r('app.string.feature_themes_desc'), 3)
      }
    }
    .width('100%')
    .margin({ bottom: 48 })
  }

  @Builder
  buildFeatureCard(icon: string, title: ResourceStr, description: ResourceStr, index: number): void {
    Stack() {
      // Ê∂≤ÊÄÅÁéªÁíÉÂç°Áâá‰∏ª‰Ωì
      Column() {
        // ÁÆÄÊ¥ÅÂõæÊ†á
        Text(icon)
          .fontSize(40)
          .margin({ bottom: 16 })

        Text(title)
          .fontSize(ResponsiveUtils.getFontSize({ xs: 16, sm: 17, md: 18, lg: 18, xl: 19 }))
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .margin({ bottom: 8 })

        Text(description)
          .fontSize(ResponsiveUtils.getFontSize({ xs: 12, sm: 13, md: 13, lg: 14, xl: 14 }))
          .fontColor('rgba(255, 255, 255, 0.6)')
          .fontWeight(FontWeight.Regular)
          .textAlign(TextAlign.Center)
          .maxLines(2)
          .lineHeight(20)
          .padding({ left: 8, right: 8 })
      }
      .width('100%')
      .height('100%')
      .padding(this.breakpointService.isPhone() ? 20 : 24)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // ÂÜÖÈÉ®È´òÂÖâÂ±Ç - Ê®°ÊãüÁéªÁíÉÂèçÂÖâ
      Column()
        .width('100%')
        .height('100%')
        .borderRadius(20)
        .linearGradient({
          angle: 135,
          colors: [
            ['rgba(255, 255, 255, 0.15)', 0.0],
            ['rgba(255, 255, 255, 0.02)', 0.3],
            ['rgba(255, 255, 255, 0)', 0.5],
            ['rgba(255, 255, 255, 0.02)', 0.7],
            ['rgba(255, 255, 255, 0)', 1.0]
          ]
        })
        .hitTestBehavior(HitTestMode.None)
    }
    .width('100%')
    .height(this.breakpointService.isPhone() ? 160 : 170)
    // Ê∂≤ÊÄÅÁéªÁíÉÊïàÊûú - ÂàÜÂ±ÇËÉåÊôØ
    .backgroundBlurStyle(BlurStyle.COMPONENT_ULTRA_THICK)
    .backgroundColor('rgba(255, 255, 255, 0.08)')
    .backdropBlur(25)
    .borderRadius(24)
    // Â§öÂ±ÇËæπÊ°ÜÊ®°ÊãüÁéªÁíÉËæπÁºò
    .border({
      width: 1.5,
      color: 'rgba(255, 255, 255, 0.18)'
    })
    .shadow({
      radius: 32,
      color: 'rgba(0, 0, 0, 0.25)',
      offsetX: 0,
      offsetY: 8
    })
    // ÂÜÖÂèëÂÖâÊïàÊûú
    .shadow({
      radius: 16,
      color: 'rgba(255, 255, 255, 0.08)',
      offsetX: 0,
      offsetY: -4
    })
    .scale({ x: this.currentStep >= 2 ? 1 : 0.92, y: this.currentStep >= 2 ? 1 : 0.92 })
    .opacity(this.currentStep >= 2 ? 1 : 0)
    .translate({ y: this.currentStep >= 2 ? 0 : 20 })
    .animation({
      duration: 700,
      curve: curves.springMotion(0.7, 0.95),
      delay: 500 + index * 80
    })
  }

  @Builder
  buildCTASection(): void {
    Column({ space: 24 }) {
      // ‰∏ªÊåâÈíÆ - Ê∂≤ÊÄÅÁéªÁíÉÊïàÊûú
      Stack() {
        Button({ type: ButtonType.Normal }) {
          Row({ space: 10 }) {
            Text($r('app.string.btn_start_coding'))
              .fontSize(16)
              .fontWeight(FontWeight.Medium)

            Text('‚Üí')
              .fontSize(14)
          }
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(255, 255, 255, 0.92)')
        .fontColor('#1a1a2e')
        .borderRadius(26)
        // Ê∂≤ÊÄÅÁéªÁíÉÈò¥ÂΩ±
        .shadow({
          radius: 28,
          color: 'rgba(0, 0, 0, 0.2)',
          offsetX: 0,
          offsetY: 8
        })
        .shadow({
          radius: 12,
          color: 'rgba(99, 102, 241, 0.3)',
          offsetX: 0,
          offsetY: 0
        })
        .stateEffect(true)
        .onClick(async () => {
          await this.markWelcomeShown();
          router.pushUrl({
            url: 'pages/CodeEditor'
          }, router.RouterMode.Single);
        })

        // ÊåâÈíÆÈ´òÂÖâÂ±Ç
        Column()
          .width('100%')
          .height('100%')
          .borderRadius(26)
          .linearGradient({
            angle: 135,
            colors: [
              ['rgba(255, 255, 255, 0.6)', 0.0],
              ['rgba(255, 255, 255, 0.1)', 0.4],
              ['rgba(255, 255, 255, 0)', 1.0]
            ]
          })
          .hitTestBehavior(HitTestMode.None)
      }
      .width(this.breakpointService.isPhone() ? '80%' : 280)
      .height(52)
      .scale({ x: this.currentStep >= 3 ? 1 : 0.92, y: this.currentStep >= 3 ? 1 : 0.92 })
      .opacity(this.currentStep >= 3 ? 1 : 0)
      .animation({
        duration: 700,
        curve: curves.springMotion(0.7, 0.95),
        delay: 800
      })

      // Â∫ïÈÉ®‰ø°ÊÅØ - Ê∂≤ÊÄÅÁéªÁíÉÂÆπÂô®
      Row({ space: 16 }) {
        Text('v4.0.0')
          .fontSize(11)
          .fontColor('rgba(255, 255, 255, 0.5)')

        Text('‚Ä¢')
          .fontSize(11)
          .fontColor('rgba(255, 255, 255, 0.35)')

        Text('È∏øËíôÂéüÁîü')
          .fontSize(11)
          .fontColor('rgba(255, 255, 255, 0.5)')

        Text('‚Ä¢')
          .fontSize(11)
          .fontColor('rgba(255, 255, 255, 0.35)')

        Text('ÂºÄÊ∫ê')
          .fontSize(11)
          .fontColor('rgba(255, 255, 255, 0.5)')
      }
      .padding({ left: 20, right: 20, top: 10, bottom: 10 })
      .backgroundBlurStyle(BlurStyle.COMPONENT_THICK)
      .backgroundColor('rgba(255, 255, 255, 0.06)')
      .backdropBlur(15)
      .borderRadius(16)
      .border({
        width: 1,
        color: 'rgba(255, 255, 255, 0.12)'
      })
      .opacity(this.currentStep >= 3 ? 0.8 : 0)
      .animation({
        duration: 700,
        curve: curves.springMotion(0.7, 0.95),
        delay: 950
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
  }
}
