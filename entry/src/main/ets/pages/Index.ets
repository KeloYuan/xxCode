/**
 * å…ƒä»£ç  å¯åŠ¨æ¬¢è¿é¡µ
 * ç¬¦åˆ HarmonyOS Design è§„èŒƒçš„ç°ä»£åŒ–æ¬¢è¿ç•Œé¢
 * åªåœ¨é¦–æ¬¡å¯åŠ¨æ—¶æ˜¾ç¤º
 */
import { router } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';
import { common } from '@kit.AbilityKit';
import { BreakpointService, Breakpoint, ResponsiveUtils } from '../services/BreakpointService';

class FeatureCardData {
  public icon: string;
  public title: string;
  public description: string;
  
  constructor(icon: string, title: string, description: string) {
    this.icon = icon;
    this.title = title;
    this.description = description;
  }
}

@Entry
@Component
struct Index {
  // é¡µé¢è½¬åœºåŠ¨ç”»é…ç½®
  pageTransition() {
    // è¿›å…¥åŠ¨ç”»ï¼šä»å³ä¾§æ»‘å…¥
    PageTransitionEnter({ duration: 350, curve: Curve.EaseOut })
      .slide(SlideEffect.Right)
    // é€€å‡ºåŠ¨ç”»ï¼šå‘å·¦ä¾§æ»‘å‡º
    PageTransitionExit({ duration: 350, curve: Curve.EaseIn })
      .slide(SlideEffect.Left)
  }
  @State private currentStep: number = 0;
  @State private currentBreakpoint: Breakpoint = 'sm';
  @State private isLoading: boolean = true;
  // è·å–é¿è®©åŒºé«˜åº¦
  @StorageProp('topRectHeight') topRectHeight: number = 0;
  @StorageProp('bottomRectHeight') bottomRectHeight: number = 0;
  
  private breakpointService: BreakpointService = BreakpointService.getInstance();
  private context: common.UIAbilityContext | null = null;
  
  // ç‰¹æ€§å¡ç‰‡æ•°æ®
  private features: Array<FeatureCardData> = [
    new FeatureCardData('âš¡', 'æé€Ÿå¯åŠ¨', 'æ¯«ç§’çº§å¯åŠ¨ï¼Œæµç•…ç¼–è¾‘ä½“éªŒ'),
    new FeatureCardData('ğŸ¨', 'è¯­æ³•é«˜äº®', 'æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€é«˜äº®'),
    new FeatureCardData('ğŸ“', 'æ–‡ä»¶ç®¡ç†', 'å¼ºå¤§çš„æ–‡ä»¶æµè§ˆå’Œç®¡ç†'),
    new FeatureCardData('ğŸŒ™', 'å¤šä¸»é¢˜', 'æ·±è‰²/æµ…è‰²/Monokai/Dracula')
  ];

  async aboutToAppear() {
    this.context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    
    // æ£€æŸ¥æ˜¯å¦å·²çœ‹è¿‡æ¬¢è¿é¡µ
    try {
      const dataPreferences = await preferences.getPreferences(this.context, 'user_settings');
      const welcomed = await dataPreferences.get('welcome_shown', false);
      
      if (welcomed) {
        // å·²çœ‹è¿‡æ¬¢è¿é¡µï¼Œç›´æ¥è·³è½¬åˆ°ç¼–è¾‘å™¨
        router.pushUrl({ url: 'pages/CodeEditor' }, router.RouterMode.Single);
        return;
      }
    } catch (err) {
      console.error('è¯»å–é¦–é€‰é¡¹å¤±è´¥:', JSON.stringify(err));
    }
    
    this.isLoading = false;
    
    // æ³¨å†Œæ–­ç‚¹ç³»ç»Ÿ
    this.breakpointService.register();
    this.currentBreakpoint = this.breakpointService.getCurrentBreakpoint();
    
    this.breakpointService.onChange((breakpoint: Breakpoint) => {
      this.currentBreakpoint = breakpoint;
    });
    
    // å¯åŠ¨åŠ¨ç”»
    setTimeout(() => {
      this.animateSteps();
    }, 100);
  }

  aboutToDisappear() {
    this.breakpointService.unregister();
  }
  
  private async markWelcomeShown() {
    try {
      if (this.context) {
        const dataPreferences = await preferences.getPreferences(this.context, 'user_settings');
        await dataPreferences.put('welcome_shown', true);
        await dataPreferences.flush();
      }
    } catch (err) {
      console.error('ä¿å­˜é¦–é€‰é¡¹å¤±è´¥:', JSON.stringify(err));
    }
  }

  private animateSteps() {
    const delays = [0, 200, 500, 900];
    for (let i = 0; i <= 3; i++) {
      setTimeout(() => {
        this.currentStep = i;
      }, delays[i]);
    }
  }

  build() {
    Stack() {
      // æ¸å˜èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 135,
          colors: [
            ['#667eea', 0.0],
            ['#764ba2', 1.0]
          ]
        })

      if (this.isLoading) {
        // åŠ è½½ä¸­æ˜¾ç¤º
        LoadingProgress()
          .width(48)
          .height(48)
          .color(Color.White)
      } else {
        // è£…é¥°æ€§åœ†å½¢
        Circle()
          .width(300)
          .height(300)
          .fill('rgba(255, 255, 255, 0.1)')
          .position({ x: '80%', y: '10%' })
          .blur(50)

        Circle()
          .width(200)
          .height(200)
          .fill('rgba(255, 255, 255, 0.08)')
          .position({ x: '10%', y: '70%' })
          .blur(40)

        // ä¸»å†…å®¹åŒº
        this.buildMainContent()
      }
    }
    .width('100%')
    .height('100%')
    // å°†èƒŒæ™¯å»¶ä¼¸åˆ°çŠ¶æ€æ å’Œå¯¼èˆªæ åŒºåŸŸï¼Œå®ç°æ²‰æµ¸å¼æ•ˆæœ
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  buildMainContent(): void {
    Scroll() {
      Column() {
        // Logo å’Œæ ‡é¢˜åŒº
        this.buildHeroSection()
        
        // ç‰¹æ€§å¡ç‰‡ç½‘æ ¼
        this.buildFeatureGrid()
        
        // è¡ŒåŠ¨å¬å”¤æŒ‰é’®
        this.buildCTASection()
      }
      .width('100%')
      .padding({ 
        left: ResponsiveUtils.getMargin(), 
        right: ResponsiveUtils.getMargin(), 
        // é¡¶éƒ¨paddingè€ƒè™‘çŠ¶æ€æ é«˜åº¦ï¼ˆpxè½¬vpè¿‘ä¼¼å€¼ï¼‰
        top: this.topRectHeight / 3 + (this.breakpointService.isLargeScreen() ? 40 : 30), 
        // åº•éƒ¨paddingè€ƒè™‘å¯¼èˆªæ é«˜åº¦
        bottom: this.bottomRectHeight / 3 + 30 
      })
      .constraintSize({ 
        maxWidth: this.breakpointService.isDesktop() ? 1400 : 1200 
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
  }

  @Builder
  buildHeroSection(): void {
    Column({ space: 16 }) {
      // Logo ç¬¦å·
      Column() {
        Text('<>')
          .fontSize(48)
          .fontColor('rgba(255, 255, 255, 0.95)')
          .fontWeight(FontWeight.Bold)
          .fontFamily('SF Mono, Monaco, Menlo, Consolas, monospace')
          .scale({ x: this.currentStep >= 0 ? 1 : 0.3, y: this.currentStep >= 0 ? 1 : 0.3 })
          .opacity(this.currentStep >= 0 ? 1 : 0)
          .rotate({ angle: this.currentStep >= 0 ? 0 : 180 })
          .animation({
            duration: 800,
            curve: Curve.Friction,
            delay: 200
          })
      }
      .margin({ bottom: 40 })

      // ä¸»æ ‡é¢˜
      Text('å…ƒä»£ç ')
        .fontSize(this.breakpointService.isPhone() ? 32 : 42)
        .fontColor(Color.White)
        .fontWeight(FontWeight.Bold)
        .textAlign(TextAlign.Center)
        .scale({ x: this.currentStep >= 1 ? 1 : 0.9, y: this.currentStep >= 1 ? 1 : 0.9 })
        .opacity(this.currentStep >= 1 ? 1 : 0)
        .animation({
          duration: 600,
          curve: Curve.EaseOut,
          delay: 400
        })

      // å‰¯æ ‡é¢˜
      Text('ç°ä»£åŒ– Â· è½»é‡çº§ Â· é«˜æ•ˆ')
        .fontSize(this.breakpointService.isPhone() ? 15 : 18)
        .fontColor('rgba(255, 255, 255, 0.85)')
        .textAlign(TextAlign.Center)
        .letterSpacing(2)
        .scale({ x: this.currentStep >= 1 ? 1 : 0.9, y: this.currentStep >= 1 ? 1 : 0.9 })
        .opacity(this.currentStep >= 1 ? 1 : 0)
        .animation({
          duration: 600,
          curve: Curve.EaseOut,
          delay: 500
        })
    }
    .width('100%')
    .margin({ bottom: 60 })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildFeatureGrid(): void {
    GridRow({
      columns: { xs: 4, sm: 4, md: 8, lg: 12, xl: 12 },
      gutter: { x: ResponsiveUtils.getGutter(), y: ResponsiveUtils.getGutter() }
    }) {
      ForEach(this.features, (feature: FeatureCardData, index: number) => {
        GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
          this.buildFeatureCard(feature.icon, feature.title, feature.description, index)
        }
      }, (feature: FeatureCardData) => feature.title)
    }
    .width('100%')
    .margin({ bottom: 48 })
  }

  @Builder
  buildFeatureCard(icon: string, title: string, description: string, index: number): void {
    Column() {
      Text(icon)
        .fontSize(this.breakpointService.isPhone() ? 32 : 40)
        .margin({ bottom: 16 })

      Text(title)
        .fontSize(ResponsiveUtils.getFontSize({ xs: 15, sm: 16, md: 17, lg: 18, xl: 19 }))
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .margin({ bottom: 8 })

      Text(description)
        .fontSize(ResponsiveUtils.getFontSize({ xs: 12, sm: 13, md: 14, lg: 14, xl: 15 }))
        .fontColor('rgba(255, 255, 255, 0.7)')
        .textAlign(TextAlign.Center)
        .maxLines(2)
        .lineHeight(20)
    }
    .width('100%')
    .height(this.breakpointService.isPhone() ? 140 : 160)
    .padding(this.breakpointService.isPhone() ? 20 : 24)
    .backgroundColor('rgba(255, 255, 255, 0.12)')
    .backdropBlur(20)
    .borderRadius(this.breakpointService.isLargeScreen() ? 24 : 20)
    .border({
      width: 1,
      color: 'rgba(255, 255, 255, 0.2)'
    })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .shadow({
      radius: 20,
      color: 'rgba(0, 0, 0, 0.15)',
      offsetX: 0,
      offsetY: 10
    })
    .scale({ x: this.currentStep >= 2 ? 1 : 0.85, y: this.currentStep >= 2 ? 1 : 0.85 })
    .opacity(this.currentStep >= 2 ? 1 : 0)
    .translate({ y: this.currentStep >= 2 ? 0 : 20 })
    .animation({
      duration: 600,
      curve: Curve.Friction,
      delay: 600 + index * 100
    })

  }

  @Builder
  buildCTASection(): void {
    Column({ space: 16 }) {
      // ä¸»æŒ‰é’®
      Button({ type: ButtonType.Normal }) {
        Row() {
          Text('âœï¸')
            .fontSize(20)
            .margin({ right: 8 })
          
          Text('å¼€å§‹ç¼–ç ')
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
        }
      }
      .width(this.breakpointService.isPhone() ? '100%' : 280)
      .height(56)
      .backgroundColor('rgba(255, 255, 255, 0.95)')
      .borderRadius(28)
      .shadow({
        radius: 25,
        color: 'rgba(0, 0, 0, 0.2)',
        offsetX: 0,
        offsetY: 12
      })
      .scale({ x: this.currentStep >= 3 ? 1 : 0.9, y: this.currentStep >= 3 ? 1 : 0.9 })
      .opacity(this.currentStep >= 3 ? 1 : 0)
      .animation({
        duration: 600,
        curve: Curve.EaseOut,
        delay: 1000
      })
      .onClick(async () => {
        await this.markWelcomeShown();
        // ä½¿ç”¨ pushUrl è§¦å‘è½¬åœºåŠ¨ç”»
        router.pushUrl({ 
          url: 'pages/CodeEditor'
        }, router.RouterMode.Single);
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
  }
}
