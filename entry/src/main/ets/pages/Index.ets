/**
 * å…ƒä»£ç  å¯åŠ¨æ¬¢è¿é¡µ
 * ç¬¦åˆ HarmonyOS Design è§„èŒƒçš„ç°ä»£åŒ–æ¬¢è¿ç•Œé¢
 * åªåœ¨é¦–æ¬¡å¯åŠ¨æ—¶æ˜¾ç¤º
 */
import { router, curves } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';
import { common } from '@kit.AbilityKit';
import { BreakpointService, Breakpoint, ResponsiveUtils } from '../services/BreakpointService';

@Entry
@Component
struct Index {
  // é¡µé¢è½¬åœºåŠ¨ç”» - ç»Ÿä¸€çš„æ»‘åŠ¨æ•ˆæœ
  pageTransition() {
    PageTransitionEnter({ duration: 240, curve: Curve.EaseOut })
      .slide(SlideEffect.Right)
    PageTransitionExit({ duration: 240, curve: Curve.EaseIn })
      .slide(SlideEffect.Right)
  }
  @State private currentStep: number = 0;
  @State private currentBreakpoint: Breakpoint = 'sm';
  @State private isLoading: boolean = true;
  // è·å–é¿è®©åŒºé«˜åº¦
  @StorageProp('topRectHeight') topRectHeight: number = 0;
  @StorageProp('bottomRectHeight') bottomRectHeight: number = 0;
  
  private breakpointService: BreakpointService = BreakpointService.getInstance();
  private context: common.UIAbilityContext | null = null;

  async aboutToAppear() {
    this.context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    
    // æ£€æŸ¥æ˜¯å¦å·²çœ‹è¿‡æ¬¢è¿é¡µ
    try {
      const dataPreferences = await preferences.getPreferences(this.context, 'user_settings');
      const welcomed = await dataPreferences.get('welcome_shown', false);
      
      if (welcomed) {
        // å·²çœ‹è¿‡æ¬¢è¿é¡µï¼Œç›´æ¥è·³è½¬åˆ°ç¼–è¾‘å™¨
        router.pushUrl({ url: 'pages/CodeEditor' }, router.RouterMode.Single);
        return;
      }
    } catch (err) {
      console.error('è¯»å–é¦–é€‰é¡¹å¤±è´¥:', JSON.stringify(err));
    }
    
    this.isLoading = false;
    
    // æ³¨å†Œæ–­ç‚¹ç³»ç»Ÿ
    this.breakpointService.register();
    this.currentBreakpoint = this.breakpointService.getCurrentBreakpoint();
    
    this.breakpointService.onChange((breakpoint: Breakpoint) => {
      this.currentBreakpoint = breakpoint;
    });
    
    // å¯åŠ¨åŠ¨ç”»
    setTimeout(() => {
      this.animateSteps();
    }, 100);
  }

  aboutToDisappear() {
    this.breakpointService.unregister();
  }
  
  private async markWelcomeShown() {
    try {
      if (this.context) {
        const dataPreferences = await preferences.getPreferences(this.context, 'user_settings');
        await dataPreferences.put('welcome_shown', true);
        await dataPreferences.flush();
      }
    } catch (err) {
      console.error('ä¿å­˜é¦–é€‰é¡¹å¤±è´¥:', JSON.stringify(err));
    }
  }

  private animateSteps() {
    const delays = [0, 200, 500, 900];
    for (let i = 0; i <= 3; i++) {
      setTimeout(() => {
        this.currentStep = i;
      }, delays[i]);
    }
  }

  build() {
    Stack() {
      // === é¸¿è’™é£æ ¼æ¸å˜èƒŒæ™¯ ===
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 145,
          colors: [
            ['#0A59F7', 0.0],    // é¸¿è’™è“
            ['#0091FF', 0.4],    // å¤©ç©ºè“
            ['#5B8FF9', 0.7],    // æµ…è“
            ['#7C3AED', 1.0]     // ç´«è‰²ç‚¹ç¼€
          ]
        })
        .opacity(0.95)

      if (this.isLoading) {
        // åŠ è½½ä¸­æ˜¾ç¤º
        LoadingProgress()
          .width(64)
          .height(64)
          .color(Color.White)
      } else {
        // ç®€åŒ–çš„è£…é¥°æ•ˆæœ
        Circle()
          .width(300)
          .height(300)
          .fill('rgba(255, 255, 255, 0.08)')
          .position({ x: '80%', y: '10%' })
          .blur(60)

        Circle()
          .width(200)
          .height(200)
          .fill('rgba(255, 255, 255, 0.06)')
          .position({ x: '10%', y: '75%' })
          .blur(50)

        // ä¸»å†…å®¹åŒº
        this.buildMainContent()
      }
    }
    .width('100%')
    .height('100%')
    // å°†èƒŒæ™¯å»¶ä¼¸åˆ°çŠ¶æ€æ å’Œå¯¼èˆªæ åŒºåŸŸï¼Œå®ç°æ²‰æµ¸å¼æ•ˆæœ
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  buildMainContent(): void {
    Scroll() {
      Column() {
        // Logo å’Œæ ‡é¢˜åŒº
        this.buildHeroSection()
        
        // ç‰¹æ€§å¡ç‰‡ç½‘æ ¼
        this.buildFeatureGrid()
        
        // è¡ŒåŠ¨å¬å”¤æŒ‰é’®
        this.buildCTASection()
      }
      .width('100%')
      .padding({ 
        left: ResponsiveUtils.getMargin(), 
        right: ResponsiveUtils.getMargin(), 
        // é¡¶éƒ¨paddingè€ƒè™‘çŠ¶æ€æ é«˜åº¦ï¼ˆpxè½¬vpè¿‘ä¼¼å€¼ï¼‰
        top: this.topRectHeight / 3 + (this.breakpointService.isLargeScreen() ? 40 : 30), 
        // åº•éƒ¨paddingè€ƒè™‘å¯¼èˆªæ é«˜åº¦
        bottom: this.bottomRectHeight / 3 + 30 
      })
      .constraintSize({ 
        maxWidth: this.breakpointService.isDesktop() ? 1400 : 1200 
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
  }

  @Builder
  buildHeroSection(): void {
    Column({ space: 24 }) {
      // Logo ç¬¦å· - ç®€åŒ–è®¾è®¡
      Column() {
        Text('<>')
          .fontSize(this.breakpointService.isPhone() ? 48 : 56)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)
          .fontFamily('SF Mono, Monaco, Menlo, Consolas, monospace')
          .letterSpacing(2)
          .scale({ x: this.currentStep >= 0 ? 1 : 0.3, y: this.currentStep >= 0 ? 1 : 0.3 })
          .opacity(this.currentStep >= 0 ? 1 : 0)
          .rotate({ angle: this.currentStep >= 0 ? 0 : 180 })
          .animation({
            duration: 700,
            curve: curves.springMotion(0.6, 0.9),
            delay: 150
          })
      }
      .width(this.breakpointService.isPhone() ? 90 : 100)
      .height(this.breakpointService.isPhone() ? 90 : 100)
      .backgroundColor('rgba(255, 255, 255, 0.10)')
      .backdropBlur(15)
      .borderRadius(24)
      .justifyContent(FlexAlign.Center)
      .margin({ bottom: 24 })

      // ä¸»æ ‡é¢˜ - ç®€åŒ–
      Text($r('app.string.app_name'))
        .fontSize(this.breakpointService.isPhone() ? 36 : 44)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Bold)
        .textAlign(TextAlign.Center)
        .letterSpacing(2)
        .scale({ x: this.currentStep >= 1 ? 1 : 0.9, y: this.currentStep >= 1 ? 1 : 0.9 })
        .opacity(this.currentStep >= 1 ? 1 : 0)
        .animation({
          duration: 700,
          curve: curves.springMotion(0.6, 0.9),
          delay: 350
        })

      // å‰¯æ ‡é¢˜
      Text($r('app.string.app_slogan'))
        .fontSize(this.breakpointService.isPhone() ? 15 : 18)
        .fontColor('rgba(255, 255, 255, 0.85)')
        .fontWeight(FontWeight.Regular)
        .textAlign(TextAlign.Center)
        .letterSpacing(2)
        .scale({ x: this.currentStep >= 1 ? 1 : 0.9, y: this.currentStep >= 1 ? 1 : 0.9 })
        .opacity(this.currentStep >= 1 ? 1 : 0)
        .animation({
          duration: 700,
          curve: curves.springMotion(0.6, 0.9),
          delay: 450
        })
    }
    .width('100%')
    .margin({ bottom: 72 })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildFeatureGrid(): void {
    GridRow({
      columns: { xs: 4, sm: 4, md: 8, lg: 12, xl: 12 },
      gutter: { x: ResponsiveUtils.getGutter(), y: ResponsiveUtils.getGutter() }
    }) {
      GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
        this.buildFeatureCard('âš¡', $r('app.string.feature_fast_title'), $r('app.string.feature_fast_desc'), 0)
      }
      GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
        this.buildFeatureCard('ğŸ¨', $r('app.string.feature_highlight_title'), $r('app.string.feature_highlight_desc'), 1)
      }
      GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
        this.buildFeatureCard('ğŸ“', $r('app.string.feature_files_title'), $r('app.string.feature_files_desc'), 2)
      }
      GridCol({ span: { xs: 4, sm: 2, md: 4, lg: 3, xl: 3 } }) {
        this.buildFeatureCard('ğŸŒ™', $r('app.string.feature_themes_title'), $r('app.string.feature_themes_desc'), 3)
      }
    }
    .width('100%')
    .margin({ bottom: 48 })
  }

  @Builder
  buildFeatureCard(icon: string, title: ResourceStr, description: ResourceStr, index: number): void {
    Column() {
      // å›¾æ ‡ - ç®€åŒ–
      Text(icon)
        .fontSize(this.breakpointService.isPhone() ? 36 : 42)
        .margin({ bottom: 16 })

      Text(title)
        .fontSize(ResponsiveUtils.getFontSize({ xs: 16, sm: 17, md: 18, lg: 19, xl: 20 }))
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ bottom: 10 })

      Text(description)
        .fontSize(ResponsiveUtils.getFontSize({ xs: 13, sm: 14, md: 14, lg: 15, xl: 15 }))
        .fontColor('rgba(255, 255, 255, 0.75)')
        .fontWeight(FontWeight.Regular)
        .textAlign(TextAlign.Center)
        .maxLines(2)
        .lineHeight(22)
    }
    .width('100%')
    .height(this.breakpointService.isPhone() ? 170 : 190)
    .padding(this.breakpointService.isPhone() ? 24 : 28)
    .backgroundColor('rgba(255, 255, 255, 0.10)')
    .backdropBlur(30)
    .borderRadius(this.breakpointService.isLargeScreen() ? 24 : 20)
    .border({
      width: 1,
      color: 'rgba(255, 255, 255, 0.20)'
    })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .scale({ x: this.currentStep >= 2 ? 1 : 0.9, y: this.currentStep >= 2 ? 1 : 0.9 })
    .opacity(this.currentStep >= 2 ? 1 : 0)
    .translate({ y: this.currentStep >= 2 ? 0 : 20 })
    .animation({
      duration: 700,
      curve: curves.springMotion(0.6, 0.9),
      delay: 550 + index * 100
    })
  }

  @Builder
  buildCTASection(): void {
    Column({ space: 16 }) {
      // ä¸»æŒ‰é’® - ç®€åŒ–
      Button({ type: ButtonType.Normal }) {
        Row({ space: 10 }) {
          Text('âœ¨')
            .fontSize(20)
          
          Text($r('app.string.btn_start_coding'))
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
        }
      }
      .width(this.breakpointService.isPhone() ? '80%' : 280)
      .height(56)
      .backgroundColor('#FFFFFF')
      .fontColor('#0A59F7')
      .borderRadius(28)
      .scale({ x: this.currentStep >= 3 ? 1 : 0.9, y: this.currentStep >= 3 ? 1 : 0.9 })
      .opacity(this.currentStep >= 3 ? 1 : 0)
      .animation({
        duration: 700,
        curve: curves.springMotion(0.6, 0.9),
        delay: 900
      })
      .stateEffect(true)
      .onClick(async () => {
        await this.markWelcomeShown();
        router.pushUrl({
          url: 'pages/CodeEditor'
        }, router.RouterMode.Single);
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
  }
}
