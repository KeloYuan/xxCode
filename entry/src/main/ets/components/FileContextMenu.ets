/**
 * æ–‡ä»¶å³é”®èœå•ç»„ä»¶
 * æä¾›æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„ä¸Šä¸‹æ–‡æ“ä½œèœå•
 */
import { FileItem } from '../models/FileModel';
import { ThemeService, Theme } from '../services/ThemeService';

export interface MenuAction {
  icon: string;
  text: string;
  action: () => void;
  isDanger?: boolean;
}

@CustomDialog
export struct FileContextMenu {
  @Prop fileItem: FileItem;
  @State private currentTheme: Theme = ThemeService.getInstance().getCurrentTheme();
  
  controller: CustomDialogController;
  
  onNewFile: () => void = () => {};
  onNewFolder: () => void = () => {};
  onRename: () => void = () => {};
  onDelete: () => void = () => {};
  onCopy: () => void = () => {};
  onCut: () => void = () => {};
  onPaste: () => void = () => {};

  private themeService: ThemeService = ThemeService.getInstance();

  aboutToAppear() {
    this.themeService.onThemeChange((theme: Theme) => {
      this.currentTheme = theme;
    });
  }

  build() {
    Column() {
      // èœå•æ ‡é¢˜
      Row() {
        Text(this.getFileIcon())
          .fontSize(16)
          .margin({ right: 8 })
        
        Text(this.fileItem.name)
          .fontSize(13)
          .fontColor(this.currentTheme.colors.text)
          .fontWeight(FontWeight.Medium)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(this.currentTheme.colors.surface)

      Divider().color(this.currentTheme.colors.border)

      // èœå•é¡¹
      Column() {
        if (this.fileItem.isDirectory) {
          this.buildMenuItem('ğŸ“„', 'æ–°å»ºæ–‡ä»¶', () => {
            this.onNewFile();
            this.controller.close();
          })
          
          this.buildMenuItem('ğŸ“', 'æ–°å»ºæ–‡ä»¶å¤¹', () => {
            this.onNewFolder();
            this.controller.close();
          })
          
          Divider().color(this.currentTheme.colors.border).margin({ left: 16, right: 16 })
        }

        this.buildMenuItem('âœï¸', 'é‡å‘½å', () => {
          this.onRename();
          this.controller.close();
        })

        this.buildMenuItem('ğŸ“‹', 'å¤åˆ¶', () => {
          this.onCopy();
          this.controller.close();
        })

        this.buildMenuItem('âœ‚ï¸', 'å‰ªåˆ‡', () => {
          this.onCut();
          this.controller.close();
        })

        if (this.fileItem.isDirectory) {
          this.buildMenuItem('ğŸ“Œ', 'ç²˜è´´', () => {
            this.onPaste();
            this.controller.close();
          })
        }

        Divider().color(this.currentTheme.colors.border).margin({ left: 16, right: 16 })

        this.buildMenuItem('ğŸ—‘ï¸', 'åˆ é™¤', () => {
          this.onDelete();
          this.controller.close();
        }, true)
      }
      .padding({ top: 4, bottom: 4 })
    }
    .width(220)
    .backgroundColor(this.currentTheme.colors.background)
    .borderRadius(12)
    .shadow({
      radius: 20,
      color: '#00000020',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  buildMenuItem(icon: string, text: string, onClick: () => void, isDanger: boolean = false): void {
    Row() {
      Text(icon)
        .fontSize(16)
        .width(24)
        .margin({ right: 12 })

      Text(text)
        .fontSize(13)
        .fontColor(isDanger ? '#FF3B30' : this.currentTheme.colors.text)
        .layoutWeight(1)
    }
    .width('100%')
    .height(40)
    .padding({ left: 16, right: 16 })
    .borderRadius(8)
    .backgroundColor(Color.Transparent)
    .onClick(onClick)
  }

  private getFileIcon(): string {
    if (this.fileItem.isDirectory) {
      return 'ğŸ“';
    }

    const ext = this.fileItem.type.toLowerCase();
    const iconMap: Record<string, string> = {
      'js': 'ğŸŸ¨',
      'ts': 'ğŸ”·',
      'ets': 'ğŸ”¶',
      'json': 'ğŸ“‹',
      'json5': 'ğŸ“‹',
      'md': 'ğŸ“',
      'html': 'ğŸŒ',
      'css': 'ğŸ¨',
      'py': 'ğŸ',
      'java': 'â˜•',
      'cpp': 'ğŸ“˜',
      'c': 'ğŸ“˜',
      'txt': 'ğŸ“„'
    };

    return iconMap[ext] || 'ğŸ“„';
  }
}
