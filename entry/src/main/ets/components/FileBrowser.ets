/**
 * æ–‡ä»¶æµè§ˆå™¨ç»„ä»¶
 * æ˜¾ç¤ºåº”ç”¨å†…æ–‡ä»¶åˆ—è¡¨
 */
import { FileManagerService, FileItem } from '../services/FileManagerService';
import { curves } from '@kit.ArkUI';

@Component
export struct FileBrowser {
  @Prop @Watch('onFilesChange') files: FileItem[] = [];
  @Prop currentFilePath: string = '';
  @Prop workspacePath: string = ''; // å·¥ä½œåŒºè·¯å¾„æ˜¾ç¤º
  @Prop bgColor: ResourceColor = '#1E1E1E';
  @Prop textColor: ResourceColor = '#FFFFFF';
  @Prop fileBorderColor: ResourceColor = '#333333';
  @Prop activeFileBgColor: ResourceColor = '#3E3E42'; // å½“å‰æ–‡ä»¶èƒŒæ™¯è‰²
  onFileClick?: (file: FileItem) => void;
  onNewFile?: () => void;
  onDeleteFile?: (file: FileItem) => void;
  
  @State private expandedDirs: Set<string> = new Set();
  private springCurve: ICurve = curves.springMotion(0.6, 0.8);

  onFilesChange() {
    // æ–‡ä»¶åˆ—è¡¨å˜åŒ–æ—¶çš„å¤„ç†
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Column() {
        Row() {
          Text('æ–‡ä»¶')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.textColor)
            .layoutWeight(1)
          
          // æ–°å»ºæ–‡ä»¶æŒ‰é’®
          Button({ type: ButtonType.Normal }) {
            Text('+')
              .fontSize(18)
              .fontColor(this.textColor)
          }
          .width(28)
          .height(28)
          .backgroundColor(Color.Transparent)
          .borderRadius(4)
          .stateEffect(true)
          .onClick(() => {
            if (this.onNewFile) {
              this.onNewFile();
            }
          })
        }
        .width('100%')
        .padding({ left: 12, right: 8, top: 8 })
        
        // å·¥ä½œåŒºè·¯å¾„
        if (this.workspacePath) {
          Text(this.workspacePath)
            .fontSize(11)
            .fontColor(this.textColor)
            .opacity(0.6)
            .width('100%')
            .padding({ left: 12, right: 12, bottom: 8 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }
      .width('100%')
      .backgroundColor(this.bgColor)
      .border({ width: { bottom: 1 }, color: this.fileBorderColor })

      // æ–‡ä»¶åˆ—è¡¨
      if (this.files.length === 0) {
        Column() {
          Text('æš‚æ— æ–‡ä»¶')
            .fontSize(12)
            .fontColor(this.textColor)
            .opacity(0.5)
        }
        .width('100%')
        .padding(16)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column() {
            ForEach(this.files, (file: FileItem) => {
              this.buildFileItem(file)
            }, (file: FileItem) => file.path)
          }
          .width('100%')
        }
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.bgColor)
  }

  @Builder
  buildFileItem(file: FileItem): void {
    Row({ space: 8 }) {
      // æ–‡ä»¶å›¾æ ‡
      Text(file.isDirectory ? 'ğŸ“' : this.getFileIcon(file.name))
        .fontSize(16)
      
      // æ–‡ä»¶å
      Text(file.name)
        .fontSize(13)
        .fontColor(this.textColor)
        .layoutWeight(1)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .height(36)
    .padding({ left: 12, right: 12 })
    .backgroundColor(file.path === this.currentFilePath ? 
      this.activeFileBgColor : Color.Transparent)
    .borderRadius(4)
    .onClick(() => {
      if (!file.isDirectory && this.onFileClick) {
        this.onFileClick(file);
      }
    })
    .gesture(
      LongPressGesture({ repeat: false, duration: 500 })
        .onAction(() => {
          if (this.onDeleteFile) {
            this.onDeleteFile(file);
          }
        })
    )
  }

  /**
   * æ ¹æ®æ–‡ä»¶æ‰©å±•åè·å–å›¾æ ‡
   */
  private getFileIcon(fileName: string): string {
    const ext = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();
    const iconMap: Record<string, string> = {
      'js': 'ğŸ“œ',
      'ts': 'ğŸ“˜',
      'ets': 'ğŸ“—',
      'py': 'ğŸ',
      'java': 'â˜•',
      'html': 'ğŸŒ',
      'css': 'ğŸ¨',
      'json': 'ğŸ“‹',
      'md': 'ğŸ“',
      'txt': 'ğŸ“„'
    };
    return iconMap[ext] || 'ğŸ“„';
  }
}
