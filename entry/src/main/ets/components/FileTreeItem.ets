import { FileItem } from '../models/FileModel';

@Component
export struct FileTreeItem {
  @Prop fileItem: FileItem;
  @Prop level: number = 0;
  @Prop isExpanded: boolean = false;
  @Prop isSelected: boolean = false;
  onFileClick?: (file: FileItem) => void;
  onFolderToggle?: (file: FileItem) => void;

  private getFileIcon(): string {
    if (this.fileItem.isDirectory) {
      return this.isExpanded ? 'ğŸ“‚' : 'ğŸ“';
    }

    const ext = this.fileItem.name.split('.').pop()?.toLowerCase() || '';
    const iconMap: Record<string, string> = {
      // ä»£ç æ–‡ä»¶
      'js': 'ğŸŸ¨', 'ts': 'ğŸ”·', 'ets': 'ğŸ”·', 'jsx': 'âš›ï¸', 'tsx': 'âš›ï¸',
      'py': 'ğŸ', 'java': 'â˜•', 'cpp': 'âš™ï¸', 'c': 'âš™ï¸', 'go': 'ğŸ¹',
      'rs': 'ğŸ¦€', 'php': 'ğŸ˜', 'rb': 'ğŸ’', 'swift': 'ğŸ¦…',
      // Web æ–‡ä»¶
      'html': 'ğŸŒ', 'css': 'ğŸ¨', 'scss': 'ğŸ¨', 'vue': 'ğŸ’š',
      // æ•°æ®æ–‡ä»¶
      'json': 'ğŸ“¦', 'xml': 'ğŸ“‹', 'yaml': 'ğŸ“‹', 'yml': 'ğŸ“‹',
      // æ–‡æ¡£æ–‡ä»¶
      'md': 'ğŸ“', 'txt': 'ğŸ“„', 'pdf': 'ğŸ“•',
      // å›¾ç‰‡æ–‡ä»¶
      'png': 'ğŸ–¼ï¸', 'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'svg': 'ğŸ¨'
    };
    return iconMap[ext] || 'ğŸ“„';
  }

  private getFileIconColor(): string {
    if (this.fileItem.isDirectory) {
      return this.isExpanded ? '#F59E0B' : '#6B7280';
    }
    
    const ext = this.fileItem.name.split('.').pop()?.toLowerCase() || '';
    const colorMap: Record<string, string> = {
      'js': '#F0DB4F', 'ts': '#3178C6', 'ets': '#3178C6',
      'py': '#3776AB', 'java': '#ED8B00', 'html': '#E34C26',
      'css': '#264DE4', 'json': '#292929', 'md': '#083FA1'
    };
    return colorMap[ext] || '#6B7280';
  }

  build() {
    Column() {
      // æ–‡ä»¶/æ–‡ä»¶å¤¹é¡¹
      Row() {
        // ç¼©è¿›
        if (this.level > 0) {
          Blank().width(this.level * 20)
        }

        // å±•å¼€/æŠ˜å ç®­å¤´ï¼ˆä»…æ–‡ä»¶å¤¹ï¼‰
        if (this.fileItem.isDirectory) {
          Text(this.isExpanded ? 'â–¼' : 'â–¶')
            .fontSize(10)
            .fontColor($r('app.color.text_tertiary'))
            .width(16)
            .textAlign(TextAlign.Center)
            .margin({ right: 6 })
            .onClick(() => {
              if (this.onFolderToggle) {
                this.onFolderToggle(this.fileItem);
              }
            })
        } else {
          Blank().width(22)
        }

        // æ–‡ä»¶å›¾æ ‡
        Text(this.getFileIcon())
          .fontSize(16)
          .margin({ right: 10 })

        // æ–‡ä»¶å
        Text(this.fileItem.name)
          .fontSize(14)
          .fontColor(this.isSelected ? $r('app.color.primary_brand') : $r('app.color.text_primary'))
          .fontWeight(this.isSelected ? FontWeight.Medium : FontWeight.Normal)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)

        // æ–‡ä»¶å¤§å°ï¼ˆä»…æ–‡ä»¶ï¼‰
        if (!this.fileItem.isDirectory && this.fileItem.size) {
          Text(this.formatSize(this.fileItem.size))
            .fontSize(11)
            .fontColor($r('app.color.text_tertiary'))
            .margin({ left: 8 })
        }
      }
      .width('100%')
      .height(36)
      .padding({ left: 12, right: 12 })
      .backgroundColor(this.isSelected ? $r('app.color.active_bg') : Color.Transparent)
      .borderRadius(6)
      .onClick(() => {
        if (this.fileItem.isDirectory) {
          if (this.onFolderToggle) {
            this.onFolderToggle(this.fileItem);
          }
        } else {
          if (this.onFileClick) {
            this.onFileClick(this.fileItem);
          }
        }
      })
      .stateStyles({
        normal: {
          .backgroundColor(this.isSelected ? $r('app.color.active_bg') : Color.Transparent)
        },
        pressed: {
          .backgroundColor($r('app.color.hover_bg'))
        }
      })

      // å­é¡¹ï¼ˆå¦‚æœæ˜¯å·²å±•å¼€çš„æ–‡ä»¶å¤¹ï¼‰
      if (this.fileItem.isDirectory && this.isExpanded && this.fileItem.children && this.fileItem.children.length > 0) {
        Column() {
          ForEach(this.fileItem.children, (child: FileItem) => {
            FileTreeItem({
              fileItem: child,
              level: this.level + 1,
              isExpanded: false,
              isSelected: false,
              onFileClick: this.onFileClick,
              onFolderToggle: this.onFolderToggle
            })
          }, (item: FileItem) => item.path)
        }
        .width('100%')
      }
    }
    .width('100%')
  }

  private formatSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
  }
}