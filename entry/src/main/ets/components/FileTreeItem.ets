/**
 * æ–‡ä»¶æ ‘é¡¹ç»„ä»¶
 * ç”¨äºæ˜¾ç¤ºæ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„æ ‘å½¢ç»“æ„ï¼Œæ”¯æŒå³é”®èœå•ã€æ‹–æ‹½ç­‰åŠŸèƒ½
 */
import { FileItem } from '../models/FileModel';
import { ThemeService, Theme } from '../services/ThemeService';
import { FileContextMenu } from './FileContextMenu';

@Component
export struct FileTreeItem {
  @Prop fileItem: FileItem = {
    name: '',
    path: '',
    type: '',
    size: 0,
    lastModified: 0,
    isDirectory: false
  };
  @Prop level: number = 0;
  @Prop isExpanded: boolean = false;
  @Prop isSelected: boolean = false;
  
  @State private currentTheme: Theme = ThemeService.getInstance().getCurrentTheme();
  @State private isHovered: boolean = false;
  
  onFileClick: (file: FileItem) => void = () => {};
  onFolderToggle: (folder: FileItem) => void = () => {};
  onRename: (file: FileItem) => void = () => {};
  onDelete: (file: FileItem) => void = () => {};
  onNewFile: (folder: FileItem) => void = () => {};
  onNewFolder: (folder: FileItem) => void = () => {};
  onCopy: (file: FileItem) => void = () => {};
  onCut: (file: FileItem) => void = () => {};
  onPaste: (folder: FileItem) => void = () => {};
  
  private themeService: ThemeService = ThemeService.getInstance();
  private contextMenuController: CustomDialogController = new CustomDialogController({
    builder: FileContextMenu({
      fileItem: this.fileItem,
      onNewFile: () => this.onNewFile(this.fileItem),
      onNewFolder: () => this.onNewFolder(this.fileItem),
      onRename: () => this.onRename(this.fileItem),
      onDelete: () => this.onDelete(this.fileItem),
      onCopy: () => this.onCopy(this.fileItem),
      onCut: () => this.onCut(this.fileItem),
      onPaste: () => this.onPaste(this.fileItem)
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: true
  });

  aboutToAppear() {
    this.themeService.onThemeChange((theme: Theme) => {
      this.currentTheme = theme;
    });
  }

  build() {
    Column() {
      // å½“å‰é¡¹
      Row() {
        // ç¼©è¿›
        Blank()
          .width(this.level * 16)

        // å±•å¼€/æŠ˜å å›¾æ ‡ï¼ˆä»…æ–‡ä»¶å¤¹ï¼‰
        if (this.fileItem.isDirectory) {
          Text('â–¶')
            .fontSize(10)
            .fontColor(this.isSelected ? this.currentTheme.colors.primary : this.currentTheme.colors.textSecondary)
            .width(16)
            .textAlign(TextAlign.Center)
            .margin({ right: 6 })
            .rotate({ angle: this.isExpanded ? 90 : 0 })
            .animation({
              duration: 200,
              curve: Curve.EaseInOut
            })
        } else {
          Blank().width(22)
        }

        // æ–‡ä»¶/æ–‡ä»¶å¤¹å›¾æ ‡
        Text(this.getFileIcon())
          .fontSize(16)
          .margin({ right: 8 })

        // æ–‡ä»¶å
        Text(this.fileItem.name)
          .fontSize(13)
          .fontColor(this.isSelected ? this.currentTheme.colors.primary : this.currentTheme.colors.text)
          .fontWeight(this.isSelected ? FontWeight.Medium : FontWeight.Normal)
          .layoutWeight(1)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // æ‚¬åœæ—¶æ˜¾ç¤ºæ“ä½œæŒ‰é’®
        if (this.isHovered) {
          Row({ space: 2 }) {
            // æ›´å¤šæ“ä½œæŒ‰é’®
            Text('â‹¯')
              .fontSize(16)
              .fontColor(this.currentTheme.colors.textSecondary)
              .width(24)
              .height(24)
              .textAlign(TextAlign.Center)
              .borderRadius(4)
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.showContextMenu();
              })
          }
          .transition({
            type: TransitionType.Insert,
            opacity: 0,
            translate: { x: 10 }
          })
          .animation({
            duration: 150,
            curve: Curve.EaseOut
          })
        }

        // æ–‡ä»¶å¤§å°ï¼ˆä»…æ–‡ä»¶ä¸”ä¸æ‚¬åœæ—¶æ˜¾ç¤ºï¼‰
        if (!this.fileItem.isDirectory && this.fileItem.size > 0 && !this.isHovered) {
          Text(this.formatFileSize(this.fileItem.size))
            .fontSize(11)
            .fontColor(this.currentTheme.colors.textSecondary)
            .margin({ left: 8 })
        }
      }
      .width('100%')
      .height(32)
      .padding({ left: 8, right: 8 })
      .backgroundColor(this.getBackgroundColor())
      .borderRadius(6)
      .margin({ left: 4, right: 4, top: 1, bottom: 1 })
      .onHover((isHover: boolean) => {
        this.isHovered = isHover;
      })
      .onClick(() => {
        if (this.fileItem.isDirectory) {
          this.onFolderToggle(this.fileItem);
        } else {
          this.onFileClick(this.fileItem);
        }
      })
      .gesture(
        // é•¿æŒ‰æ˜¾ç¤ºå³é”®èœå•
        LongPressGesture({ repeat: false })
          .onAction(() => {
            this.showContextMenu();
          })
      )

      // å­é¡¹ï¼ˆä»…å½“æ˜¯æ–‡ä»¶å¤¹ä¸”å±•å¼€æ—¶ï¼‰
      if (this.fileItem.isDirectory && this.isExpanded && this.fileItem.children && this.fileItem.children.length > 0) {
        Column() {
          ForEach(this.fileItem.children, (child: FileItem) => {
            FileTreeItem({
              fileItem: child,
              level: this.level + 1,
              isExpanded: false,
              isSelected: false,
              onFileClick: this.onFileClick,
              onFolderToggle: this.onFolderToggle
            })
          }, (child: FileItem) => child.path)
        }
        .width('100%')
        .transition({
          type: TransitionType.Insert,
          opacity: 0,
          translate: { x: -10, y: -10 },
          scale: { x: 0.95, y: 0.95 }
        })
        .transition({
          type: TransitionType.Delete,
          opacity: 0,
          translate: { x: -10, y: 0 }
        })
      }
    }
    .width('100%')
  }

  /**
   * è·å–èƒŒæ™¯é¢œè‰²
   */
  private getBackgroundColor(): ResourceColor {
    if (this.isSelected) {
      return this.currentTheme.colors.surface;
    } else if (this.isHovered) {
      return this.currentTheme.colors.surface;
    }
    return Color.Transparent;
  }

  /**
   * æ˜¾ç¤ºå³é”®èœå•
   */
  private showContextMenu(): void {
    this.contextMenuController.open();
  }

  /**
   * è·å–æ–‡ä»¶å›¾æ ‡
   */
  private getFileIcon(): string {
    if (this.fileItem.isDirectory) {
      return this.isExpanded ? 'ğŸ“‚' : 'ğŸ“';
    }

    const ext = this.fileItem.type.toLowerCase();
    const iconMap: Record<string, string> = {
      'js': 'ğŸŸ¨',
      'ts': 'ğŸ”·',
      'ets': 'ğŸ”¶',
      'json': 'ğŸ“‹',
      'json5': 'ğŸ“‹',
      'md': 'ğŸ“',
      'html': 'ğŸŒ',
      'css': 'ğŸ¨',
      'py': 'ğŸ',
      'java': 'â˜•',
      'cpp': 'ğŸ“˜',
      'c': 'ğŸ“˜',
      'h': 'ğŸ“‘',
      'txt': 'ğŸ“„',
      'xml': 'ğŸ“°',
      'yaml': 'âš™ï¸',
      'yml': 'âš™ï¸',
      'sh': 'ğŸ–¥ï¸',
      'bat': 'ğŸ–¥ï¸',
      'gitignore': 'ğŸ”§',
      'env': 'ğŸ”'
    };

    return iconMap[ext] || 'ğŸ“„';
  }

  /**
   * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
   */
  private formatFileSize(bytes: number): string {
    if (bytes < 1024) {
      return `${bytes} B`;
    } else if (bytes < 1024 * 1024) {
      return `${(bytes / 1024).toFixed(1)} KB`;
    } else {
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }
  }
}

