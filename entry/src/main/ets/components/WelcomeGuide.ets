/**
 * æ¬¢è¿Žå¼•å¯¼ç»„ä»¶
 * é¦–æ¬¡å¯åŠ¨æ—¶æ˜¾ç¤ºçš„å¼•å¯¼æ•™ç¨‹
 */
import { ThemeService, Theme } from '../services/ThemeService';
import { CommonConstants } from '../common/CommonConstants';

interface GuideStep {
  title: string;
  description: string;
  icon: string;
}

@Component
export struct WelcomeGuide {
  @Prop visible: boolean = false;
  onClose: () => void = () => {};
  
  @State currentStep: number = 0;
  @State private currentTheme: Theme = ThemeService.getInstance().getCurrentTheme();
  
  private themeService: ThemeService = ThemeService.getInstance();
  private steps: GuideStep[] = [
    {
      title: 'æ¬¢è¿Žä½¿ç”¨ xxCode',
      description: 'ä¸€æ¬¾çŽ°ä»£åŒ–çš„é¸¿è’™ä»£ç ç¼–è¾‘å™¨ï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•é«˜äº®å’Œæ™ºèƒ½ç¼–è¾‘ã€‚',
      icon: 'ðŸ‘‹'
    },
    {
      title: 'æ‰“å¼€æ–‡ä»¶',
      description: 'ç‚¹å‡»å³ä¸Šè§’çš„"æ‰“å¼€"æŒ‰é’®ï¼Œé€‰æ‹©æ‚¨æƒ³è¦ç¼–è¾‘çš„ä»£ç æ–‡ä»¶ã€‚æ”¯æŒ JSã€TSã€Pythonã€Java ç­‰å¤šç§è¯­è¨€ã€‚',
      icon: 'ðŸ“'
    },
    {
      title: 'è¯­æ³•é«˜äº®',
      description: 'ç¼–è¾‘å™¨ä¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»åž‹ï¼Œæä¾›è¯­æ³•é«˜äº®å’Œä»£ç ç€è‰²ï¼Œè®©ä»£ç æ›´æ˜“è¯»ã€‚',
      icon: 'ðŸŽ¨'
    },
    {
      title: 'å¤šä¸»é¢˜åˆ‡æ¢',
      description: 'ç‚¹å‡»å³ä¸Šè§’çš„ä¸»é¢˜æŒ‰é’®ï¼Œå¯ä»¥åˆ‡æ¢ä¸åŒçš„ä¸»é¢˜é£Žæ ¼ï¼ŒåŒ…æ‹¬æ·±è‰²ã€æµ…è‰²ã€Monokai å’Œ Draculaã€‚',
      icon: 'ðŸŒ™'
    },
    {
      title: 'å¼€å§‹ç¼–ç ',
      description: 'çŽ°åœ¨æ‚¨å¯ä»¥å¼€å§‹ç¼–å†™ä»£ç äº†ï¼ç¼–è¾‘å™¨æ”¯æŒè‡ªåŠ¨ä¿å­˜ã€æœç´¢æ›¿æ¢ç­‰å¼ºå¤§åŠŸèƒ½ã€‚',
      icon: 'ðŸš€'
    }
  ];

  aboutToAppear() {
    this.themeService.onThemeChange((theme: Theme) => {
      this.currentTheme = theme;
    });
  }

  build() {
    if (this.visible) {
      Stack() {
        // åŠé€æ˜ŽèƒŒæ™¯é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            // ç‚¹å‡»èƒŒæ™¯ä¸å…³é—­
          })

        // å¼•å¯¼å¡ç‰‡
        Column({ space: 24 }) {
          // è¿›åº¦æŒ‡ç¤ºå™¨
          Row({ space: 8 }) {
            ForEach(this.steps, (step: GuideStep, index: number) => {
              Circle()
                .width(8)
                .height(8)
                .fill(index === this.currentStep ? 
                  this.currentTheme.colors.primary : 
                  this.currentTheme.colors.border)
                .animation({
                  duration: 300,
                  curve: Curve.EaseOut
                })
            }, (step: GuideStep, index: number) => `${index}`)
          }
          .justifyContent(FlexAlign.Center)

          // å½“å‰æ­¥éª¤å†…å®¹
          Column({ space: 16 }) {
            Text(this.steps[this.currentStep].icon)
              .fontSize(48)

            Text(this.steps[this.currentStep].title)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTheme.colors.text)
              .textAlign(TextAlign.Center)

            Text(this.steps[this.currentStep].description)
              .fontSize(15)
              .fontColor(this.currentTheme.colors.textSecondary)
              .textAlign(TextAlign.Center)
              .lineHeight(24)
          }
          .width('100%')
          .padding({ left: 20, right: 20 })

          // æŒ‰é’®ç»„
          Row({ space: 12 }) {
            if (this.currentStep > 0) {
              Button('ä¸Šä¸€æ­¥')
                .fontSize(15)
                .backgroundColor(this.currentTheme.colors.surface)
                .fontColor(this.currentTheme.colors.text)
                .layoutWeight(1)
                .onClick(() => {
                  if (this.currentStep > 0) {
                    this.currentStep--;
                  }
                })
            }

            Button(this.currentStep === this.steps.length - 1 ? 'å¼€å§‹ä½¿ç”¨' : 'ä¸‹ä¸€æ­¥')
              .fontSize(15)
              .backgroundColor(this.currentTheme.colors.primary)
              .fontColor(Color.White)
              .layoutWeight(1)
              .onClick(() => {
                if (this.currentStep < this.steps.length - 1) {
                  this.currentStep++;
                } else {
                  this.onClose();
                }
              })
          }
          .width('100%')
        }
        .width('90%')
        .constraintSize({ maxWidth: 480 })
        .padding(28)
        .backgroundColor(this.currentTheme.colors.background)
        .borderRadius(20)
        .shadow({
          radius: 40,
          color: 'rgba(0, 0, 0, 0.2)',
          offsetX: 0,
          offsetY: 15
        })
        .scale({ 
          x: this.visible ? 1 : 0.9, 
          y: this.visible ? 1 : 0.9 
        })
        .opacity(this.visible ? 1 : 0)
        .animation({
          duration: 400,
          curve: Curve.Friction,
          delay: 100
        })
      }
      .width('100%')
      .height('100%')
    }
  }
}

