/**
 * æ–‡ä»¶ä¾§è¾¹æ ç»„ä»¶
 * åŒ…å«æ–‡ä»¶æ ‘æµè§ˆã€æœç´¢ç­‰åŠŸèƒ½
 */
import { FileNode, ThemeColors } from '../../models/EditorModels'
import { FileTreeNode } from './FileTreeNode'
import { curves } from '@kit.ArkUI'

@Component
export struct FileSidebar {
  @Link expandedFolders: Set<string>
  @Prop rootFolder: FileNode | null = null
  @Prop selectedFileId: string = ''
  @Prop colors: ThemeColors
  @Prop isDarkMode: boolean = true

  onFileSelect: (file: FileNode) => void = () => {}
  onFolderToggle: (folder: FileNode) => void = () => {}
  onRefresh: () => void = () => {}

  // çŠ¶æ€
  @State searchText: string = ''
  @State isSearchFocused: boolean = false
  @State headerHover: boolean = false

  private scroller: Scroller = new Scroller()

  build() {
    Column() {
      // ä¾§è¾¹æ å¤´éƒ¨
      this.SidebarHeader()

      // æœç´¢æ¡†
      this.SearchBar()

      // æ–‡ä»¶æ ‘
      if (this.rootFolder) {
        Scroll(this.scroller) {
          Column() {
            this.buildFileTree(this.rootFolder, 0)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .padding({ top: 4, bottom: 16 })
        }
        .layoutWeight(1)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .scrollBarColor(this.colors.textDisabled)
        .scrollBarWidth(4)
        .edgeEffect(EdgeEffect.Spring)
        .friction(0.75)
      } else {
        // ç©ºçŠ¶æ€
        this.EmptyState()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.colors.sidebarBg)
    .border({
      width: { right: 1 },
      color: this.colors.divider
    })
  }

  @Builder
  SidebarHeader() {
    Column() {
      Row() {
        // æ ‡é¢˜
        Row({ space: 8 }) {
          Text('ğŸ“')
            .fontSize(16)
          Column() {
            Text('èµ„æºç®¡ç†å™¨')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.colors.textPrimary)
            
            // æ–‡ä»¶ç»Ÿè®¡
            Text(this.getFileCount())
              .fontSize(10)
              .fontColor(this.colors.textDisabled)
              .margin({ top: 2 })
          }
          .alignItems(HorizontalAlign.Start)
        }

        Blank()

        // æ“ä½œæŒ‰é’®
        Row({ space: 2 }) {
          this.HeaderIconButton('â•', 'æ–°å»ºæ–‡ä»¶')
          this.HeaderIconButton('ğŸ“', 'æ–°å»ºæ–‡ä»¶å¤¹')
          this.HeaderIconButton('ğŸ“¤', 'å±•å¼€å…¨éƒ¨', () => this.expandAll())
          this.HeaderIconButton('ğŸ“¥', 'æŠ˜å å…¨éƒ¨', () => this.collapseAll())
          this.HeaderIconButton('ğŸ”„', 'åˆ·æ–°', () => this.onRefresh())
        }
        .opacity(this.headerHover ? 1 : 0.6)
        .animation({
          duration: 150,
          curve: Curve.EaseOut
        })
      }
      .width('100%')
      .height(44)
      .padding({ left: 12, right: 8 })
      .onHover((isHover: boolean) => {
        this.headerHover = isHover
      })
    }
  }

  private getFileCount(): string {
    if (!this.rootFolder) return '0 é¡¹'
    const count = this.countFiles(this.rootFolder)
    return `${count} ä¸ªæ–‡ä»¶`
  }

  private countFiles(node: FileNode): number {
    if (node.type === 'file') return 1
    let count = 0
    if (node.children) {
      node.children.forEach(child => {
        count += this.countFiles(child)
      })
    }
    return count
  }

  private expandAll(): void {
    if (!this.rootFolder) return
    const allFolders = this.getAllFolderIds(this.rootFolder)
    this.expandedFolders = new Set(allFolders)
  }

  private collapseAll(): void {
    this.expandedFolders = new Set(['root'])
  }

  private getAllFolderIds(node: FileNode): string[] {
    const ids: string[] = []
    if (node.type === 'folder') {
      ids.push(node.id)
      if (node.children) {
        node.children.forEach(child => {
          ids.push(...this.getAllFolderIds(child))
        })
      }
    }
    return ids
  }

  @Builder
  HeaderIconButton(icon: string, tooltip: string, onClick?: () => void) {
    Text(icon)
      .fontSize(14)
      .width(28)
      .height(28)
      .textAlign(TextAlign.Center)
      .borderRadius(6)
      .backgroundColor(Color.Transparent)
      .onClick(() => onClick?.())
  }

  @Builder
  SearchBar() {
    Row() {
      Text('ğŸ”')
        .fontSize(14)
        .fontColor(this.colors.textSecondary)
        .margin({ right: 8 })

      TextInput({ placeholder: 'æœç´¢æ–‡ä»¶...', text: this.searchText })
        .placeholderColor(this.colors.textDisabled)
        .placeholderFont({ size: 13 })
        .fontSize(13)
        .fontColor(this.colors.textPrimary)
        .caretColor(this.colors.primary)
        .backgroundColor(Color.Transparent)
        .layoutWeight(1)
        .height(32)
        .padding(0)
        .onChange((value: string) => {
          this.searchText = value
        })
        .onFocus(() => {
          this.isSearchFocused = true
        })
        .onBlur(() => {
          this.isSearchFocused = false
        })

      if (this.searchText.length > 0) {
        Text('âœ•')
          .fontSize(12)
          .fontColor(this.colors.textSecondary)
          .width(20)
          .height(20)
          .textAlign(TextAlign.Center)
          .borderRadius(10)
          .backgroundColor(this.colors.hover)
          .onClick(() => {
            this.searchText = ''
          })
      }
    }
    .width('100%')
    .height(36)
    .padding({ left: 10, right: 10 })
    .margin({ left: 8, right: 8, top: 4, bottom: 8 })
    .borderRadius(10)
    .backgroundColor(this.colors.surfaceVariant)
    .border({
      width: 1,
      color: this.isSearchFocused ? this.colors.primary : Color.Transparent
    })
    .animation({
      duration: 200,
      curve: Curve.EaseOut
    })
  }

  @Builder
  EmptyState() {
    Column({ space: 12 }) {
      Text('ğŸ“‚')
        .fontSize(48)
        .opacity(0.5)

      Text('æš‚æ— æ‰“å¼€çš„é¡¹ç›®')
        .fontSize(14)
        .fontColor(this.colors.textSecondary)

      Button('æ‰“å¼€æ–‡ä»¶å¤¹')
        .type(ButtonType.Capsule)
        .fontSize(13)
        .fontColor(Color.White)
        .backgroundColor(this.colors.primary)
        .height(36)
        .padding({ left: 20, right: 20 })
        .margin({ top: 8 })
    }
    .layoutWeight(1)
    .width('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildFileTree(node: FileNode, level: number) {
    // å½“å‰èŠ‚ç‚¹
    FileTreeNode({
      node: node,
      level: level,
      isExpanded: this.expandedFolders.has(node.id),
      isSelected: node.id === this.selectedFileId,
      colors: this.colors,
      onSelect: (file: FileNode) => this.onFileSelect(file),
      onToggle: (folder: FileNode) => this.onFolderToggle(folder)
    })

    // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
    if (node.type === 'folder' && node.children && this.expandedFolders.has(node.id)) {
      ForEach(node.children, (child: FileNode) => {
        this.buildFileTree(child, level + 1)
      })
    }
  }
}
